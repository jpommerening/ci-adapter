'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Jenkins;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var JENKINS_MEDIA_TYPE = 'application/json';
var JENKINS_STATE_MAP = {
  SUCCESS: _constants.SUCCESS,
  UNSTABLE: _constants.WARNING,
  FAILURE: _constants.FAILURE
};

function Jenkins(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var view = _ref.view;

  var headers = Object.assign({
    'Accept': JENKINS_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/api/json', options).then(handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({ name: name });

      return (0, _fetch2.default)(url, options);
    }).then(handleResponse).then(makeBuilder);
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var url = endpoint + '/api/json?tree=jobs[name,buildable,builds[number]{,10}],views[name,jobs[name]]';

      return (0, _fetch2.default)(url, options);
    }).then(handleResponse).then(function (data) {
      var filter = view ? function (v) {
        return v.name === view;
      } : function () {
        return true;
      };
      var jobs = data.views.filter(filter)[0].jobs.map(function (job) {
        return job.name;
      });
      return data.jobs.filter(function (job) {
        return jobs.indexOf(job.name) >= 0 && job.buildable;
      }).map(makeBuilder);
    });
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(handleResponse).then(function (data) {
        return makeBuild(builder.data, data);
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(handleResponse).then(function (data) {
        return makeBuild(builder.data, data);
      });
    }));
  }

  function handleResponse(response) {
    if (response.status === 200) return response.json();
    return response.text().then(function (text) {
      return Promise.reject(new Error(response.status + ' ' + response.statusText + ': ' + text));
    });
  }

  function makeInfo(root) {
    var name = root.nodeName;
    var builders = root.jobs.map(function (job) {
      return job.name;
    });
    var data = root;

    return {
      name: name,
      url: endpoint + '/api/json',
      html_url: endpoint,
      builders_url: endpoint + '/job{/name}/api/json{?tree}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(job) {
    var name = job.name;
    var builds = job.builds.map(function (build) {
      return build.number;
    });
    var data = job;

    return {
      data: data,
      name: name,
      url: endpoint + '/job/' + name + '/api/json',
      html_url: endpoint + '/job/' + name,
      builds_url: endpoint + '/job/' + name + '/{number}/api/json{?tree}',
      builds: builds
    };
  }

  function makeBuild(job, build) {
    var name = job.name;
    var number = build.number;
    var building = build.building;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/job/' + name + '/' + number + '/api/json',
      html_url: endpoint + '/job/' + name + '/' + number,
      state: building ? _constants.PENDING : JENKINS_STATE_MAP[build.result] || _constants.UNKNOWN,
      start: new Date(build.timestamp),
      end: building ? null : new Date(build.timestamp + build.duration),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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QU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO0FBQzVCLFFBQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7QUFDaEMsUUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDOztBQUVuQixXQUFPO0FBQ0wsVUFBSSxFQUFKLElBQUk7QUFDSixZQUFNLEVBQU4sTUFBTTtBQUNOLFNBQUcsRUFBSyxRQUFRLGFBQVEsSUFBSSxTQUFJLE1BQU0sY0FBVztBQUNqRCxjQUFRLEVBQUssUUFBUSxhQUFRLElBQUksU0FBSSxNQUFNLEFBQUU7QUFDN0MsV0FBSyxFQUFFLFFBQVEsY0E1SFosT0FBTyxHQTRIb0IsaUJBQWlCLENBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBRSxlQTVIeEIsT0FBTyxBQTRINEIsQUFBRTtBQUM1RSxXQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztBQUNoQyxTQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7QUFDakUsVUFBSSxFQUFKLElBQUk7S0FDTCxDQUFDO0dBQ0g7O0FBRUQsU0FBTztBQUNMLFdBQU8sRUFBUCxPQUFPO0FBQ1AsY0FBVSxFQUFWLFVBQVU7QUFDVixlQUFXLEVBQVgsV0FBVztBQUNYLFlBQVEsRUFBUixRQUFRO0FBQ1IsYUFBUyxFQUFULFNBQVM7R0FDVixDQUFDO0NBQ0giLCJmaWxlIjoiamVua2lucy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmZXRjaCBmcm9tICcuL2ZldGNoJztcbmltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgRkFJTFVSRSwgV0FSTklORywgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgSkVOS0lOU19NRURJQV9UWVBFID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuY29uc3QgSkVOS0lOU19TVEFURV9NQVAgPSB7XG4gIFNVQ0NFU1M6IFNVQ0NFU1MsXG4gIFVOU1RBQkxFOiBXQVJOSU5HLFxuICBGQUlMVVJFOiBGQUlMVVJFXG59O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBKZW5raW5zKGVuZHBvaW50LCB7IGhlYWRlcnM6IGgsIHZpZXcgfSA9IHt9KSB7XG4gIGNvbnN0IGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAnQWNjZXB0JzogSkVOS0lOU19NRURJQV9UWVBFLFxuICAgICdVc2VyLUFnZW50JzogVVNFUl9BR0VOVFxuICB9LCBoKTtcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBoZWFkZXJzXG4gIH07XG5cbiAgZnVuY3Rpb24gZ2V0SW5mbygpIHtcbiAgICByZXR1cm4gZmV0Y2goYCR7ZW5kcG9pbnR9L2FwaS9qc29uYCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihuYW1lKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggaW5mby5idWlsZGVyc191cmwgKTtcbiAgICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbmFtZSB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKG1ha2VCdWlsZGVyKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKCkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke2VuZHBvaW50fS9hcGkvanNvbj90cmVlPWpvYnNbbmFtZSxidWlsZGFibGUsYnVpbGRzW251bWJlcl17LDEwfV0sdmlld3NbbmFtZSxqb2JzW25hbWVdXWA7XG5cbiAgICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucyk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICBjb25zdCBmaWx0ZXIgPSB2aWV3ID8gKHYgPT4gdi5uYW1lID09PSB2aWV3KSA6ICgoKSA9PiB0cnVlKTtcbiAgICAgICAgY29uc3Qgam9icyA9IGRhdGEudmlld3MuZmlsdGVyKGZpbHRlcilbIDAgXS5qb2JzLm1hcChqb2IgPT4gam9iLm5hbWUpO1xuICAgICAgICByZXR1cm4gZGF0YS5qb2JzLmZpbHRlcihmdW5jdGlvbiAoam9iKSB7XG4gICAgICAgICAgcmV0dXJuIGpvYnMuaW5kZXhPZiggam9iLm5hbWUgKSA+PSAwICYmIGpvYi5idWlsZGFibGU7XG4gICAgICAgIH0pLm1hcChtYWtlQnVpbGRlcik7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkKG5hbWUsIG51bWJlcikge1xuICAgIHJldHVybiBnZXRCdWlsZGVyKG5hbWUpXG4gICAgICAudGhlbihmdW5jdGlvbiAoYnVpbGRlcikge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKCBidWlsZGVyLmJ1aWxkc191cmwgKTtcbiAgICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAgICAgLnRoZW4oZGF0YSA9PiBtYWtlQnVpbGQoYnVpbGRlci5kYXRhLCBkYXRhKSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkcyhidWlsZGVyKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKGJ1aWxkZXIuYnVpbGRzLm1hcChmdW5jdGlvbiAobnVtYmVyKSB7XG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKCBidWlsZGVyLmJ1aWxkc191cmwgKTtcbiAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG51bWJlciB9KTtcblxuICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAgIC50aGVuKGRhdGEgPT4gbWFrZUJ1aWxkKGJ1aWxkZXIuZGF0YSwgZGF0YSkpO1xuICAgIH0pKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGhhbmRsZVJlc3BvbnNlKHJlc3BvbnNlKSB7XG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICByZXR1cm4gcmVzcG9uc2UudGV4dCgpXG4gICAgICAudGhlbih0ZXh0ID0+IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihgJHtyZXNwb25zZS5zdGF0dXN9ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH06ICR7dGV4dH1gKSkpO1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUluZm8ocm9vdCkge1xuICAgIGNvbnN0IG5hbWUgPSByb290Lm5vZGVOYW1lO1xuICAgIGNvbnN0IGJ1aWxkZXJzID0gcm9vdC5qb2JzLm1hcChqb2IgPT4gam9iLm5hbWUpO1xuICAgIGNvbnN0IGRhdGEgPSByb290O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9hcGkvanNvbmAsXG4gICAgICBodG1sX3VybDogZW5kcG9pbnQsXG4gICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9qb2J7L25hbWV9L2FwaS9qc29uez90cmVlfWAsXG4gICAgICBidWlsZGVycyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkZXIoam9iKSB7XG4gICAgY29uc3QgbmFtZSA9IGpvYi5uYW1lO1xuICAgIGNvbnN0IGJ1aWxkcyA9IGpvYi5idWlsZHMubWFwKGJ1aWxkID0+IGJ1aWxkLm51bWJlcik7XG4gICAgY29uc3QgZGF0YSA9IGpvYjtcblxuICAgIHJldHVybiB7XG4gICAgICBkYXRhLFxuICAgICAgbmFtZSxcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pvYi8ke25hbWV9L2FwaS9qc29uYCxcbiAgICAgIGh0bWxfdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7bmFtZX1gLFxuICAgICAgYnVpbGRzX3VybDogYCR7ZW5kcG9pbnR9L2pvYi8ke25hbWV9L3tudW1iZXJ9L2FwaS9qc29uez90cmVlfWAsXG4gICAgICBidWlsZHNcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkKGpvYiwgYnVpbGQpIHtcbiAgICBjb25zdCBuYW1lID0gam9iLm5hbWU7XG4gICAgY29uc3QgbnVtYmVyID0gYnVpbGQubnVtYmVyO1xuICAgIGNvbnN0IGJ1aWxkaW5nID0gYnVpbGQuYnVpbGRpbmc7XG4gICAgY29uc3QgZGF0YSA9IGJ1aWxkO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBudW1iZXIsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9qb2IvJHtuYW1lfS8ke251bWJlcn0vYXBpL2pzb25gLFxuICAgICAgaHRtbF91cmw6IGAke2VuZHBvaW50fS9qb2IvJHtuYW1lfS8ke251bWJlcn1gLFxuICAgICAgc3RhdGU6IGJ1aWxkaW5nID8gUEVORElORyA6ICggSkVOS0lOU19TVEFURV9NQVBbIGJ1aWxkLnJlc3VsdCBdIHx8IFVOS05PV04gKSxcbiAgICAgIHN0YXJ0OiBuZXcgRGF0ZShidWlsZC50aW1lc3RhbXApLFxuICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC50aW1lc3RhbXAgKyBidWlsZC5kdXJhdGlvbiksXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2V0SW5mbyxcbiAgICBnZXRCdWlsZGVyLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkLFxuICAgIGdldEJ1aWxkc1xuICB9O1xufVxuIl19