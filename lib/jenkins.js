'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Jenkins;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _util = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var JENKINS_MEDIA_TYPE = 'application/json';
var JENKINS_STATE_MAP = {
  SUCCESS: _constants.SUCCESS,
  UNSTABLE: _constants.WARNING,
  FAILURE: _constants.FAILURE
};

function Jenkins(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var view = _ref.view;

  var headers = Object.assign({
    'Accept': JENKINS_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/api/json', options).then(_util.handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({ name: name });

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(makeBuilder);
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var url = endpoint + '/api/json?tree=jobs[name,buildable,builds[number]{,10}],views[name,jobs[name]]';

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(function (data) {
      var filter = view ? function (v) {
        return v.name === view;
      } : function () {
        return true;
      };
      var jobs = data.views.filter(filter)[0].jobs.map(function (job) {
        return job.name;
      });
      return data.jobs.filter(function (job) {
        return jobs.indexOf(job.name) >= 0 && job.buildable;
      }).map(makeBuilder);
    });
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(function (data) {
        return makeBuild(builder.data, data);
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(function (data) {
        return makeBuild(builder.data, data);
      });
    }));
  }

  function makeInfo(root) {
    var name = root.nodeName;
    var builders = root.jobs.map(function (job) {
      return job.name;
    });
    var data = root;

    return {
      name: name,
      url: endpoint + '/api/json',
      html_url: endpoint,
      builders_url: endpoint + '/job{/name}/api/json{?tree}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(job) {
    var name = job.name;
    var builds = job.builds.map(function (build) {
      return build.number;
    });
    var data = job;

    return {
      data: data,
      name: name,
      url: endpoint + '/job/' + name + '/api/json',
      html_url: endpoint + '/job/' + name,
      builds_url: endpoint + '/job/' + name + '/{number}/api/json{?tree}',
      builds: builds
    };
  }

  function makeBuild(job, build) {
    var name = job.name;
    var number = build.number;
    var building = build.building;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/job/' + name + '/' + number + '/api/json',
      html_url: endpoint + '/job/' + name + '/' + number,
      state: building ? _constants.PENDING : JENKINS_STATE_MAP[build.result] || _constants.UNKNOWN,
      start: new Date(build.timestamp),
      end: building ? null : new Date(build.timestamp + build.duration),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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Y0FySFosT0FBTyxHQXFIb0IsaUJBQWlCLENBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBRSxlQXJIeEIsT0FBTyxBQXFINEIsQUFBRTtBQUM1RSxXQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztBQUNoQyxTQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7QUFDakUsVUFBSSxFQUFKLElBQUk7S0FDTCxDQUFDO0dBQ0g7O0FBRUQsU0FBTztBQUNMLFdBQU8sRUFBUCxPQUFPO0FBQ1AsY0FBVSxFQUFWLFVBQVU7QUFDVixlQUFXLEVBQVgsV0FBVztBQUNYLFlBQVEsRUFBUixRQUFRO0FBQ1IsYUFBUyxFQUFULFNBQVM7R0FDVixDQUFDO0NBQ0giLCJmaWxlIjoiamVua2lucy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmZXRjaCBmcm9tICcuL2ZldGNoJztcbmltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IHsgaGFuZGxlUmVzcG9uc2UgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgRkFJTFVSRSwgV0FSTklORywgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgSkVOS0lOU19NRURJQV9UWVBFID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuY29uc3QgSkVOS0lOU19TVEFURV9NQVAgPSB7XG4gIFNVQ0NFU1M6IFNVQ0NFU1MsXG4gIFVOU1RBQkxFOiBXQVJOSU5HLFxuICBGQUlMVVJFOiBGQUlMVVJFXG59O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBKZW5raW5zKGVuZHBvaW50LCB7IGhlYWRlcnM6IGgsIHZpZXcgfSA9IHt9KSB7XG4gIGNvbnN0IGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAnQWNjZXB0JzogSkVOS0lOU19NRURJQV9UWVBFLFxuICAgICdVc2VyLUFnZW50JzogVVNFUl9BR0VOVFxuICB9LCBoKTtcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBoZWFkZXJzXG4gIH07XG5cbiAgZnVuY3Rpb24gZ2V0SW5mbygpIHtcbiAgICByZXR1cm4gZmV0Y2goYCR7ZW5kcG9pbnR9L2FwaS9qc29uYCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihuYW1lKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggaW5mby5idWlsZGVyc191cmwgKTtcbiAgICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbmFtZSB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKG1ha2VCdWlsZGVyKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKCkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke2VuZHBvaW50fS9hcGkvanNvbj90cmVlPWpvYnNbbmFtZSxidWlsZGFibGUsYnVpbGRzW251bWJlcl17LDEwfV0sdmlld3NbbmFtZSxqb2JzW25hbWVdXWA7XG5cbiAgICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucyk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICBjb25zdCBmaWx0ZXIgPSB2aWV3ID8gKHYgPT4gdi5uYW1lID09PSB2aWV3KSA6ICgoKSA9PiB0cnVlKTtcbiAgICAgICAgY29uc3Qgam9icyA9IGRhdGEudmlld3MuZmlsdGVyKGZpbHRlcilbIDAgXS5qb2JzLm1hcChqb2IgPT4gam9iLm5hbWUpO1xuICAgICAgICByZXR1cm4gZGF0YS5qb2JzLmZpbHRlcihmdW5jdGlvbiAoam9iKSB7XG4gICAgICAgICAgcmV0dXJuIGpvYnMuaW5kZXhPZiggam9iLm5hbWUgKSA+PSAwICYmIGpvYi5idWlsZGFibGU7XG4gICAgICAgIH0pLm1hcChtYWtlQnVpbGRlcik7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkKG5hbWUsIG51bWJlcikge1xuICAgIHJldHVybiBnZXRCdWlsZGVyKG5hbWUpXG4gICAgICAudGhlbihmdW5jdGlvbiAoYnVpbGRlcikge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKCBidWlsZGVyLmJ1aWxkc191cmwgKTtcbiAgICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAgICAgLnRoZW4oZGF0YSA9PiBtYWtlQnVpbGQoYnVpbGRlci5kYXRhLCBkYXRhKSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkcyhidWlsZGVyKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKGJ1aWxkZXIuYnVpbGRzLm1hcChmdW5jdGlvbiAobnVtYmVyKSB7XG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKCBidWlsZGVyLmJ1aWxkc191cmwgKTtcbiAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG51bWJlciB9KTtcblxuICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAgIC50aGVuKGRhdGEgPT4gbWFrZUJ1aWxkKGJ1aWxkZXIuZGF0YSwgZGF0YSkpO1xuICAgIH0pKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VJbmZvKHJvb3QpIHtcbiAgICBjb25zdCBuYW1lID0gcm9vdC5ub2RlTmFtZTtcbiAgICBjb25zdCBidWlsZGVycyA9IHJvb3Quam9icy5tYXAoam9iID0+IGpvYi5uYW1lKTtcbiAgICBjb25zdCBkYXRhID0gcm9vdDtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vYXBpL2pzb25gLFxuICAgICAgaHRtbF91cmw6IGVuZHBvaW50LFxuICAgICAgYnVpbGRlcnNfdXJsOiBgJHtlbmRwb2ludH0vam9iey9uYW1lfS9hcGkvanNvbns/dHJlZX1gLFxuICAgICAgYnVpbGRlcnMsXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VCdWlsZGVyKGpvYikge1xuICAgIGNvbnN0IG5hbWUgPSBqb2IubmFtZTtcbiAgICBjb25zdCBidWlsZHMgPSBqb2IuYnVpbGRzLm1hcChidWlsZCA9PiBidWlsZC5udW1iZXIpO1xuICAgIGNvbnN0IGRhdGEgPSBqb2I7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZGF0YSxcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9qb2IvJHtuYW1lfS9hcGkvanNvbmAsXG4gICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2pvYi8ke25hbWV9YCxcbiAgICAgIGJ1aWxkc191cmw6IGAke2VuZHBvaW50fS9qb2IvJHtuYW1lfS97bnVtYmVyfS9hcGkvanNvbns/dHJlZX1gLFxuICAgICAgYnVpbGRzXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VCdWlsZChqb2IsIGJ1aWxkKSB7XG4gICAgY29uc3QgbmFtZSA9IGpvYi5uYW1lO1xuICAgIGNvbnN0IG51bWJlciA9IGJ1aWxkLm51bWJlcjtcbiAgICBjb25zdCBidWlsZGluZyA9IGJ1aWxkLmJ1aWxkaW5nO1xuICAgIGNvbnN0IGRhdGEgPSBidWlsZDtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgbnVtYmVyLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7bmFtZX0vJHtudW1iZXJ9L2FwaS9qc29uYCxcbiAgICAgIGh0bWxfdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7bmFtZX0vJHtudW1iZXJ9YCxcbiAgICAgIHN0YXRlOiBidWlsZGluZyA/IFBFTkRJTkcgOiAoIEpFTktJTlNfU1RBVEVfTUFQWyBidWlsZC5yZXN1bHQgXSB8fCBVTktOT1dOICksXG4gICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQudGltZXN0YW1wKSxcbiAgICAgIGVuZDogYnVpbGRpbmcgPyBudWxsIDogbmV3IERhdGUoYnVpbGQudGltZXN0YW1wICsgYnVpbGQuZHVyYXRpb24pLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGdldEluZm8sXG4gICAgZ2V0QnVpbGRlcixcbiAgICBnZXRCdWlsZGVycyxcbiAgICBnZXRCdWlsZCxcbiAgICBnZXRCdWlsZHNcbiAgfTtcbn1cbiJdfQ==