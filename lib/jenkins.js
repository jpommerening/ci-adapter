'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Jenkins;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _adapter = require('./adapter');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var JENKINS_MEDIA_TYPE = 'application/json';
var JENKINS_STATE_MAP = {
  SUCCESS: _adapter.SUCCESS,
  UNSTABLE: _adapter.WARNING,
  FAILURE: _adapter.FAILURE
};

function Jenkins(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;

  var headers = Object.assign({
    Accept: JENKINS_MEDIA_TYPE
  }, h);
  var options = {
    headers: headers
  };

  options.headers = Object.assign({}, options.headers, headers);

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/api/json', options).then(function (response) {
      return response.json();
    }).then(function (root) {
      return {
        name: root.nodeName,
        url: endpoint + '/api/json',
        html_url: endpoint,
        builders_url: endpoint + '/job{/name}/api/json{?tree}',
        builders: root.jobs.map(function (job) {
          return job.name;
        }),
        data: root
      };
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var url = endpoint + '/api/json?tree=jobs[name,builds[number]{,10}],views[name,jobs[name]]';

      return (0, _fetch2.default)(url, options);
    }).then(function (response) {
      return response.json();
    }).then(function (data) {
      return data.jobs.map(function (job) {
        var name = job.name;

        return {
          name: name,
          url: endpoint + '/job/' + name + '/api/json',
          html_url: endpoint + '/job/' + name,
          builds_url: endpoint + '/job/' + name + '/{number}/api/json{?tree}',
          builds: job.builds.map(function (build) {
            return build.number;
          }),
          data: data
        };
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(function (response) {
        return response.json();
      });
    })).then(function (builds) {
      return builds.map(function (build) {
        var building = build.building;

        return {
          name: builder.name,
          number: build.number,
          url: endpoint + '/job/' + builder.name + '/' + build.number + '/api/json',
          html_url: endpoint + '/job/' + builder.name + '/' + build.number,
          state: building ? PENDING : JENKINS_STATE_MAP[build.result] || _adapter.UNKNOWN,
          start: new Date(build.timestamp),
          end: building ? null : new Date(build.timestamp + build.duration),
          data: build
        };
      });
    });
  }

  return {
    getInfo: getInfo,
    getBuilders: getBuilders,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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VCxTQUFTO0dBQ1YsQ0FBQztDQUNIIiwiZmlsZSI6ImplbmtpbnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnLi9mZXRjaCc7XG5pbXBvcnQgdXJsdGVtcGxhdGUgZnJvbSAndXJsLXRlbXBsYXRlJztcbmltcG9ydCB7IFNVQ0NFU1MsIEZBSUxVUkUsIFdBUk5JTkcsIFVOS05PV04gfSBmcm9tICcuL2FkYXB0ZXInO1xuXG5jb25zdCBKRU5LSU5TX01FRElBX1RZUEUgPSAnYXBwbGljYXRpb24vanNvbic7XG5jb25zdCBKRU5LSU5TX1NUQVRFX01BUCA9IHtcbiAgU1VDQ0VTUzogU1VDQ0VTUyxcbiAgVU5TVEFCTEU6IFdBUk5JTkcsXG4gIEZBSUxVUkU6IEZBSUxVUkVcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEplbmtpbnMoZW5kcG9pbnQsIHsgaGVhZGVyczogaCB9ID0ge30pIHtcbiAgY29uc3QgaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oIHtcbiAgICBBY2NlcHQ6IEpFTktJTlNfTUVESUFfVFlQRVxuICB9LCBoICk7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgaGVhZGVyc1xuICB9O1xuXG4gIG9wdGlvbnMuaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBvcHRpb25zLmhlYWRlcnMsIGhlYWRlcnMgKTtcblxuICBmdW5jdGlvbiBnZXRJbmZvKCkge1xuICAgIHJldHVybiBmZXRjaChgJHtlbmRwb2ludH0vYXBpL2pzb25gLCBvcHRpb25zKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICB9KS50aGVuKGZ1bmN0aW9uIChyb290KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogcm9vdC5ub2RlTmFtZSxcbiAgICAgICAgICB1cmw6IGAke2VuZHBvaW50fS9hcGkvanNvbmAsXG4gICAgICAgICAgaHRtbF91cmw6IGVuZHBvaW50LFxuICAgICAgICAgIGJ1aWxkZXJzX3VybDogYCR7ZW5kcG9pbnR9L2pvYnsvbmFtZX0vYXBpL2pzb257P3RyZWV9YCxcbiAgICAgICAgICBidWlsZGVyczogcm9vdC5qb2JzLm1hcChqb2IgPT4gam9iLm5hbWUpLFxuICAgICAgICAgIGRhdGE6IHJvb3RcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcnMoKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7ZW5kcG9pbnR9L2FwaS9qc29uP3RyZWU9am9ic1tuYW1lLGJ1aWxkc1tudW1iZXJdeywxMH1dLHZpZXdzW25hbWUsam9ic1tuYW1lXV1gO1xuXG4gICAgICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIGRhdGEuam9icy5tYXAoZnVuY3Rpb24gKGpvYikge1xuICAgICAgICAgIGNvbnN0IG5hbWUgPSBqb2IubmFtZTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7bmFtZX0vYXBpL2pzb25gLFxuICAgICAgICAgICAgaHRtbF91cmw6IGAke2VuZHBvaW50fS9qb2IvJHtuYW1lfWAsXG4gICAgICAgICAgICBidWlsZHNfdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7bmFtZX0ve251bWJlcn0vYXBpL2pzb257P3RyZWV9YCxcbiAgICAgICAgICAgIGJ1aWxkczogam9iLmJ1aWxkcy5tYXAoYnVpbGQgPT4gYnVpbGQubnVtYmVyKSxcbiAgICAgICAgICAgIGRhdGE6IGRhdGFcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRzKGJ1aWxkZXIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYnVpbGRlci5idWlsZHMubWFwKGZ1bmN0aW9uIChudW1iZXIpIHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoIGJ1aWxkZXIuYnVpbGRzX3VybCApO1xuICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSk7XG4gICAgfSkpLnRoZW4oZnVuY3Rpb24gKGJ1aWxkcykge1xuICAgICAgcmV0dXJuIGJ1aWxkcy5tYXAoZnVuY3Rpb24gKGJ1aWxkKSB7XG4gICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYnVpbGQuYnVpbGRpbmc7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBidWlsZGVyLm5hbWUsXG4gICAgICAgICAgbnVtYmVyOiBidWlsZC5udW1iZXIsXG4gICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7YnVpbGRlci5uYW1lfS8ke2J1aWxkLm51bWJlcn0vYXBpL2pzb25gLFxuICAgICAgICAgIGh0bWxfdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7YnVpbGRlci5uYW1lfS8ke2J1aWxkLm51bWJlcn1gLFxuICAgICAgICAgIHN0YXRlOiBidWlsZGluZyA/IFBFTkRJTkcgOiAoIEpFTktJTlNfU1RBVEVfTUFQWyBidWlsZC5yZXN1bHQgXSB8fCBVTktOT1dOICksXG4gICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKGJ1aWxkLnRpbWVzdGFtcCksXG4gICAgICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC50aW1lc3RhbXAgKyBidWlsZC5kdXJhdGlvbiksXG4gICAgICAgICAgZGF0YTogYnVpbGRcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRJbmZvLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkc1xuICB9O1xufVxuIl19