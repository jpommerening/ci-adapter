'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Jenkins;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _util = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var JENKINS_MEDIA_TYPE = 'application/json';
var JENKINS_STATE_MAP = {
  SUCCESS: _constants.SUCCESS,
  UNSTABLE: _constants.WARNING,
  FAILURE: _constants.FAILURE
};

function Jenkins(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var view = _ref.view;

  var headers = Object.assign({
    'Accept': JENKINS_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/api/json', options).then(_util.handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({ name: name });

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(makeBuilder);
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(function (data) {
        return makeBuild(builder.data, data);
      });
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var url = endpoint + '/api/json?tree=jobs[name,buildable,builds[number]{,10}],views[name,jobs[name]]';

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(function (data) {
      var filter = view ? function (v) {
        return v.name === view;
      } : function () {
        return true;
      };
      var jobs = data.views.filter(filter)[0].jobs.map(function (job) {
        return job.name;
      });
      return data.jobs.filter(function (job) {
        return jobs.indexOf(job.name) >= 0 && job.buildable;
      }).map(makeBuilder);
    });
  }

  function getBuilds(name) {
    return getBuilder(name).then(function (builder) {
      return Promise.all(builder.builds.map(function (number) {
        return getBuild(name, number);
      }));
    });
  }

  function makeInfo(root) {
    var name = root.nodeName;
    var builders = root.jobs.map(function (job) {
      return job.name;
    });
    var data = root;

    return {
      name: name,
      url: endpoint + '/api/json',
      html_url: endpoint,
      builders_url: endpoint + '/job{/name}/api/json{?tree}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(job) {
    var name = job.name;
    var builds = job.builds.map(function (build) {
      return build.number;
    });
    var data = job;

    return {
      data: data,
      name: name,
      url: endpoint + '/job/' + name + '/api/json',
      html_url: endpoint + '/job/' + name,
      builds_url: endpoint + '/job/' + name + '/{number}/api/json{?tree}',
      builds: builds
    };
  }

  function makeBuild(job, build) {
    var name = job.name;
    var number = build.number;
    var building = build.building;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/job/' + name + '/' + number + '/api/json',
      html_url: endpoint + '/job/' + name + '/' + number,
      state: building ? _constants.PENDING : JENKINS_STATE_MAP[build.result] || _constants.UNKNOWN,
      start: new Date(build.timestamp),
      end: building ? null : new Date(build.timestamp + build.duration),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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SyxDQUFDLFFBQVEsQ0FBQztBQUNqRSxVQUFJLEVBQUosSUFBSTtLQUNMLENBQUM7R0FDSDs7QUFFRCxTQUFPO0FBQ0wsV0FBTyxFQUFQLE9BQU87QUFDUCxjQUFVLEVBQVYsVUFBVTtBQUNWLGVBQVcsRUFBWCxXQUFXO0FBQ1gsWUFBUSxFQUFSLFFBQVE7QUFDUixhQUFTLEVBQVQsU0FBUztHQUNWLENBQUM7Q0FDSCIsImZpbGUiOiJqZW5raW5zLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZldGNoIGZyb20gJy4vZmV0Y2gnO1xuaW1wb3J0IHVybHRlbXBsYXRlIGZyb20gJ3VybC10ZW1wbGF0ZSc7XG5pbXBvcnQgeyBoYW5kbGVSZXNwb25zZSB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBQRU5ESU5HLCBTVUNDRVNTLCBGQUlMVVJFLCBXQVJOSU5HLCBVTktOT1dOLCBVU0VSX0FHRU5UIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5jb25zdCBKRU5LSU5TX01FRElBX1RZUEUgPSAnYXBwbGljYXRpb24vanNvbic7XG5jb25zdCBKRU5LSU5TX1NUQVRFX01BUCA9IHtcbiAgU1VDQ0VTUzogU1VDQ0VTUyxcbiAgVU5TVEFCTEU6IFdBUk5JTkcsXG4gIEZBSUxVUkU6IEZBSUxVUkVcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEplbmtpbnMoZW5kcG9pbnQsIHsgaGVhZGVyczogaCwgdmlldyB9ID0ge30pIHtcbiAgY29uc3QgaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICdBY2NlcHQnOiBKRU5LSU5TX01FRElBX1RZUEUsXG4gICAgJ1VzZXItQWdlbnQnOiBVU0VSX0FHRU5UXG4gIH0sIGgpO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcblxuICBmdW5jdGlvbiBnZXRJbmZvKCkge1xuICAgIHJldHVybiBmZXRjaChgJHtlbmRwb2ludH0vYXBpL2pzb25gLCBvcHRpb25zKVxuICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAudGhlbihtYWtlSW5mbyk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZGVyKG5hbWUpIHtcbiAgICByZXR1cm4gZ2V0SW5mbygpXG4gICAgICAudGhlbihmdW5jdGlvbiAoaW5mbykge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKGluZm8uYnVpbGRlcnNfdXJsKTtcbiAgICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbmFtZSB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKG1ha2VCdWlsZGVyKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkKG5hbWUsIG51bWJlcikge1xuICAgIHJldHVybiBnZXRCdWlsZGVyKG5hbWUpXG4gICAgICAudGhlbihmdW5jdGlvbiAoYnVpbGRlcikge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKGJ1aWxkZXIuYnVpbGRzX3VybCk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG51bWJlciB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKVxuICAgICAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgICAgIC50aGVuKGRhdGEgPT4gbWFrZUJ1aWxkKGJ1aWxkZXIuZGF0YSwgZGF0YSkpO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZGVycygpIHtcbiAgICByZXR1cm4gZ2V0SW5mbygpXG4gICAgICAudGhlbihmdW5jdGlvbiAoaW5mbykge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHtlbmRwb2ludH0vYXBpL2pzb24/dHJlZT1qb2JzW25hbWUsYnVpbGRhYmxlLGJ1aWxkc1tudW1iZXJdeywxMH1dLHZpZXdzW25hbWUsam9ic1tuYW1lXV1gO1xuXG4gICAgICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgY29uc3QgZmlsdGVyID0gdmlldyA/ICh2ID0+IHYubmFtZSA9PT0gdmlldykgOiAoKCkgPT4gdHJ1ZSk7XG4gICAgICAgIGNvbnN0IGpvYnMgPSBkYXRhLnZpZXdzLmZpbHRlcihmaWx0ZXIpWyAwIF0uam9icy5tYXAoam9iID0+IGpvYi5uYW1lKTtcbiAgICAgICAgcmV0dXJuIGRhdGEuam9icy5maWx0ZXIoZnVuY3Rpb24gKGpvYikge1xuICAgICAgICAgIHJldHVybiBqb2JzLmluZGV4T2Yoam9iLm5hbWUpID49IDAgJiYgam9iLmJ1aWxkYWJsZTtcbiAgICAgICAgfSkubWFwKG1ha2VCdWlsZGVyKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRzKG5hbWUpIHtcbiAgICByZXR1cm4gZ2V0QnVpbGRlcihuYW1lKVxuICAgICAgLnRoZW4oYnVpbGRlciA9PiBQcm9taXNlLmFsbChidWlsZGVyLmJ1aWxkcy5tYXAobnVtYmVyID0+IGdldEJ1aWxkKG5hbWUsIG51bWJlcikpKSk7XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlSW5mbyhyb290KSB7XG4gICAgY29uc3QgbmFtZSA9IHJvb3Qubm9kZU5hbWU7XG4gICAgY29uc3QgYnVpbGRlcnMgPSByb290LmpvYnMubWFwKGpvYiA9PiBqb2IubmFtZSk7XG4gICAgY29uc3QgZGF0YSA9IHJvb3Q7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2FwaS9qc29uYCxcbiAgICAgIGh0bWxfdXJsOiBlbmRwb2ludCxcbiAgICAgIGJ1aWxkZXJzX3VybDogYCR7ZW5kcG9pbnR9L2pvYnsvbmFtZX0vYXBpL2pzb257P3RyZWV9YCxcbiAgICAgIGJ1aWxkZXJzLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlQnVpbGRlcihqb2IpIHtcbiAgICBjb25zdCBuYW1lID0gam9iLm5hbWU7XG4gICAgY29uc3QgYnVpbGRzID0gam9iLmJ1aWxkcy5tYXAoYnVpbGQgPT4gYnVpbGQubnVtYmVyKTtcbiAgICBjb25zdCBkYXRhID0gam9iO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGEsXG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7bmFtZX0vYXBpL2pzb25gLFxuICAgICAgaHRtbF91cmw6IGAke2VuZHBvaW50fS9qb2IvJHtuYW1lfWAsXG4gICAgICBidWlsZHNfdXJsOiBgJHtlbmRwb2ludH0vam9iLyR7bmFtZX0ve251bWJlcn0vYXBpL2pzb257P3RyZWV9YCxcbiAgICAgIGJ1aWxkc1xuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlQnVpbGQoam9iLCBidWlsZCkge1xuICAgIGNvbnN0IG5hbWUgPSBqb2IubmFtZTtcbiAgICBjb25zdCBudW1iZXIgPSBidWlsZC5udW1iZXI7XG4gICAgY29uc3QgYnVpbGRpbmcgPSBidWlsZC5idWlsZGluZztcbiAgICBjb25zdCBkYXRhID0gYnVpbGQ7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIG51bWJlcixcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pvYi8ke25hbWV9LyR7bnVtYmVyfS9hcGkvanNvbmAsXG4gICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2pvYi8ke25hbWV9LyR7bnVtYmVyfWAsXG4gICAgICBzdGF0ZTogYnVpbGRpbmcgPyBQRU5ESU5HIDogKEpFTktJTlNfU1RBVEVfTUFQWyBidWlsZC5yZXN1bHQgXSB8fCBVTktOT1dOKSxcbiAgICAgIHN0YXJ0OiBuZXcgRGF0ZShidWlsZC50aW1lc3RhbXApLFxuICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC50aW1lc3RhbXAgKyBidWlsZC5kdXJhdGlvbiksXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2V0SW5mbyxcbiAgICBnZXRCdWlsZGVyLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkLFxuICAgIGdldEJ1aWxkc1xuICB9O1xufVxuIl19