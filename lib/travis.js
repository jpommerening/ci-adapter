'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('./url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _adapter = require('./adapter');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.2+json';
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _adapter.PENDING,
  created: _adapter.PENDING,
  queued: _adapter.PENDING,
  started: _adapter.PENDING,
  passed: _adapter.SUCCESS,
  failed: _adapter.FAILURE,
  errored: _adapter.ERRORED,
  canceled: _adapter.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  var headers = Object.assign({
    Accept: TRAVIS_MEDIA_TYPE
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);

  function getToken() {
    return (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    });
  }

  function getInfo() {
    return getToken().then(function (token) {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(function (response) {
      return response.json();
    }).then(function (data) {
      return {
        name: 'Travis CI - ' + account + ' (' + endpoint + ')',
        url: endpoint + '/repos/' + account,
        html_url: html_url + '/' + account,
        builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
        builders: data.repos.map(function (repo) {
          return repo.slug.split('/')[1];
        }),
        data: data
      };
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var repos = info.data.repos.filter(function (repo) {
        return repo.last_build_number !== null;
      });
      return repos.map(function (repo) {
        var slug = repo.slug;
        var name = slug.split('/')[1];
        var last = parseInt(repo.last_build_number, 10);
        var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(function (x) {
          return last - x;
        }).filter(function (x) {
          return x >= 0;
        });

        return {
          name: name,
          url: endpoint + '/repos/' + slug,
          html_url: html_url + '/' + slug,
          builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
          builds: builds,
          data: repo
        };
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(function (response) {
        return response.json();
      });
    })).then(function (data) {
      var builds = [].concat.apply([], data.map(function (data) {
        return data.builds;
      }));

      return builds.map(function (build) {
        var building = TRAVIS_STATE_MAP[build.state] === _adapter.PENDING;

        return {
          name: builder.name,
          number: parseInt(build.number, 10),
          url: endpoint + '/repos/' + account + '/' + builder.name + '/builds/' + build.id,
          html_url: html_url + '/' + account + '/' + builder.name + '/builds/' + build.id,
          state: TRAVIS_STATE_MAP[build.state],
          start: new Date(build.started_at),
          end: building ? null : new Date(build.finished_at),
          data: build
        };
      });
    });
  }

  function getBuildDetails(build) {}

  return {
    getInfo: getInfo,
    getBuilders: getBuilders,
    getBuilds: getBuilds,
    getBuildDetails: getBuildDetails
  };
}
//# sourceMappingURL=data:application/json;base64,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RUFBRSxFQUFFLENBQUM7QUFDbEMsYUFBRyxFQUFLLFFBQVEsZUFBVSxPQUFPLFNBQUksT0FBTyxDQUFDLElBQUksZ0JBQVcsS0FBSyxDQUFDLEVBQUUsQUFBRTtBQUN0RSxrQkFBUSxFQUFLLFFBQVEsU0FBSSxPQUFPLFNBQUksT0FBTyxDQUFDLElBQUksZ0JBQVcsS0FBSyxDQUFDLEVBQUUsQUFBRTtBQUNyRSxlQUFLLEVBQUUsZ0JBQWdCLENBQUUsS0FBSyxDQUFDLEtBQUssQ0FBRTtBQUN0QyxlQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztBQUNqQyxhQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDO0FBQ2xELGNBQUksRUFBRSxLQUFLO1NBQ1osQ0FBQztPQUNILENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQztHQUNKOztBQUVELFdBQVMsZUFBZSxDQUFDLEtBQUssRUFBRSxFQUMvQjs7QUFFRCxTQUFPO0FBQ0wsV0FBTyxFQUFQLE9BQU87QUFDUCxlQUFXLEVBQVgsV0FBVztBQUNYLGFBQVMsRUFBVCxTQUFTO0FBQ1QsbUJBQWUsRUFBZixlQUFlO0dBQ2hCLENBQUM7Q0FDSCIsImZpbGUiOiJ0cmF2aXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnLi9mZXRjaCc7XG5pbXBvcnQgdXJsdGVtcGxhdGUgZnJvbSAnLi91cmwtdGVtcGxhdGUnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgRkFJTFVSRSwgRVJST1JFRCwgQUJPUlRFRCwgVU5LTk9XTiB9IGZyb20gJy4vYWRhcHRlcic7XG5cbmNvbnN0IFRSQVZJU19NRURJQV9UWVBFID0gJ2FwcGxpY2F0aW9uL3ZuZC50cmF2aXMtY2kuMitqc29uJztcbmNvbnN0IFRSQVZJU19IVE1MX1VSTCA9IC9eKGh0dHBzPzpcXC9cXC8pKGFwaVxcLih0cmF2aXMtY2lcXC4ob3JnfGNvbSkpfChbXlxcL10rKVxcL2FwaSkoXFwvLispPyQvO1xuY29uc3QgVFJBVklTX1NUQVRFX01BUCA9IHtcbiAgcmVjZWl2ZWQ6IFBFTkRJTkcsXG4gIGNyZWF0ZWQ6IFBFTkRJTkcsXG4gIHF1ZXVlZDogUEVORElORyxcbiAgc3RhcnRlZDogUEVORElORyxcbiAgcGFzc2VkOiBTVUNDRVNTLFxuICBmYWlsZWQ6IEZBSUxVUkUsXG4gIGVycm9yZWQ6IEVSUk9SRUQsXG4gIGNhbmNlbGVkOiBBQk9SVEVEXG59O1xuXG5mdW5jdGlvbiBnZXRIdG1sVXJsKHVybCkge1xuICBjb25zdCBtYXRjaCA9IFRSQVZJU19IVE1MX1VSTC5leGVjKHVybCk7XG4gIHJldHVybiBtYXRjaFsxXSArIChtYXRjaFszXSB8fCBtYXRjaFs1XSkgKyAobWF0Y2hbNl0gfHwgJycpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBUcmF2aXMoZW5kcG9pbnQsIHsgaGVhZGVyczogaCwgZ2l0aHViX3Rva2VuLCBhY2NvdW50IH0gPSB7fSkge1xuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbigge1xuICAgIEFjY2VwdDogVFJBVklTX01FRElBX1RZUEVcbiAgfSwgaCApO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcbiAgY29uc3QgaHRtbF91cmwgPSBnZXRIdG1sVXJsKGVuZHBvaW50KTtcblxuICBmdW5jdGlvbiBnZXRUb2tlbigpIHtcbiAgICByZXR1cm4gZmV0Y2goYCR7ZW5kcG9pbnR9L2F1dGgvZ2l0aHViYCwge1xuICAgICAgbWV0aG9kOiAncG9zdCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGdpdGh1Yl90b2tlbiB9KVxuICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgIH0pLnRoZW4oZnVuY3Rpb24gKHsgYWNjZXNzX3Rva2VuIH0pIHtcbiAgICAgIG9wdGlvbnMuaGVhZGVyc1sgJ0F1dGhvcml6YXRpb24nIF0gPSBgdG9rZW4gJHthY2Nlc3NfdG9rZW59YDtcbiAgICAgIHJldHVybiBhY2Nlc3NfdG9rZW47XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRJbmZvKCkge1xuICAgIHJldHVybiBnZXRUb2tlbigpXG4gICAgICAudGhlbihmdW5jdGlvbih0b2tlbikge1xuICAgICAgICByZXR1cm4gZmV0Y2goYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH1gLCBvcHRpb25zKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICB9KS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogYFRyYXZpcyBDSSAtICR7YWNjb3VudH0gKCR7ZW5kcG9pbnR9KWAsXG4gICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHthY2NvdW50fWAsXG4gICAgICAgICAgaHRtbF91cmw6IGAke2h0bWxfdXJsfS8ke2FjY291bnR9YCxcbiAgICAgICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9ey9uYW1lfXs/aWRzfWAsXG4gICAgICAgICAgYnVpbGRlcnM6IGRhdGEucmVwb3MubWFwKHJlcG8gPT4gcmVwby5zbHVnLnNwbGl0KCcvJylbMV0pLFxuICAgICAgICAgIGRhdGE6IGRhdGFcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcnMoKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgcmVwb3MgPSBpbmZvLmRhdGEucmVwb3MuZmlsdGVyKHJlcG8gPT4gcmVwby5sYXN0X2J1aWxkX251bWJlciAhPT0gbnVsbCk7XG4gICAgICAgIHJldHVybiByZXBvcy5tYXAoZnVuY3Rpb24gKHJlcG8pIHtcbiAgICAgICAgICBjb25zdCBzbHVnID0gcmVwby5zbHVnO1xuICAgICAgICAgIGNvbnN0IG5hbWUgPSBzbHVnLnNwbGl0KCcvJylbMV07XG4gICAgICAgICAgY29uc3QgbGFzdCA9IHBhcnNlSW50KCByZXBvLmxhc3RfYnVpbGRfbnVtYmVyLCAxMCApO1xuICAgICAgICAgIGNvbnN0IGJ1aWxkcyA9IFsgMCwgMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTAgXS5tYXAoIHggPT4gbGFzdCAtIHggKS5maWx0ZXIoIHggPT4geCA+PSAwICk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIHVybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z31gLFxuICAgICAgICAgICAgaHRtbF91cmw6IGAke2h0bWxfdXJsfS8ke3NsdWd9YCxcbiAgICAgICAgICAgIGJ1aWxkc191cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke3NsdWd9L2J1aWxkc3s/bnVtYmVyLGFmdGVyX251bWJlcn1gLFxuICAgICAgICAgICAgYnVpbGRzOiBidWlsZHMsXG4gICAgICAgICAgICBkYXRhOiByZXBvXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkcyhidWlsZGVyKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKGJ1aWxkZXIuYnVpbGRzLm1hcChmdW5jdGlvbiAobnVtYmVyKSB7XG4gICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKCBidWlsZGVyLmJ1aWxkc191cmwgKTtcbiAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG51bWJlciB9KTtcblxuICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pO1xuICAgIH0pKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICBjb25zdCBidWlsZHMgPSBbXS5jb25jYXQuYXBwbHkoIFtdLCBkYXRhLm1hcChkYXRhID0+IGRhdGEuYnVpbGRzKSApO1xuXG4gICAgICByZXR1cm4gYnVpbGRzLm1hcChmdW5jdGlvbiAoYnVpbGQpIHtcbiAgICAgICAgY29uc3QgYnVpbGRpbmcgPSBUUkFWSVNfU1RBVEVfTUFQWyBidWlsZC5zdGF0ZSBdID09PSBQRU5ESU5HO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogYnVpbGRlci5uYW1lLFxuICAgICAgICAgIG51bWJlcjogcGFyc2VJbnQoYnVpbGQubnVtYmVyLCAxMCksXG4gICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHthY2NvdW50fS8ke2J1aWxkZXIubmFtZX0vYnVpbGRzLyR7YnVpbGQuaWR9YCxcbiAgICAgICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7YWNjb3VudH0vJHtidWlsZGVyLm5hbWV9L2J1aWxkcy8ke2J1aWxkLmlkfWAsXG4gICAgICAgICAgc3RhdGU6IFRSQVZJU19TVEFURV9NQVBbIGJ1aWxkLnN0YXRlIF0sXG4gICAgICAgICAgc3RhcnQ6IG5ldyBEYXRlKGJ1aWxkLnN0YXJ0ZWRfYXQpLFxuICAgICAgICAgIGVuZDogYnVpbGRpbmcgPyBudWxsIDogbmV3IERhdGUoYnVpbGQuZmluaXNoZWRfYXQpLFxuICAgICAgICAgIGRhdGE6IGJ1aWxkXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkRGV0YWlscyhidWlsZCkge1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRJbmZvLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkcyxcbiAgICBnZXRCdWlsZERldGFpbHNcbiAgfTtcbn1cbiJdfQ==