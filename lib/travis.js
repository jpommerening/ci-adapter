'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _adapter = require('./adapter');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.2+json';
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _adapter.PENDING,
  created: _adapter.PENDING,
  queued: _adapter.PENDING,
  started: _adapter.PENDING,
  passed: _adapter.SUCCESS,
  failed: _adapter.FAILURE,
  errored: _adapter.ERRORED,
  canceled: _adapter.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  var headers = Object.assign({
    'Accept': TRAVIS_MEDIA_TYPE
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);

  function getToken() {
    return (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: {
        'Accept': TRAVIS_MEDIA_TYPE,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      if (response.status !== 200) {
        return response.text().then(function (text) {
          return Promise.reject(new Error(text));
        });
      }
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    });
  }

  function getInfo() {
    return getToken().then(function (token) {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(function (response) {
      return response.json();
    }).then(function (data) {
      return {
        name: 'Travis CI - ' + account + ' (' + endpoint + ')',
        url: endpoint + '/repos/' + account,
        html_url: html_url + '/' + account,
        builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
        builders: data.repos.map(function (repo) {
          return repo.slug.split('/')[1];
        }),
        data: data
      };
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var repos = info.data.repos.filter(function (repo) {
        return repo.last_build_number !== null;
      });
      return repos.map(function (repo) {
        var slug = repo.slug;
        var name = slug.split('/')[1];
        var last = parseInt(repo.last_build_number, 10);
        var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(function (x) {
          return last - x;
        }).filter(function (x) {
          return x >= 0;
        });

        return {
          name: name,
          url: endpoint + '/repos/' + slug,
          html_url: html_url + '/' + slug,
          builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
          builds: builds,
          data: repo
        };
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(function (response) {
        return response.json();
      });
    })).then(function (data) {
      var builds = [].concat.apply([], data.map(function (data) {
        return data.builds;
      }));

      return builds.map(function (build) {
        var building = TRAVIS_STATE_MAP[build.state] === _adapter.PENDING;

        return {
          name: builder.name,
          number: parseInt(build.number, 10),
          url: endpoint + '/repos/' + account + '/' + builder.name + '/builds/' + build.id,
          html_url: html_url + '/' + account + '/' + builder.name + '/builds/' + build.id,
          state: TRAVIS_STATE_MAP[build.state],
          start: new Date(build.started_at),
          end: building ? null : new Date(build.finished_at),
          data: build
        };
      });
    });
  }

  return {
    getInfo: getInfo,
    getBuilders: getBuilders,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90cmF2aXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7a0JBc0J3QixNQUFNOzs7Ozs7Ozs7Ozs7OztBQWxCOUIsSUFBTSxpQkFBaUIsR0FBRyxrQ0FBa0MsQ0FBQztBQUM3RCxJQUFNLGVBQWUsR0FBRyxtRUFBbUUsQ0FBQztBQUM1RixJQUFNLGdCQUFnQixHQUFHO0FBQ3ZCLFVBQVEsV0FMRCxPQUFPLEFBS0c7QUFDakIsU0FBTyxXQU5BLE9BQU8sQUFNRTtBQUNoQixRQUFNLFdBUEMsT0FBTyxBQU9DO0FBQ2YsU0FBTyxXQVJBLE9BQU8sQUFRRTtBQUNoQixRQUFNLFdBVFUsT0FBTyxBQVNSO0FBQ2YsUUFBTSxXQVZtQixPQUFPLEFBVWpCO0FBQ2YsU0FBTyxXQVgyQixPQUFPLEFBV3pCO0FBQ2hCLFVBQVEsV0FabUMsT0FBTyxBQVlqQztDQUNsQixDQUFDOztBQUVGLFNBQVMsVUFBVSxDQUFDLEdBQUcsRUFBRTtBQUN2QixNQUFNLEtBQUssR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3hDLFNBQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUEsQUFBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUEsQUFBQyxDQUFDO0NBQzdEOztBQUVjLFNBQVMsTUFBTSxDQUFDLFFBQVEsRUFBOEM7bUVBQUosRUFBRTs7TUFBL0IsQ0FBQyxRQUFWLE9BQU87TUFBSyxZQUFZLFFBQVosWUFBWTtNQUFFLE9BQU8sUUFBUCxPQUFPOztBQUMxRSxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFFO0FBQzdCLFlBQVEsRUFBRSxpQkFBaUI7R0FDNUIsRUFBRSxDQUFDLENBQUUsQ0FBQztBQUNQLE1BQU0sT0FBTyxHQUFHO0FBQ2QsV0FBTyxFQUFQLE9BQU87R0FDUixDQUFDO0FBQ0YsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDOztBQUV0QyxXQUFTLFFBQVEsR0FBRztBQUNsQixXQUFPLHFCQUFTLFFBQVEsbUJBQWdCO0FBQ3RDLFlBQU0sRUFBRSxNQUFNO0FBQ2QsYUFBTyxFQUFFO0FBQ1AsZ0JBQVEsRUFBRSxpQkFBaUI7QUFDM0Isc0JBQWMsRUFBRSxrQkFBa0I7T0FDbkM7QUFDRCxVQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFlBQVksRUFBWixZQUFZLEVBQUUsQ0FBQztLQUN2QyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsUUFBUSxFQUFFO0FBQzFCLFVBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7QUFDM0IsZUFBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUEsSUFBSTtpQkFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQUEsQ0FBQyxDQUFDO09BQ3RFO0FBQ0QsYUFBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDeEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBNEI7VUFBaEIsWUFBWSxTQUFaLFlBQVk7O0FBQzlCLGFBQU8sQ0FBQyxPQUFPLENBQUUsZUFBZSxDQUFFLGNBQVksWUFBWSxBQUFFLENBQUM7QUFDN0QsYUFBTyxZQUFZLENBQUM7S0FDckIsQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsV0FBUyxPQUFPLEdBQUc7QUFDakIsV0FBTyxRQUFRLEVBQUUsQ0FDZCxJQUFJLENBQUMsVUFBUyxLQUFLLEVBQUU7QUFDcEIsYUFBTyxxQkFBUyxRQUFRLGVBQVUsT0FBTyxFQUFJLE9BQU8sQ0FBQyxDQUFDO0tBQ3ZELENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxRQUFRLEVBQUU7QUFDMUIsYUFBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDeEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRTtBQUN0QixhQUFPO0FBQ0wsWUFBSSxtQkFBaUIsT0FBTyxVQUFLLFFBQVEsTUFBRztBQUM1QyxXQUFHLEVBQUssUUFBUSxlQUFVLE9BQU8sQUFBRTtBQUNuQyxnQkFBUSxFQUFLLFFBQVEsU0FBSSxPQUFPLEFBQUU7QUFDbEMsb0JBQVksRUFBSyxRQUFRLGVBQVUsT0FBTyxrQkFBZTtBQUN6RCxnQkFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSTtpQkFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FBQSxDQUFDO0FBQ3pELFlBQUksRUFBRSxJQUFJO09BQ1gsQ0FBQztLQUNILENBQUMsQ0FBQztHQUNOOztBQUVELFdBQVMsV0FBVyxHQUFHO0FBQ3JCLFdBQU8sT0FBTyxFQUFFLENBQ2IsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFO0FBQ3BCLFVBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUk7ZUFBSSxJQUFJLENBQUMsaUJBQWlCLEtBQUssSUFBSTtPQUFBLENBQUMsQ0FBQztBQUM5RSxhQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLEVBQUU7QUFDL0IsWUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztBQUN2QixZQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2hDLFlBQU0sSUFBSSxHQUFHLFFBQVEsQ0FBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFFLENBQUM7QUFDcEQsWUFBTSxNQUFNLEdBQUcsQ0FBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFFLENBQUMsR0FBRyxDQUFFLFVBQUEsQ0FBQztpQkFBSSxJQUFJLEdBQUcsQ0FBQztTQUFBLENBQUUsQ0FBQyxNQUFNLENBQUUsVUFBQSxDQUFDO2lCQUFJLENBQUMsSUFBSSxDQUFDO1NBQUEsQ0FBRSxDQUFDOztBQUUvRixlQUFPO0FBQ0wsY0FBSSxFQUFFLElBQUk7QUFDVixhQUFHLEVBQUssUUFBUSxlQUFVLElBQUksQUFBRTtBQUNoQyxrQkFBUSxFQUFLLFFBQVEsU0FBSSxJQUFJLEFBQUU7QUFDL0Isb0JBQVUsRUFBSyxRQUFRLGVBQVUsSUFBSSxrQ0FBK0I7QUFDcEUsZ0JBQU0sRUFBRSxNQUFNO0FBQ2QsY0FBSSxFQUFFLElBQUk7U0FDWCxDQUFDO09BQ0gsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ047O0FBRUQsV0FBUyxTQUFTLENBQUMsT0FBTyxFQUFFO0FBQzFCLFdBQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLE1BQU0sRUFBRTtBQUN0RCxVQUFNLFFBQVEsR0FBRyxzQkFBWSxLQUFLLENBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBRSxDQUFDO0FBQ3pELFVBQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQU4sTUFBTSxFQUFFLENBQUMsQ0FBQzs7QUFFeEMsYUFBTyxxQkFBTSxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsUUFBUSxFQUFFO0FBQ2xELGVBQU8sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO09BQ3hCLENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRTtBQUN2QixVQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUk7ZUFBSSxJQUFJLENBQUMsTUFBTTtPQUFBLENBQUMsQ0FBRSxDQUFDOztBQUVwRSxhQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxLQUFLLEVBQUU7QUFDakMsWUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUUsS0FBSyxDQUFDLEtBQUssQ0FBRSxjQXBHL0MsT0FBTyxBQW9Hb0QsQ0FBQzs7QUFFN0QsZUFBTztBQUNMLGNBQUksRUFBRSxPQUFPLENBQUMsSUFBSTtBQUNsQixnQkFBTSxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQztBQUNsQyxhQUFHLEVBQUssUUFBUSxlQUFVLE9BQU8sU0FBSSxPQUFPLENBQUMsSUFBSSxnQkFBVyxLQUFLLENBQUMsRUFBRSxBQUFFO0FBQ3RFLGtCQUFRLEVBQUssUUFBUSxTQUFJLE9BQU8sU0FBSSxPQUFPLENBQUMsSUFBSSxnQkFBVyxLQUFLLENBQUMsRUFBRSxBQUFFO0FBQ3JFLGVBQUssRUFBRSxnQkFBZ0IsQ0FBRSxLQUFLLENBQUMsS0FBSyxDQUFFO0FBQ3RDLGVBQUssRUFBRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDO0FBQ2pDLGFBQUcsRUFBRSxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7QUFDbEQsY0FBSSxFQUFFLEtBQUs7U0FDWixDQUFDO09BQ0gsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsU0FBTztBQUNMLFdBQU8sRUFBUCxPQUFPO0FBQ1AsZUFBVyxFQUFYLFdBQVc7QUFDWCxhQUFTLEVBQVQsU0FBUztHQUNWLENBQUM7Q0FDSCIsImZpbGUiOiJ0cmF2aXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnLi9mZXRjaCc7XG5pbXBvcnQgdXJsdGVtcGxhdGUgZnJvbSAndXJsLXRlbXBsYXRlJztcbmltcG9ydCB7IFBFTkRJTkcsIFNVQ0NFU1MsIEZBSUxVUkUsIEVSUk9SRUQsIEFCT1JURUQsIFVOS05PV04gfSBmcm9tICcuL2FkYXB0ZXInO1xuXG5jb25zdCBUUkFWSVNfTUVESUFfVFlQRSA9ICdhcHBsaWNhdGlvbi92bmQudHJhdmlzLWNpLjIranNvbic7XG5jb25zdCBUUkFWSVNfSFRNTF9VUkwgPSAvXihodHRwcz86XFwvXFwvKShhcGlcXC4odHJhdmlzLWNpXFwuKG9yZ3xjb20pKXwoW15cXC9dKylcXC9hcGkpKFxcLy4rKT8kLztcbmNvbnN0IFRSQVZJU19TVEFURV9NQVAgPSB7XG4gIHJlY2VpdmVkOiBQRU5ESU5HLFxuICBjcmVhdGVkOiBQRU5ESU5HLFxuICBxdWV1ZWQ6IFBFTkRJTkcsXG4gIHN0YXJ0ZWQ6IFBFTkRJTkcsXG4gIHBhc3NlZDogU1VDQ0VTUyxcbiAgZmFpbGVkOiBGQUlMVVJFLFxuICBlcnJvcmVkOiBFUlJPUkVELFxuICBjYW5jZWxlZDogQUJPUlRFRFxufTtcblxuZnVuY3Rpb24gZ2V0SHRtbFVybCh1cmwpIHtcbiAgY29uc3QgbWF0Y2ggPSBUUkFWSVNfSFRNTF9VUkwuZXhlYyh1cmwpO1xuICByZXR1cm4gbWF0Y2hbMV0gKyAobWF0Y2hbM10gfHwgbWF0Y2hbNV0pICsgKG1hdGNoWzZdIHx8ICcnKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gVHJhdmlzKGVuZHBvaW50LCB7IGhlYWRlcnM6IGgsIGdpdGh1Yl90b2tlbiwgYWNjb3VudCB9ID0ge30pIHtcbiAgY29uc3QgaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oIHtcbiAgICAnQWNjZXB0JzogVFJBVklTX01FRElBX1RZUEVcbiAgfSwgaCApO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcbiAgY29uc3QgaHRtbF91cmwgPSBnZXRIdG1sVXJsKGVuZHBvaW50KTtcblxuICBmdW5jdGlvbiBnZXRUb2tlbigpIHtcbiAgICByZXR1cm4gZmV0Y2goYCR7ZW5kcG9pbnR9L2F1dGgvZ2l0aHViYCwge1xuICAgICAgbWV0aG9kOiAncG9zdCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdBY2NlcHQnOiBUUkFWSVNfTUVESUFfVFlQRSxcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZ2l0aHViX3Rva2VuIH0pXG4gICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UudGV4dCgpLnRoZW4odGV4dCA9PiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IodGV4dCkpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgfSkudGhlbihmdW5jdGlvbiAoeyBhY2Nlc3NfdG9rZW4gfSkge1xuICAgICAgb3B0aW9ucy5oZWFkZXJzWyAnQXV0aG9yaXphdGlvbicgXSA9IGB0b2tlbiAke2FjY2Vzc190b2tlbn1gO1xuICAgICAgcmV0dXJuIGFjY2Vzc190b2tlbjtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIGdldFRva2VuKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uKHRva2VuKSB7XG4gICAgICAgIHJldHVybiBmZXRjaChgJHtlbmRwb2ludH0vcmVwb3MvJHthY2NvdW50fWAsIG9wdGlvbnMpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBgVHJhdmlzIENJIC0gJHthY2NvdW50fSAoJHtlbmRwb2ludH0pYCxcbiAgICAgICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9YCxcbiAgICAgICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7YWNjb3VudH1gLFxuICAgICAgICAgIGJ1aWxkZXJzX3VybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH17L25hbWV9ez9pZHN9YCxcbiAgICAgICAgICBidWlsZGVyczogZGF0YS5yZXBvcy5tYXAocmVwbyA9PiByZXBvLnNsdWcuc3BsaXQoJy8nKVsxXSksXG4gICAgICAgICAgZGF0YTogZGF0YVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZGVycygpIHtcbiAgICByZXR1cm4gZ2V0SW5mbygpXG4gICAgICAudGhlbihmdW5jdGlvbiAoaW5mbykge1xuICAgICAgICBjb25zdCByZXBvcyA9IGluZm8uZGF0YS5yZXBvcy5maWx0ZXIocmVwbyA9PiByZXBvLmxhc3RfYnVpbGRfbnVtYmVyICE9PSBudWxsKTtcbiAgICAgICAgcmV0dXJuIHJlcG9zLm1hcChmdW5jdGlvbiAocmVwbykge1xuICAgICAgICAgIGNvbnN0IHNsdWcgPSByZXBvLnNsdWc7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IHNsdWcuc3BsaXQoJy8nKVsxXTtcbiAgICAgICAgICBjb25zdCBsYXN0ID0gcGFyc2VJbnQoIHJlcG8ubGFzdF9idWlsZF9udW1iZXIsIDEwICk7XG4gICAgICAgICAgY29uc3QgYnVpbGRzID0gWyAwLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMCBdLm1hcCggeCA9PiBsYXN0IC0geCApLmZpbHRlciggeCA9PiB4ID49IDAgKTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHtzbHVnfWAsXG4gICAgICAgICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7c2x1Z31gLFxuICAgICAgICAgICAgYnVpbGRzX3VybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z30vYnVpbGRzez9udW1iZXIsYWZ0ZXJfbnVtYmVyfWAsXG4gICAgICAgICAgICBidWlsZHM6IGJ1aWxkcyxcbiAgICAgICAgICAgIGRhdGE6IHJlcG9cbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRzKGJ1aWxkZXIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYnVpbGRlci5idWlsZHMubWFwKGZ1bmN0aW9uIChudW1iZXIpIHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoIGJ1aWxkZXIuYnVpbGRzX3VybCApO1xuICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSk7XG4gICAgfSkpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgIGNvbnN0IGJ1aWxkcyA9IFtdLmNvbmNhdC5hcHBseSggW10sIGRhdGEubWFwKGRhdGEgPT4gZGF0YS5idWlsZHMpICk7XG5cbiAgICAgIHJldHVybiBidWlsZHMubWFwKGZ1bmN0aW9uIChidWlsZCkge1xuICAgICAgICBjb25zdCBidWlsZGluZyA9IFRSQVZJU19TVEFURV9NQVBbIGJ1aWxkLnN0YXRlIF0gPT09IFBFTkRJTkc7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBidWlsZGVyLm5hbWUsXG4gICAgICAgICAgbnVtYmVyOiBwYXJzZUludChidWlsZC5udW1iZXIsIDEwKSxcbiAgICAgICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9LyR7YnVpbGRlci5uYW1lfS9idWlsZHMvJHtidWlsZC5pZH1gLFxuICAgICAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHthY2NvdW50fS8ke2J1aWxkZXIubmFtZX0vYnVpbGRzLyR7YnVpbGQuaWR9YCxcbiAgICAgICAgICBzdGF0ZTogVFJBVklTX1NUQVRFX01BUFsgYnVpbGQuc3RhdGUgXSxcbiAgICAgICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQuc3RhcnRlZF9hdCksXG4gICAgICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC5maW5pc2hlZF9hdCksXG4gICAgICAgICAgZGF0YTogYnVpbGRcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRJbmZvLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkc1xuICB9O1xufVxuIl19