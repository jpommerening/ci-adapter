'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _adapter = require('./adapter');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.2+json';
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _adapter.PENDING,
  created: _adapter.PENDING,
  queued: _adapter.PENDING,
  started: _adapter.PENDING,
  passed: _adapter.SUCCESS,
  failed: _adapter.FAILURE,
  errored: _adapter.ERRORED,
  canceled: _adapter.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  var headers = Object.assign({
    Accept: TRAVIS_MEDIA_TYPE
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);

  function getToken() {
    return (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    });
  }

  function getInfo() {
    return getToken().then(function (token) {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(function (response) {
      return response.json();
    }).then(function (data) {
      return {
        name: 'Travis CI - ' + account + ' (' + endpoint + ')',
        url: endpoint + '/repos/' + account,
        html_url: html_url + '/' + account,
        builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
        builders: data.repos.map(function (repo) {
          return repo.slug.split('/')[1];
        }),
        data: data
      };
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var repos = info.data.repos.filter(function (repo) {
        return repo.last_build_number !== null;
      });
      return repos.map(function (repo) {
        var slug = repo.slug;
        var name = slug.split('/')[1];
        var last = parseInt(repo.last_build_number, 10);
        var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(function (x) {
          return last - x;
        }).filter(function (x) {
          return x >= 0;
        });

        return {
          name: name,
          url: endpoint + '/repos/' + slug,
          html_url: html_url + '/' + slug,
          builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
          builds: builds,
          data: repo
        };
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(function (response) {
        return response.json();
      });
    })).then(function (data) {
      var builds = [].concat.apply([], data.map(function (data) {
        return data.builds;
      }));

      return builds.map(function (build) {
        var building = TRAVIS_STATE_MAP[build.state] === _adapter.PENDING;

        return {
          name: builder.name,
          number: parseInt(build.number, 10),
          url: endpoint + '/repos/' + account + '/' + builder.name + '/builds/' + build.id,
          html_url: html_url + '/' + account + '/' + builder.name + '/builds/' + build.id,
          state: TRAVIS_STATE_MAP[build.state],
          start: new Date(build.started_at),
          end: building ? null : new Date(build.finished_at),
          data: build
        };
      });
    });
  }

  return {
    getInfo: getInfo,
    getBuilders: getBuilders,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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RUFBRSxFQUFFLENBQUM7QUFDbEMsYUFBRyxFQUFLLFFBQVEsZUFBVSxPQUFPLFNBQUksT0FBTyxDQUFDLElBQUksZ0JBQVcsS0FBSyxDQUFDLEVBQUUsQUFBRTtBQUN0RSxrQkFBUSxFQUFLLFFBQVEsU0FBSSxPQUFPLFNBQUksT0FBTyxDQUFDLElBQUksZ0JBQVcsS0FBSyxDQUFDLEVBQUUsQUFBRTtBQUNyRSxlQUFLLEVBQUUsZ0JBQWdCLENBQUUsS0FBSyxDQUFDLEtBQUssQ0FBRTtBQUN0QyxlQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztBQUNqQyxhQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDO0FBQ2xELGNBQUksRUFBRSxLQUFLO1NBQ1osQ0FBQztPQUNILENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQztHQUNKOztBQUVELFNBQU87QUFDTCxXQUFPLEVBQVAsT0FBTztBQUNQLGVBQVcsRUFBWCxXQUFXO0FBQ1gsYUFBUyxFQUFULFNBQVM7R0FDVixDQUFDO0NBQ0giLCJmaWxlIjoidHJhdmlzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZldGNoIGZyb20gJy4vZmV0Y2gnO1xuaW1wb3J0IHVybHRlbXBsYXRlIGZyb20gJ3VybC10ZW1wbGF0ZSc7XG5pbXBvcnQgeyBQRU5ESU5HLCBTVUNDRVNTLCBGQUlMVVJFLCBFUlJPUkVELCBBQk9SVEVELCBVTktOT1dOIH0gZnJvbSAnLi9hZGFwdGVyJztcblxuY29uc3QgVFJBVklTX01FRElBX1RZUEUgPSAnYXBwbGljYXRpb24vdm5kLnRyYXZpcy1jaS4yK2pzb24nO1xuY29uc3QgVFJBVklTX0hUTUxfVVJMID0gL14oaHR0cHM/OlxcL1xcLykoYXBpXFwuKHRyYXZpcy1jaVxcLihvcmd8Y29tKSl8KFteXFwvXSspXFwvYXBpKShcXC8uKyk/JC87XG5jb25zdCBUUkFWSVNfU1RBVEVfTUFQID0ge1xuICByZWNlaXZlZDogUEVORElORyxcbiAgY3JlYXRlZDogUEVORElORyxcbiAgcXVldWVkOiBQRU5ESU5HLFxuICBzdGFydGVkOiBQRU5ESU5HLFxuICBwYXNzZWQ6IFNVQ0NFU1MsXG4gIGZhaWxlZDogRkFJTFVSRSxcbiAgZXJyb3JlZDogRVJST1JFRCxcbiAgY2FuY2VsZWQ6IEFCT1JURURcbn07XG5cbmZ1bmN0aW9uIGdldEh0bWxVcmwodXJsKSB7XG4gIGNvbnN0IG1hdGNoID0gVFJBVklTX0hUTUxfVVJMLmV4ZWModXJsKTtcbiAgcmV0dXJuIG1hdGNoWzFdICsgKG1hdGNoWzNdIHx8IG1hdGNoWzVdKSArIChtYXRjaFs2XSB8fCAnJyk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIFRyYXZpcyhlbmRwb2ludCwgeyBoZWFkZXJzOiBoLCBnaXRodWJfdG9rZW4sIGFjY291bnQgfSA9IHt9KSB7XG4gIGNvbnN0IGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKCB7XG4gICAgQWNjZXB0OiBUUkFWSVNfTUVESUFfVFlQRVxuICB9LCBoICk7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgaGVhZGVyc1xuICB9O1xuICBjb25zdCBodG1sX3VybCA9IGdldEh0bWxVcmwoZW5kcG9pbnQpO1xuXG4gIGZ1bmN0aW9uIGdldFRva2VuKCkge1xuICAgIHJldHVybiBmZXRjaChgJHtlbmRwb2ludH0vYXV0aC9naXRodWJgLCB7XG4gICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZ2l0aHViX3Rva2VuIH0pXG4gICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgfSkudGhlbihmdW5jdGlvbiAoeyBhY2Nlc3NfdG9rZW4gfSkge1xuICAgICAgb3B0aW9ucy5oZWFkZXJzWyAnQXV0aG9yaXphdGlvbicgXSA9IGB0b2tlbiAke2FjY2Vzc190b2tlbn1gO1xuICAgICAgcmV0dXJuIGFjY2Vzc190b2tlbjtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIGdldFRva2VuKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uKHRva2VuKSB7XG4gICAgICAgIHJldHVybiBmZXRjaChgJHtlbmRwb2ludH0vcmVwb3MvJHthY2NvdW50fWAsIG9wdGlvbnMpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBgVHJhdmlzIENJIC0gJHthY2NvdW50fSAoJHtlbmRwb2ludH0pYCxcbiAgICAgICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9YCxcbiAgICAgICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7YWNjb3VudH1gLFxuICAgICAgICAgIGJ1aWxkZXJzX3VybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH17L25hbWV9ez9pZHN9YCxcbiAgICAgICAgICBidWlsZGVyczogZGF0YS5yZXBvcy5tYXAocmVwbyA9PiByZXBvLnNsdWcuc3BsaXQoJy8nKVsxXSksXG4gICAgICAgICAgZGF0YTogZGF0YVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZGVycygpIHtcbiAgICByZXR1cm4gZ2V0SW5mbygpXG4gICAgICAudGhlbihmdW5jdGlvbiAoaW5mbykge1xuICAgICAgICBjb25zdCByZXBvcyA9IGluZm8uZGF0YS5yZXBvcy5maWx0ZXIocmVwbyA9PiByZXBvLmxhc3RfYnVpbGRfbnVtYmVyICE9PSBudWxsKTtcbiAgICAgICAgcmV0dXJuIHJlcG9zLm1hcChmdW5jdGlvbiAocmVwbykge1xuICAgICAgICAgIGNvbnN0IHNsdWcgPSByZXBvLnNsdWc7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IHNsdWcuc3BsaXQoJy8nKVsxXTtcbiAgICAgICAgICBjb25zdCBsYXN0ID0gcGFyc2VJbnQoIHJlcG8ubGFzdF9idWlsZF9udW1iZXIsIDEwICk7XG4gICAgICAgICAgY29uc3QgYnVpbGRzID0gWyAwLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMCBdLm1hcCggeCA9PiBsYXN0IC0geCApLmZpbHRlciggeCA9PiB4ID49IDAgKTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHtzbHVnfWAsXG4gICAgICAgICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7c2x1Z31gLFxuICAgICAgICAgICAgYnVpbGRzX3VybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z30vYnVpbGRzez9udW1iZXIsYWZ0ZXJfbnVtYmVyfWAsXG4gICAgICAgICAgICBidWlsZHM6IGJ1aWxkcyxcbiAgICAgICAgICAgIGRhdGE6IHJlcG9cbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRzKGJ1aWxkZXIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYnVpbGRlci5idWlsZHMubWFwKGZ1bmN0aW9uIChudW1iZXIpIHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoIGJ1aWxkZXIuYnVpbGRzX3VybCApO1xuICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSk7XG4gICAgfSkpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgIGNvbnN0IGJ1aWxkcyA9IFtdLmNvbmNhdC5hcHBseSggW10sIGRhdGEubWFwKGRhdGEgPT4gZGF0YS5idWlsZHMpICk7XG5cbiAgICAgIHJldHVybiBidWlsZHMubWFwKGZ1bmN0aW9uIChidWlsZCkge1xuICAgICAgICBjb25zdCBidWlsZGluZyA9IFRSQVZJU19TVEFURV9NQVBbIGJ1aWxkLnN0YXRlIF0gPT09IFBFTkRJTkc7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiBidWlsZGVyLm5hbWUsXG4gICAgICAgICAgbnVtYmVyOiBwYXJzZUludChidWlsZC5udW1iZXIsIDEwKSxcbiAgICAgICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9LyR7YnVpbGRlci5uYW1lfS9idWlsZHMvJHtidWlsZC5pZH1gLFxuICAgICAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHthY2NvdW50fS8ke2J1aWxkZXIubmFtZX0vYnVpbGRzLyR7YnVpbGQuaWR9YCxcbiAgICAgICAgICBzdGF0ZTogVFJBVklTX1NUQVRFX01BUFsgYnVpbGQuc3RhdGUgXSxcbiAgICAgICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQuc3RhcnRlZF9hdCksXG4gICAgICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC5maW5pc2hlZF9hdCksXG4gICAgICAgICAgZGF0YTogYnVpbGRcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRJbmZvLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkc1xuICB9O1xufVxuIl19