'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _util = require('util');

var _adapter = require('./adapter');

var _util2 = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _instanceof(left, right) { if (right != null && right[Symbol.hasInstance]) { return right[Symbol.hasInstance](left); } else { return left instanceof right; } }

var TRAVIS_API_VERSION = 2;
var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.' + TRAVIS_API_VERSION + '+json';
var TRAVIS_USER_AGENT = 'Travis/' + TRAVIS_API_VERSION + ' ' + _constants.USER_AGENT;
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _constants.PENDING,
  created: _constants.PENDING,
  queued: _constants.PENDING,
  started: _constants.PENDING,
  passed: _constants.SUCCESS,
  failed: _constants.FAILURE,
  errored: _constants.ERRORED,
  canceled: _constants.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

(0, _util.inherits)(Travis, _adapter.Adapter);

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  if (!_instanceof(this, Travis)) {
    return new Travis(endpoint, { headers: h, github_token: github_token, account: account });
  }

  var headers = Object.assign({
    'Accept': TRAVIS_MEDIA_TYPE,
    'User-Agent': TRAVIS_USER_AGENT
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);
  var token = undefined;

  _adapter.Adapter.call(this);

  this.getInfo = getInfo;
  this.getBuilder = getBuilder;
  this.getBuild = getBuild;
  this.getBuilders = getBuilders;

  function getToken(github_token) {
    return token || (token = (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: Object.assign({}, options.headers, {
        'Content-Type': 'application/json'
      }),
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      if (response.status !== 200) {
        return response.text().then(function (text) {
          return Promise.reject(new Error(text));
        });
      }
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    }));
  }

  function getInfo() {
    return (github_token ? getToken(github_token) : Promise.resolve(null)).then(function () {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(_util2.handleResponse).then(makeInfo);
  }

  function getBuilder(info, name) {
    var repo = info.data.repos.find(function (repo) {
      return repo.slug.split('/').pop() === name;
    });
    return makeBuilder(repo);
  }

  function getBuild(builder, number) {
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ number: number });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(function (data) {
      return makeBuild(builder.data, data.builds[0]);
    });
  }

  function getBuilders(info) {
    var repos = info.data.repos.filter(function (repo) {
      return info.builders.indexOf(repo.slug.split('/').pop()) >= 0;
    });
    return Promise.all(repos.map(makeBuilder));
  }

  function makeInfo(data) {
    var name = 'Travis CI - ' + account + ' (' + endpoint + ')';
    var builders = data.repos.filter(function (repo) {
      return repo.last_build_number;
    }).map(function (repo) {
      return repo.slug.split('/')[1];
    });

    return {
      name: name,
      url: endpoint + '/repos/' + account,
      html_url: html_url + '/' + account,
      builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(repo) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var last = parseInt(repo.last_build_number, 10);
    var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9].map(function (n) {
      return last - n;
    }).filter(function (n) {
      return n > 0;
    });
    var data = repo;

    return {
      name: name,
      url: endpoint + '/repos/' + slug,
      html_url: html_url + '/' + slug,
      builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(repo, build) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var number = parseInt(build.number, 10);
    var building = TRAVIS_STATE_MAP[build.state] === _constants.PENDING;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/repos/' + slug + '/builds/' + build.id,
      html_url: html_url + '/' + slug + '/builds/' + build.id,
      state: TRAVIS_STATE_MAP[build.state],
      start: new Date(build.started_at),
      end: building ? null : new Date(build.finished_at),
      data: data
    };
  }
}
//# sourceMappingURL=data:application/json;base64,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O0FBQzlCLFFBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDdkIsUUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNuQyxRQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztBQUMxQyxRQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBRSxLQUFLLENBQUMsS0FBSyxDQUFFLGdCQWpJM0MsT0FBTyxBQWlJZ0QsQ0FBQztBQUM3RCxRQUFNLElBQUksR0FBRyxLQUFLLENBQUM7O0FBRW5CLFdBQU87QUFDTCxVQUFJLEVBQUosSUFBSTtBQUNKLFlBQU0sRUFBTixNQUFNO0FBQ04sU0FBRyxFQUFLLFFBQVEsZUFBVSxJQUFJLGdCQUFXLEtBQUssQ0FBQyxFQUFFLEFBQUU7QUFDbkQsY0FBUSxFQUFLLFFBQVEsU0FBSSxJQUFJLGdCQUFXLEtBQUssQ0FBQyxFQUFFLEFBQUU7QUFDbEQsV0FBSyxFQUFFLGdCQUFnQixDQUFFLEtBQUssQ0FBQyxLQUFLLENBQUU7QUFDdEMsV0FBSyxFQUFFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7QUFDakMsU0FBRyxFQUFFLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztBQUNsRCxVQUFJLEVBQUosSUFBSTtLQUNMLENBQUM7R0FDSDtDQUNGIiwiZmlsZSI6InRyYXZpcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IGZldGNoIGZyb20gJy4vZmV0Y2gnO1xuaW1wb3J0IHsgaW5oZXJpdHMgfSBmcm9tICd1dGlsJztcbmltcG9ydCB7IEFkYXB0ZXIgfSBmcm9tICcuL2FkYXB0ZXInO1xuaW1wb3J0IHsgaGFuZGxlUmVzcG9uc2UgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgRkFJTFVSRSwgRVJST1JFRCwgQUJPUlRFRCwgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgVFJBVklTX0FQSV9WRVJTSU9OID0gMjtcbmNvbnN0IFRSQVZJU19NRURJQV9UWVBFID0gYGFwcGxpY2F0aW9uL3ZuZC50cmF2aXMtY2kuJHtUUkFWSVNfQVBJX1ZFUlNJT059K2pzb25gO1xuY29uc3QgVFJBVklTX1VTRVJfQUdFTlQgPSBgVHJhdmlzLyR7VFJBVklTX0FQSV9WRVJTSU9OfSAke1VTRVJfQUdFTlR9YDtcbmNvbnN0IFRSQVZJU19IVE1MX1VSTCA9IC9eKGh0dHBzPzpcXC9cXC8pKGFwaVxcLih0cmF2aXMtY2lcXC4ob3JnfGNvbSkpfChbXlxcL10rKVxcL2FwaSkoXFwvLispPyQvO1xuY29uc3QgVFJBVklTX1NUQVRFX01BUCA9IHtcbiAgcmVjZWl2ZWQ6IFBFTkRJTkcsXG4gIGNyZWF0ZWQ6IFBFTkRJTkcsXG4gIHF1ZXVlZDogUEVORElORyxcbiAgc3RhcnRlZDogUEVORElORyxcbiAgcGFzc2VkOiBTVUNDRVNTLFxuICBmYWlsZWQ6IEZBSUxVUkUsXG4gIGVycm9yZWQ6IEVSUk9SRUQsXG4gIGNhbmNlbGVkOiBBQk9SVEVEXG59O1xuXG5mdW5jdGlvbiBnZXRIdG1sVXJsKHVybCkge1xuICBjb25zdCBtYXRjaCA9IFRSQVZJU19IVE1MX1VSTC5leGVjKHVybCk7XG4gIHJldHVybiBtYXRjaFsxXSArIChtYXRjaFszXSB8fCBtYXRjaFs1XSkgKyAobWF0Y2hbNl0gfHwgJycpO1xufVxuXG5pbmhlcml0cyhUcmF2aXMsIEFkYXB0ZXIpO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBUcmF2aXMoZW5kcG9pbnQsIHsgaGVhZGVyczogaCwgZ2l0aHViX3Rva2VuLCBhY2NvdW50IH0gPSB7fSkge1xuICBpZiAoISh0aGlzIGluc3RhbmNlb2YgVHJhdmlzKSkge1xuICAgIHJldHVybiBuZXcgVHJhdmlzKGVuZHBvaW50LCB7IGhlYWRlcnM6IGgsIGdpdGh1Yl90b2tlbiwgYWNjb3VudCB9KTtcbiAgfVxuXG4gIGNvbnN0IGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAnQWNjZXB0JzogVFJBVklTX01FRElBX1RZUEUsXG4gICAgJ1VzZXItQWdlbnQnOiBUUkFWSVNfVVNFUl9BR0VOVFxuICB9LCBoKTtcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBoZWFkZXJzXG4gIH07XG4gIGNvbnN0IGh0bWxfdXJsID0gZ2V0SHRtbFVybChlbmRwb2ludCk7XG4gIGxldCB0b2tlbjtcblxuICBBZGFwdGVyLmNhbGwodGhpcyk7XG5cbiAgdGhpcy5nZXRJbmZvID0gZ2V0SW5mbztcbiAgdGhpcy5nZXRCdWlsZGVyID0gZ2V0QnVpbGRlcjtcbiAgdGhpcy5nZXRCdWlsZCA9IGdldEJ1aWxkO1xuICB0aGlzLmdldEJ1aWxkZXJzID0gZ2V0QnVpbGRlcnM7XG5cbiAgZnVuY3Rpb24gZ2V0VG9rZW4oZ2l0aHViX3Rva2VuKSB7XG4gICAgcmV0dXJuIHRva2VuIHx8ICh0b2tlbiA9IGZldGNoKGAke2VuZHBvaW50fS9hdXRoL2dpdGh1YmAsIHtcbiAgICAgIG1ldGhvZDogJ3Bvc3QnLFxuICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5oZWFkZXJzLCB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgIH0pLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBnaXRodWJfdG9rZW4gfSlcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS50ZXh0KCkudGhlbih0ZXh0ID0+IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcih0ZXh0KSkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICB9KS50aGVuKGZ1bmN0aW9uICh7IGFjY2Vzc190b2tlbiB9KSB7XG4gICAgICBvcHRpb25zLmhlYWRlcnNbICdBdXRob3JpemF0aW9uJyBdID0gYHRva2VuICR7YWNjZXNzX3Rva2VufWA7XG4gICAgICByZXR1cm4gYWNjZXNzX3Rva2VuO1xuICAgIH0pKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIChnaXRodWJfdG9rZW4gPyBnZXRUb2tlbihnaXRodWJfdG9rZW4pIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpKVxuICAgICAgLnRoZW4oKCkgPT4gZmV0Y2goYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH1gLCBvcHRpb25zKSlcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihpbmZvLCBuYW1lKSB7XG4gICAgY29uc3QgcmVwbyA9IGluZm8uZGF0YS5yZXBvcy5maW5kKHJlcG8gPT4gcmVwby5zbHVnLnNwbGl0KCcvJykucG9wKCkgPT09IG5hbWUpO1xuICAgIHJldHVybiBtYWtlQnVpbGRlcihyZXBvKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkKGJ1aWxkZXIsIG51bWJlcikge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoYnVpbGRlci5idWlsZHNfdXJsKTtcbiAgICBjb25zdCB1cmwgPSB0ZW1wbGF0ZS5leHBhbmQoeyBudW1iZXIgfSk7XG5cbiAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKVxuICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAudGhlbihkYXRhID0+IG1ha2VCdWlsZChidWlsZGVyLmRhdGEsIGRhdGEuYnVpbGRzWzBdKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZGVycyhpbmZvKSB7XG4gICAgY29uc3QgcmVwb3MgPSBpbmZvLmRhdGEucmVwb3MuZmlsdGVyKHJlcG8gPT4gaW5mby5idWlsZGVycy5pbmRleE9mKHJlcG8uc2x1Zy5zcGxpdCgnLycpLnBvcCgpKSA+PSAwKTtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVwb3MubWFwKG1ha2VCdWlsZGVyKSk7XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlSW5mbyhkYXRhKSB7XG4gICAgY29uc3QgbmFtZSA9IGBUcmF2aXMgQ0kgLSAke2FjY291bnR9ICgke2VuZHBvaW50fSlgO1xuICAgIGNvbnN0IGJ1aWxkZXJzID0gZGF0YS5yZXBvc1xuICAgICAgLmZpbHRlcihyZXBvID0+IHJlcG8ubGFzdF9idWlsZF9udW1iZXIpXG4gICAgICAubWFwKHJlcG8gPT4gcmVwby5zbHVnLnNwbGl0KCcvJylbMV0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHthY2NvdW50fWAsXG4gICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9ey9uYW1lfXs/aWRzfWAsXG4gICAgICBidWlsZGVycyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkZXIocmVwbykge1xuICAgIGNvbnN0IHNsdWcgPSByZXBvLnNsdWc7XG4gICAgY29uc3QgbmFtZSA9IHNsdWcuc3BsaXQoJy8nKS5wb3AoKTtcbiAgICBjb25zdCBsYXN0ID0gcGFyc2VJbnQoIHJlcG8ubGFzdF9idWlsZF9udW1iZXIsIDEwICk7XG4gICAgY29uc3QgYnVpbGRzID0gWyAwLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5IF1cbiAgICAgIC5tYXAobiA9PiBsYXN0IC0gbilcbiAgICAgIC5maWx0ZXIobiA9PiBuID4gMCk7XG4gICAgY29uc3QgZGF0YSA9IHJlcG87XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z31gLFxuICAgICAgaHRtbF91cmw6IGAke2h0bWxfdXJsfS8ke3NsdWd9YCxcbiAgICAgIGJ1aWxkc191cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke3NsdWd9L2J1aWxkc3s/bnVtYmVyLGFmdGVyX251bWJlcn1gLFxuICAgICAgYnVpbGRzLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlQnVpbGQocmVwbywgYnVpbGQpIHtcbiAgICBjb25zdCBzbHVnID0gcmVwby5zbHVnO1xuICAgIGNvbnN0IG5hbWUgPSBzbHVnLnNwbGl0KCcvJykucG9wKCk7XG4gICAgY29uc3QgbnVtYmVyID0gcGFyc2VJbnQoYnVpbGQubnVtYmVyLCAxMCk7XG4gICAgY29uc3QgYnVpbGRpbmcgPSBUUkFWSVNfU1RBVEVfTUFQWyBidWlsZC5zdGF0ZSBdID09PSBQRU5ESU5HO1xuICAgIGNvbnN0IGRhdGEgPSBidWlsZDtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgbnVtYmVyLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHtzbHVnfS9idWlsZHMvJHtidWlsZC5pZH1gLFxuICAgICAgaHRtbF91cmw6IGAke2h0bWxfdXJsfS8ke3NsdWd9L2J1aWxkcy8ke2J1aWxkLmlkfWAsXG4gICAgICBzdGF0ZTogVFJBVklTX1NUQVRFX01BUFsgYnVpbGQuc3RhdGUgXSxcbiAgICAgIHN0YXJ0OiBuZXcgRGF0ZShidWlsZC5zdGFydGVkX2F0KSxcbiAgICAgIGVuZDogYnVpbGRpbmcgPyBudWxsIDogbmV3IERhdGUoYnVpbGQuZmluaXNoZWRfYXQpLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cbn1cbiJdfQ==