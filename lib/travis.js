'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _util = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TRAVIS_API_VERSION = 2;
var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.' + TRAVIS_API_VERSION + '+json';
var TRAVIS_USER_AGENT = 'Travis/' + TRAVIS_API_VERSION + ' ' + _constants.USER_AGENT;
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _constants.PENDING,
  created: _constants.PENDING,
  queued: _constants.PENDING,
  started: _constants.PENDING,
  passed: _constants.SUCCESS,
  failed: _constants.FAILURE,
  errored: _constants.ERRORED,
  canceled: _constants.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  var headers = Object.assign({
    'Accept': TRAVIS_MEDIA_TYPE,
    'User-Agent': TRAVIS_USER_AGENT
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);
  var token = undefined;

  function getToken(github_token) {
    return token || (token = (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: Object.assign({}, options.headers, {
        'Content-Type': 'application/json'
      }),
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      if (response.status !== 200) {
        return response.text().then(function (text) {
          return Promise.reject(new Error(text));
        });
      }
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    }));
  }

  function getInfo() {
    return (github_token ? getToken(github_token) : Promise.resolve(null)).then(function () {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(_util.handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var repo = info.data.repos.find(function (repo) {
        return repo.slug.split('/').pop() === name;
      });
      return makeBuilder(repo);
    });
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(function (data) {
        return makeBuild(builder.data, data.builds[0]);
      });
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var repos = info.data.repos.filter(function (repo) {
        return info.builders.indexOf(repo.slug.split('/').pop() >= 0);
      });
      return repos.map(makeBuilder);
    });
  }

  function getBuilds(name) {
    return getBuilder(name).then(function (builder) {
      return Promise.all(builder.builds.map(function (number) {
        return getBuild(name, number);
      }));
    });
  }

  function makeInfo(data) {
    var name = 'Travis CI - ' + account + ' (' + endpoint + ')';
    var builders = data.repos.filter(function (repo) {
      return repo.last_build_number !== null;
    }).map(function (repo) {
      return repo.slug.split('/')[1];
    });

    return {
      name: name,
      url: endpoint + '/repos/' + account,
      html_url: html_url + '/' + account,
      builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(repo) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var last = parseInt(repo.last_build_number, 10);
    var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(function (x) {
      return last - x;
    }).filter(function (x) {
      return x >= 0;
    });
    var data = repo;

    return {
      name: name,
      url: endpoint + '/repos/' + slug,
      html_url: html_url + '/' + slug,
      builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(repo, build) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var number = parseInt(build.number, 10);
    var building = TRAVIS_STATE_MAP[build.state] === _constants.PENDING;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/repos/' + slug + '/builds/' + build.id,
      html_url: html_url + '/' + slug + '/builds/' + build.id,
      state: TRAVIS_STATE_MAP[build.state],
      start: new Date(build.started_at),
      end: building ? null : new Date(build.finished_at),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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O0FBQzlCLFFBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDdkIsUUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNuQyxRQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztBQUMxQyxRQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBRSxLQUFLLENBQUMsS0FBSyxDQUFFLGdCQWxJM0MsT0FBTyxBQWtJZ0QsQ0FBQztBQUM3RCxRQUFNLElBQUksR0FBRyxLQUFLLENBQUM7O0FBRW5CLFdBQU87QUFDTCxVQUFJLEVBQUosSUFBSTtBQUNKLFlBQU0sRUFBTixNQUFNO0FBQ04sU0FBRyxFQUFLLFFBQVEsZUFBVSxJQUFJLGdCQUFXLEtBQUssQ0FBQyxFQUFFLEFBQUU7QUFDbkQsY0FBUSxFQUFLLFFBQVEsU0FBSSxJQUFJLGdCQUFXLEtBQUssQ0FBQyxFQUFFLEFBQUU7QUFDbEQsV0FBSyxFQUFFLGdCQUFnQixDQUFFLEtBQUssQ0FBQyxLQUFLLENBQUU7QUFDdEMsV0FBSyxFQUFFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7QUFDakMsU0FBRyxFQUFFLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztBQUNsRCxVQUFJLEVBQUosSUFBSTtLQUNMLENBQUM7R0FDSDs7QUFFRCxTQUFPO0FBQ0wsV0FBTyxFQUFQLE9BQU87QUFDUCxjQUFVLEVBQVYsVUFBVTtBQUNWLGVBQVcsRUFBWCxXQUFXO0FBQ1gsWUFBUSxFQUFSLFFBQVE7QUFDUixhQUFTLEVBQVQsU0FBUztHQUNWLENBQUM7Q0FDSCIsImZpbGUiOiJ0cmF2aXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnLi9mZXRjaCc7XG5pbXBvcnQgdXJsdGVtcGxhdGUgZnJvbSAndXJsLXRlbXBsYXRlJztcbmltcG9ydCB7IGhhbmRsZVJlc3BvbnNlIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IFBFTkRJTkcsIFNVQ0NFU1MsIEZBSUxVUkUsIEVSUk9SRUQsIEFCT1JURUQsIFVOS05PV04sIFVTRVJfQUdFTlQgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbmNvbnN0IFRSQVZJU19BUElfVkVSU0lPTiA9IDI7XG5jb25zdCBUUkFWSVNfTUVESUFfVFlQRSA9IGBhcHBsaWNhdGlvbi92bmQudHJhdmlzLWNpLiR7VFJBVklTX0FQSV9WRVJTSU9OfStqc29uYDtcbmNvbnN0IFRSQVZJU19VU0VSX0FHRU5UID0gYFRyYXZpcy8ke1RSQVZJU19BUElfVkVSU0lPTn0gJHtVU0VSX0FHRU5UfWA7XG5jb25zdCBUUkFWSVNfSFRNTF9VUkwgPSAvXihodHRwcz86XFwvXFwvKShhcGlcXC4odHJhdmlzLWNpXFwuKG9yZ3xjb20pKXwoW15cXC9dKylcXC9hcGkpKFxcLy4rKT8kLztcbmNvbnN0IFRSQVZJU19TVEFURV9NQVAgPSB7XG4gIHJlY2VpdmVkOiBQRU5ESU5HLFxuICBjcmVhdGVkOiBQRU5ESU5HLFxuICBxdWV1ZWQ6IFBFTkRJTkcsXG4gIHN0YXJ0ZWQ6IFBFTkRJTkcsXG4gIHBhc3NlZDogU1VDQ0VTUyxcbiAgZmFpbGVkOiBGQUlMVVJFLFxuICBlcnJvcmVkOiBFUlJPUkVELFxuICBjYW5jZWxlZDogQUJPUlRFRFxufTtcblxuZnVuY3Rpb24gZ2V0SHRtbFVybCh1cmwpIHtcbiAgY29uc3QgbWF0Y2ggPSBUUkFWSVNfSFRNTF9VUkwuZXhlYyh1cmwpO1xuICByZXR1cm4gbWF0Y2hbMV0gKyAobWF0Y2hbM10gfHwgbWF0Y2hbNV0pICsgKG1hdGNoWzZdIHx8ICcnKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gVHJhdmlzKGVuZHBvaW50LCB7IGhlYWRlcnM6IGgsIGdpdGh1Yl90b2tlbiwgYWNjb3VudCB9ID0ge30pIHtcbiAgY29uc3QgaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICdBY2NlcHQnOiBUUkFWSVNfTUVESUFfVFlQRSxcbiAgICAnVXNlci1BZ2VudCc6IFRSQVZJU19VU0VSX0FHRU5UXG4gIH0sIGgpO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcbiAgY29uc3QgaHRtbF91cmwgPSBnZXRIdG1sVXJsKGVuZHBvaW50KTtcbiAgbGV0IHRva2VuO1xuXG4gIGZ1bmN0aW9uIGdldFRva2VuKGdpdGh1Yl90b2tlbikge1xuICAgIHJldHVybiB0b2tlbiB8fCAodG9rZW4gPSBmZXRjaChgJHtlbmRwb2ludH0vYXV0aC9naXRodWJgLCB7XG4gICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMuaGVhZGVycywge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICB9KSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZ2l0aHViX3Rva2VuIH0pXG4gICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UudGV4dCgpLnRoZW4odGV4dCA9PiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IodGV4dCkpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgfSkudGhlbihmdW5jdGlvbiAoeyBhY2Nlc3NfdG9rZW4gfSkge1xuICAgICAgb3B0aW9ucy5oZWFkZXJzWyAnQXV0aG9yaXphdGlvbicgXSA9IGB0b2tlbiAke2FjY2Vzc190b2tlbn1gO1xuICAgICAgcmV0dXJuIGFjY2Vzc190b2tlbjtcbiAgICB9KSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRJbmZvKCkge1xuICAgIHJldHVybiAoZ2l0aHViX3Rva2VuID8gZ2V0VG9rZW4oZ2l0aHViX3Rva2VuKSA6IFByb21pc2UucmVzb2x2ZShudWxsKSlcbiAgICAgIC50aGVuKCgpID0+IGZldGNoKGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9YCwgb3B0aW9ucykpXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKG1ha2VJbmZvKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXIobmFtZSkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHJlcG8gPSBpbmZvLmRhdGEucmVwb3MuZmluZChyZXBvID0+IHJlcG8uc2x1Zy5zcGxpdCgnLycpLnBvcCgpID09PSBuYW1lKTtcbiAgICAgICAgcmV0dXJuIG1ha2VCdWlsZGVyKHJlcG8pO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZChuYW1lLCBudW1iZXIpIHtcbiAgICByZXR1cm4gZ2V0QnVpbGRlcihuYW1lKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGJ1aWxkZXIpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShidWlsZGVyLmJ1aWxkc191cmwpO1xuICAgICAgICBjb25zdCB1cmwgPSB0ZW1wbGF0ZS5leHBhbmQoeyBudW1iZXIgfSk7XG5cbiAgICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgICAgICAudGhlbihkYXRhID0+IG1ha2VCdWlsZChidWlsZGVyLmRhdGEsIGRhdGEuYnVpbGRzWzBdKSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKCkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHJlcG9zID0gaW5mby5kYXRhLnJlcG9zLmZpbHRlcihyZXBvID0+IGluZm8uYnVpbGRlcnMuaW5kZXhPZihyZXBvLnNsdWcuc3BsaXQoJy8nKS5wb3AoKSA+PSAwKSk7XG4gICAgICAgIHJldHVybiByZXBvcy5tYXAobWFrZUJ1aWxkZXIpO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZHMobmFtZSkge1xuICAgIHJldHVybiBnZXRCdWlsZGVyKG5hbWUpXG4gICAgICAudGhlbihidWlsZGVyID0+IFByb21pc2UuYWxsKGJ1aWxkZXIuYnVpbGRzLm1hcChudW1iZXIgPT4gZ2V0QnVpbGQobmFtZSwgbnVtYmVyKSkpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VJbmZvKGRhdGEpIHtcbiAgICBjb25zdCBuYW1lID0gYFRyYXZpcyBDSSAtICR7YWNjb3VudH0gKCR7ZW5kcG9pbnR9KWA7XG4gICAgY29uc3QgYnVpbGRlcnMgPSBkYXRhLnJlcG9zXG4gICAgICAuZmlsdGVyKHJlcG8gPT4gcmVwby5sYXN0X2J1aWxkX251bWJlciAhPT0gbnVsbClcbiAgICAgIC5tYXAocmVwbyA9PiByZXBvLnNsdWcuc3BsaXQoJy8nKVsxXSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH1gLFxuICAgICAgaHRtbF91cmw6IGAke2h0bWxfdXJsfS8ke2FjY291bnR9YCxcbiAgICAgIGJ1aWxkZXJzX3VybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH17L25hbWV9ez9pZHN9YCxcbiAgICAgIGJ1aWxkZXJzLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlQnVpbGRlcihyZXBvKSB7XG4gICAgY29uc3Qgc2x1ZyA9IHJlcG8uc2x1ZztcbiAgICBjb25zdCBuYW1lID0gc2x1Zy5zcGxpdCgnLycpLnBvcCgpO1xuICAgIGNvbnN0IGxhc3QgPSBwYXJzZUludCggcmVwby5sYXN0X2J1aWxkX251bWJlciwgMTAgKTtcbiAgICBjb25zdCBidWlsZHMgPSBbIDAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDksIDEwIF1cbiAgICAgIC5tYXAoeCA9PiBsYXN0IC0geClcbiAgICAgIC5maWx0ZXIoeCA9PiB4ID49IDApO1xuICAgIGNvbnN0IGRhdGEgPSByZXBvO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke3NsdWd9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHtzbHVnfWAsXG4gICAgICBidWlsZHNfdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHtzbHVnfS9idWlsZHN7P251bWJlcixhZnRlcl9udW1iZXJ9YCxcbiAgICAgIGJ1aWxkcyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkKHJlcG8sIGJ1aWxkKSB7XG4gICAgY29uc3Qgc2x1ZyA9IHJlcG8uc2x1ZztcbiAgICBjb25zdCBuYW1lID0gc2x1Zy5zcGxpdCgnLycpLnBvcCgpO1xuICAgIGNvbnN0IG51bWJlciA9IHBhcnNlSW50KGJ1aWxkLm51bWJlciwgMTApO1xuICAgIGNvbnN0IGJ1aWxkaW5nID0gVFJBVklTX1NUQVRFX01BUFsgYnVpbGQuc3RhdGUgXSA9PT0gUEVORElORztcbiAgICBjb25zdCBkYXRhID0gYnVpbGQ7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIG51bWJlcixcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z30vYnVpbGRzLyR7YnVpbGQuaWR9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHtzbHVnfS9idWlsZHMvJHtidWlsZC5pZH1gLFxuICAgICAgc3RhdGU6IFRSQVZJU19TVEFURV9NQVBbIGJ1aWxkLnN0YXRlIF0sXG4gICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQuc3RhcnRlZF9hdCksXG4gICAgICBlbmQ6IGJ1aWxkaW5nID8gbnVsbCA6IG5ldyBEYXRlKGJ1aWxkLmZpbmlzaGVkX2F0KSxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRJbmZvLFxuICAgIGdldEJ1aWxkZXIsXG4gICAgZ2V0QnVpbGRlcnMsXG4gICAgZ2V0QnVpbGQsXG4gICAgZ2V0QnVpbGRzXG4gIH07XG59XG4iXX0=