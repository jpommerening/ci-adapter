'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _util = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TRAVIS_API_VERSION = 2;
var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.' + TRAVIS_API_VERSION + '+json';
var TRAVIS_USER_AGENT = 'Travis/' + TRAVIS_API_VERSION + ' ' + _constants.USER_AGENT;
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _constants.PENDING,
  created: _constants.PENDING,
  queued: _constants.PENDING,
  started: _constants.PENDING,
  passed: _constants.SUCCESS,
  failed: _constants.FAILURE,
  errored: _constants.ERRORED,
  canceled: _constants.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  var headers = Object.assign({
    'Accept': TRAVIS_MEDIA_TYPE,
    'User-Agent': TRAVIS_USER_AGENT
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);
  var token = undefined;

  function getToken(github_token) {
    return token || (token = (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: Object.assign({}, options.headers, {
        'Content-Type': 'application/json'
      }),
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      if (response.status !== 200) {
        return response.text().then(function (text) {
          return Promise.reject(new Error(text));
        });
      }
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    }));
  }

  function getInfo() {
    return (github_token ? getToken(github_token) : Promise.resolve(null)).then(function () {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(_util.handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var repo = info.data.repos.find(function (repo) {
        return repo.slug.split('/').pop() === name;
      });
      return makeBuilder(repo);
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var repos = info.data.repos.filter(function (repo) {
        return info.builders.indexOf(repo.slug.split('/').pop() >= 0);
      });
      return repos.map(makeBuilder);
    });
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(function (data) {
        return makeBuild(builder.data, data.builds[0]);
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(function (response) {
        return response.json();
      });
    })).then(function (data) {
      var builds = [].concat.apply([], data.map(function (data) {
        return data.builds;
      }));

      return builds.map(function (data) {
        return makeBuild(builder.data, data);
      });
    });
  }

  function makeInfo(data) {
    var name = 'Travis CI - ' + account + ' (' + endpoint + ')';
    var builders = data.repos.filter(function (repo) {
      return repo.last_build_number !== null;
    }).map(function (repo) {
      return repo.slug.split('/')[1];
    });

    return {
      name: name,
      url: endpoint + '/repos/' + account,
      html_url: html_url + '/' + account,
      builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(repo) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var last = parseInt(repo.last_build_number, 10);
    var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(function (x) {
      return last - x;
    }).filter(function (x) {
      return x >= 0;
    });
    var data = repo;

    return {
      name: name,
      url: endpoint + '/repos/' + slug,
      html_url: html_url + '/' + slug,
      builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(repo, build) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var number = parseInt(build.number, 10);
    var building = TRAVIS_STATE_MAP[build.state] === _constants.PENDING;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/repos/' + slug + '/builds/' + build.id,
      html_url: html_url + '/' + slug + '/builds/' + build.id,
      state: TRAVIS_STATE_MAP[build.state],
      start: new Date(build.started_at),
      end: building ? null : new Date(build.finished_at),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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QUFLLEVBQUUsZ0JBQWdCLENBQUUsS0FBSyxDQUFDLEtBQUssQ0FBRTtBQUN0QyxXQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztBQUNqQyxTQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDO0FBQ2xELFVBQUksRUFBSixJQUFJO0tBQ0wsQ0FBQztHQUNIOztBQUVELFNBQU87QUFDTCxXQUFPLEVBQVAsT0FBTztBQUNQLGNBQVUsRUFBVixVQUFVO0FBQ1YsZUFBVyxFQUFYLFdBQVc7QUFDWCxZQUFRLEVBQVIsUUFBUTtBQUNSLGFBQVMsRUFBVCxTQUFTO0dBQ1YsQ0FBQztDQUNIIiwiZmlsZSI6InRyYXZpcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmZXRjaCBmcm9tICcuL2ZldGNoJztcbmltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IHsgaGFuZGxlUmVzcG9uc2UgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgRkFJTFVSRSwgRVJST1JFRCwgQUJPUlRFRCwgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgVFJBVklTX0FQSV9WRVJTSU9OID0gMjtcbmNvbnN0IFRSQVZJU19NRURJQV9UWVBFID0gYGFwcGxpY2F0aW9uL3ZuZC50cmF2aXMtY2kuJHtUUkFWSVNfQVBJX1ZFUlNJT059K2pzb25gO1xuY29uc3QgVFJBVklTX1VTRVJfQUdFTlQgPSBgVHJhdmlzLyR7VFJBVklTX0FQSV9WRVJTSU9OfSAke1VTRVJfQUdFTlR9YDtcbmNvbnN0IFRSQVZJU19IVE1MX1VSTCA9IC9eKGh0dHBzPzpcXC9cXC8pKGFwaVxcLih0cmF2aXMtY2lcXC4ob3JnfGNvbSkpfChbXlxcL10rKVxcL2FwaSkoXFwvLispPyQvO1xuY29uc3QgVFJBVklTX1NUQVRFX01BUCA9IHtcbiAgcmVjZWl2ZWQ6IFBFTkRJTkcsXG4gIGNyZWF0ZWQ6IFBFTkRJTkcsXG4gIHF1ZXVlZDogUEVORElORyxcbiAgc3RhcnRlZDogUEVORElORyxcbiAgcGFzc2VkOiBTVUNDRVNTLFxuICBmYWlsZWQ6IEZBSUxVUkUsXG4gIGVycm9yZWQ6IEVSUk9SRUQsXG4gIGNhbmNlbGVkOiBBQk9SVEVEXG59O1xuXG5mdW5jdGlvbiBnZXRIdG1sVXJsKHVybCkge1xuICBjb25zdCBtYXRjaCA9IFRSQVZJU19IVE1MX1VSTC5leGVjKHVybCk7XG4gIHJldHVybiBtYXRjaFsxXSArIChtYXRjaFszXSB8fCBtYXRjaFs1XSkgKyAobWF0Y2hbNl0gfHwgJycpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBUcmF2aXMoZW5kcG9pbnQsIHsgaGVhZGVyczogaCwgZ2l0aHViX3Rva2VuLCBhY2NvdW50IH0gPSB7fSkge1xuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgJ0FjY2VwdCc6IFRSQVZJU19NRURJQV9UWVBFLFxuICAgICdVc2VyLUFnZW50JzogVFJBVklTX1VTRVJfQUdFTlRcbiAgfSwgaCk7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgaGVhZGVyc1xuICB9O1xuICBjb25zdCBodG1sX3VybCA9IGdldEh0bWxVcmwoZW5kcG9pbnQpO1xuICBsZXQgdG9rZW47XG5cbiAgZnVuY3Rpb24gZ2V0VG9rZW4oZ2l0aHViX3Rva2VuKSB7XG4gICAgcmV0dXJuIHRva2VuIHx8ICh0b2tlbiA9IGZldGNoKGAke2VuZHBvaW50fS9hdXRoL2dpdGh1YmAsIHtcbiAgICAgIG1ldGhvZDogJ3Bvc3QnLFxuICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5oZWFkZXJzLCB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgIH0pLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBnaXRodWJfdG9rZW4gfSlcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS50ZXh0KCkudGhlbih0ZXh0ID0+IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcih0ZXh0KSkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICB9KS50aGVuKGZ1bmN0aW9uICh7IGFjY2Vzc190b2tlbiB9KSB7XG4gICAgICBvcHRpb25zLmhlYWRlcnNbICdBdXRob3JpemF0aW9uJyBdID0gYHRva2VuICR7YWNjZXNzX3Rva2VufWA7XG4gICAgICByZXR1cm4gYWNjZXNzX3Rva2VuO1xuICAgIH0pKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIChnaXRodWJfdG9rZW4gPyBnZXRUb2tlbihnaXRodWJfdG9rZW4pIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpKVxuICAgICAgLnRoZW4oKCkgPT4gZmV0Y2goYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH1gLCBvcHRpb25zKSlcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihuYW1lKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgcmVwbyA9IGluZm8uZGF0YS5yZXBvcy5maW5kKHJlcG8gPT4gcmVwby5zbHVnLnNwbGl0KCcvJykucG9wKCkgPT09IG5hbWUpO1xuICAgICAgICByZXR1cm4gbWFrZUJ1aWxkZXIocmVwbyk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKCkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHJlcG9zID0gaW5mby5kYXRhLnJlcG9zLmZpbHRlcihyZXBvID0+IGluZm8uYnVpbGRlcnMuaW5kZXhPZihyZXBvLnNsdWcuc3BsaXQoJy8nKS5wb3AoKSA+PSAwKSk7XG4gICAgICAgIHJldHVybiByZXBvcy5tYXAobWFrZUJ1aWxkZXIpO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZChuYW1lLCBudW1iZXIpIHtcbiAgICByZXR1cm4gZ2V0QnVpbGRlcihuYW1lKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGJ1aWxkZXIpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggYnVpbGRlci5idWlsZHNfdXJsICk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG51bWJlciB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKVxuICAgICAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgICAgIC50aGVuKGRhdGEgPT4gbWFrZUJ1aWxkKGJ1aWxkZXIuZGF0YSwgZGF0YS5idWlsZHNbMF0pKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRzKGJ1aWxkZXIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYnVpbGRlci5idWlsZHMubWFwKGZ1bmN0aW9uIChudW1iZXIpIHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoIGJ1aWxkZXIuYnVpbGRzX3VybCApO1xuICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSk7XG4gICAgfSkpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgIGNvbnN0IGJ1aWxkcyA9IFtdLmNvbmNhdC5hcHBseSggW10sIGRhdGEubWFwKGRhdGEgPT4gZGF0YS5idWlsZHMpICk7XG5cbiAgICAgIHJldHVybiBidWlsZHMubWFwKGRhdGEgPT4gbWFrZUJ1aWxkKGJ1aWxkZXIuZGF0YSwgZGF0YSkpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUluZm8oZGF0YSkge1xuICAgIGNvbnN0IG5hbWUgPSBgVHJhdmlzIENJIC0gJHthY2NvdW50fSAoJHtlbmRwb2ludH0pYDtcbiAgICBjb25zdCBidWlsZGVycyA9IGRhdGEucmVwb3NcbiAgICAgIC5maWx0ZXIocmVwbyA9PiByZXBvLmxhc3RfYnVpbGRfbnVtYmVyICE9PSBudWxsKVxuICAgICAgLm1hcChyZXBvID0+IHJlcG8uc2x1Zy5zcGxpdCgnLycpWzFdKTtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHthY2NvdW50fWAsXG4gICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7YWNjb3VudH1gLFxuICAgICAgYnVpbGRlcnNfdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHthY2NvdW50fXsvbmFtZX17P2lkc31gLFxuICAgICAgYnVpbGRlcnMsXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VCdWlsZGVyKHJlcG8pIHtcbiAgICBjb25zdCBzbHVnID0gcmVwby5zbHVnO1xuICAgIGNvbnN0IG5hbWUgPSBzbHVnLnNwbGl0KCcvJykucG9wKCk7XG4gICAgY29uc3QgbGFzdCA9IHBhcnNlSW50KCByZXBvLmxhc3RfYnVpbGRfbnVtYmVyLCAxMCApO1xuICAgIGNvbnN0IGJ1aWxkcyA9IFsgMCwgMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTAgXVxuICAgICAgLm1hcCggeCA9PiBsYXN0IC0geCApXG4gICAgICAuZmlsdGVyKCB4ID0+IHggPj0gMCApO1xuICAgIGNvbnN0IGRhdGEgPSByZXBvO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke3NsdWd9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHtzbHVnfWAsXG4gICAgICBidWlsZHNfdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHtzbHVnfS9idWlsZHN7P251bWJlcixhZnRlcl9udW1iZXJ9YCxcbiAgICAgIGJ1aWxkcyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkKHJlcG8sIGJ1aWxkKSB7XG4gICAgY29uc3Qgc2x1ZyA9IHJlcG8uc2x1ZztcbiAgICBjb25zdCBuYW1lID0gc2x1Zy5zcGxpdCgnLycpLnBvcCgpO1xuICAgIGNvbnN0IG51bWJlciA9IHBhcnNlSW50KGJ1aWxkLm51bWJlciwgMTApO1xuICAgIGNvbnN0IGJ1aWxkaW5nID0gVFJBVklTX1NUQVRFX01BUFsgYnVpbGQuc3RhdGUgXSA9PT0gUEVORElORztcbiAgICBjb25zdCBkYXRhID0gYnVpbGQ7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIG51bWJlcixcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z30vYnVpbGRzLyR7YnVpbGQuaWR9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHtzbHVnfS9idWlsZHMvJHtidWlsZC5pZH1gLFxuICAgICAgc3RhdGU6IFRSQVZJU19TVEFURV9NQVBbIGJ1aWxkLnN0YXRlIF0sXG4gICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQuc3RhcnRlZF9hdCksXG4gICAgICBlbmQ6IGJ1aWxkaW5nID8gbnVsbCA6IG5ldyBEYXRlKGJ1aWxkLmZpbmlzaGVkX2F0KSxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRJbmZvLFxuICAgIGdldEJ1aWxkZXIsXG4gICAgZ2V0QnVpbGRlcnMsXG4gICAgZ2V0QnVpbGQsXG4gICAgZ2V0QnVpbGRzXG4gIH07XG59XG4iXX0=