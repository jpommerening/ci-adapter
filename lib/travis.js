'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _util = require('util');

var _adapter = require('./adapter');

var _util2 = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TRAVIS_API_VERSION = 2;
var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.' + TRAVIS_API_VERSION + '+json';
var TRAVIS_USER_AGENT = 'Travis/' + TRAVIS_API_VERSION + ' ' + _constants.USER_AGENT;
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _constants.PENDING,
  created: _constants.PENDING,
  queued: _constants.PENDING,
  started: _constants.PENDING,
  passed: _constants.SUCCESS,
  failed: _constants.FAILURE,
  errored: _constants.ERRORED,
  canceled: _constants.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

(0, _util.inherits)(Travis, _adapter.Adapter);

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  if (!(this instanceof Travis)) {
    return new Travis(endpoint, { headers: h, github_token: github_token, account: account });
  }

  var headers = Object.assign({
    'Accept': TRAVIS_MEDIA_TYPE,
    'User-Agent': TRAVIS_USER_AGENT
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);
  var token = undefined;

  _adapter.Adapter.call(this);

  this.getInfo = getInfo;
  this.getBuilder = getBuilder;
  this.getBuild = getBuild;
  this.getBuilders = getBuilders;

  function getToken(github_token) {
    return token || (token = (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: Object.assign({}, options.headers, {
        'Content-Type': 'application/json'
      }),
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      if (response.status !== 200) {
        return response.text().then(function (text) {
          return Promise.reject(new Error(text));
        });
      }
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    }));
  }

  function getInfo() {
    return (github_token ? getToken(github_token) : Promise.resolve(null)).then(function () {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(_util2.handleResponse).then(makeInfo);
  }

  function getBuilder(info, name) {
    var repo = info.data.repos.find(function (repo) {
      return repo.slug.split('/').pop() === name;
    });
    return makeBuilder(repo);
  }

  function getBuild(builder, number) {
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ number: number });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(function (data) {
      return makeBuild(builder.data, data.builds[0]);
    });
  }

  function getBuilders(info) {
    var repos = info.data.repos.filter(function (repo) {
      return info.builders.indexOf(repo.slug.split('/').pop() >= 0);
    });
    return repos.map(makeBuilder);
  }

  function makeInfo(data) {
    var name = 'Travis CI - ' + account + ' (' + endpoint + ')';
    var builders = data.repos.filter(function (repo) {
      return repo.last_build_number !== null;
    }).map(function (repo) {
      return repo.slug.split('/')[1];
    });

    return {
      name: name,
      url: endpoint + '/repos/' + account,
      html_url: html_url + '/' + account,
      builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(repo) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var last = parseInt(repo.last_build_number, 10);
    var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(function (x) {
      return last - x;
    }).filter(function (x) {
      return x >= 0;
    });
    var data = repo;

    return {
      name: name,
      url: endpoint + '/repos/' + slug,
      html_url: html_url + '/' + slug,
      builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(repo, build) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var number = parseInt(build.number, 10);
    var building = TRAVIS_STATE_MAP[build.state] === _constants.PENDING;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/repos/' + slug + '/builds/' + build.id,
      html_url: html_url + '/' + slug + '/builds/' + build.id,
      state: TRAVIS_STATE_MAP[build.state],
      start: new Date(build.started_at),
      end: building ? null : new Date(build.finished_at),
      data: data
    };
  }
}
//# sourceMappingURL=data:application/json;base64,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QUM5QixRQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQ3ZCLFFBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDbkMsUUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDMUMsUUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUUsS0FBSyxDQUFDLEtBQUssQ0FBRSxnQkFqSTNDLE9BQU8sQUFpSWdELENBQUM7QUFDN0QsUUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDOztBQUVuQixXQUFPO0FBQ0wsVUFBSSxFQUFKLElBQUk7QUFDSixZQUFNLEVBQU4sTUFBTTtBQUNOLFNBQUcsRUFBSyxRQUFRLGVBQVUsSUFBSSxnQkFBVyxLQUFLLENBQUMsRUFBRSxBQUFFO0FBQ25ELGNBQVEsRUFBSyxRQUFRLFNBQUksSUFBSSxnQkFBVyxLQUFLLENBQUMsRUFBRSxBQUFFO0FBQ2xELFdBQUssRUFBRSxnQkFBZ0IsQ0FBRSxLQUFLLENBQUMsS0FBSyxDQUFFO0FBQ3RDLFdBQUssRUFBRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDO0FBQ2pDLFNBQUcsRUFBRSxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7QUFDbEQsVUFBSSxFQUFKLElBQUk7S0FDTCxDQUFDO0dBQ0g7Q0FDRiIsImZpbGUiOiJ0cmF2aXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXJsdGVtcGxhdGUgZnJvbSAndXJsLXRlbXBsYXRlJztcbmltcG9ydCBmZXRjaCBmcm9tICcuL2ZldGNoJztcbmltcG9ydCB7IGluaGVyaXRzIH0gZnJvbSAndXRpbCc7XG5pbXBvcnQgeyBBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVyJztcbmltcG9ydCB7IGhhbmRsZVJlc3BvbnNlIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IFBFTkRJTkcsIFNVQ0NFU1MsIEZBSUxVUkUsIEVSUk9SRUQsIEFCT1JURUQsIFVOS05PV04sIFVTRVJfQUdFTlQgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbmNvbnN0IFRSQVZJU19BUElfVkVSU0lPTiA9IDI7XG5jb25zdCBUUkFWSVNfTUVESUFfVFlQRSA9IGBhcHBsaWNhdGlvbi92bmQudHJhdmlzLWNpLiR7VFJBVklTX0FQSV9WRVJTSU9OfStqc29uYDtcbmNvbnN0IFRSQVZJU19VU0VSX0FHRU5UID0gYFRyYXZpcy8ke1RSQVZJU19BUElfVkVSU0lPTn0gJHtVU0VSX0FHRU5UfWA7XG5jb25zdCBUUkFWSVNfSFRNTF9VUkwgPSAvXihodHRwcz86XFwvXFwvKShhcGlcXC4odHJhdmlzLWNpXFwuKG9yZ3xjb20pKXwoW15cXC9dKylcXC9hcGkpKFxcLy4rKT8kLztcbmNvbnN0IFRSQVZJU19TVEFURV9NQVAgPSB7XG4gIHJlY2VpdmVkOiBQRU5ESU5HLFxuICBjcmVhdGVkOiBQRU5ESU5HLFxuICBxdWV1ZWQ6IFBFTkRJTkcsXG4gIHN0YXJ0ZWQ6IFBFTkRJTkcsXG4gIHBhc3NlZDogU1VDQ0VTUyxcbiAgZmFpbGVkOiBGQUlMVVJFLFxuICBlcnJvcmVkOiBFUlJPUkVELFxuICBjYW5jZWxlZDogQUJPUlRFRFxufTtcblxuZnVuY3Rpb24gZ2V0SHRtbFVybCh1cmwpIHtcbiAgY29uc3QgbWF0Y2ggPSBUUkFWSVNfSFRNTF9VUkwuZXhlYyh1cmwpO1xuICByZXR1cm4gbWF0Y2hbMV0gKyAobWF0Y2hbM10gfHwgbWF0Y2hbNV0pICsgKG1hdGNoWzZdIHx8ICcnKTtcbn1cblxuaW5oZXJpdHMoVHJhdmlzLCBBZGFwdGVyKTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gVHJhdmlzKGVuZHBvaW50LCB7IGhlYWRlcnM6IGgsIGdpdGh1Yl90b2tlbiwgYWNjb3VudCB9ID0ge30pIHtcbiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFRyYXZpcykpIHtcbiAgICByZXR1cm4gbmV3IFRyYXZpcyhlbmRwb2ludCwgeyBoZWFkZXJzOiBoLCBnaXRodWJfdG9rZW4sIGFjY291bnQgfSk7XG4gIH1cblxuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgJ0FjY2VwdCc6IFRSQVZJU19NRURJQV9UWVBFLFxuICAgICdVc2VyLUFnZW50JzogVFJBVklTX1VTRVJfQUdFTlRcbiAgfSwgaCk7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgaGVhZGVyc1xuICB9O1xuICBjb25zdCBodG1sX3VybCA9IGdldEh0bWxVcmwoZW5kcG9pbnQpO1xuICBsZXQgdG9rZW47XG5cbiAgQWRhcHRlci5jYWxsKHRoaXMpO1xuXG4gIHRoaXMuZ2V0SW5mbyA9IGdldEluZm87XG4gIHRoaXMuZ2V0QnVpbGRlciA9IGdldEJ1aWxkZXI7XG4gIHRoaXMuZ2V0QnVpbGQgPSBnZXRCdWlsZDtcbiAgdGhpcy5nZXRCdWlsZGVycyA9IGdldEJ1aWxkZXJzO1xuXG4gIGZ1bmN0aW9uIGdldFRva2VuKGdpdGh1Yl90b2tlbikge1xuICAgIHJldHVybiB0b2tlbiB8fCAodG9rZW4gPSBmZXRjaChgJHtlbmRwb2ludH0vYXV0aC9naXRodWJgLCB7XG4gICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMuaGVhZGVycywge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICB9KSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZ2l0aHViX3Rva2VuIH0pXG4gICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UudGV4dCgpLnRoZW4odGV4dCA9PiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IodGV4dCkpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgfSkudGhlbihmdW5jdGlvbiAoeyBhY2Nlc3NfdG9rZW4gfSkge1xuICAgICAgb3B0aW9ucy5oZWFkZXJzWyAnQXV0aG9yaXphdGlvbicgXSA9IGB0b2tlbiAke2FjY2Vzc190b2tlbn1gO1xuICAgICAgcmV0dXJuIGFjY2Vzc190b2tlbjtcbiAgICB9KSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRJbmZvKCkge1xuICAgIHJldHVybiAoZ2l0aHViX3Rva2VuID8gZ2V0VG9rZW4oZ2l0aHViX3Rva2VuKSA6IFByb21pc2UucmVzb2x2ZShudWxsKSlcbiAgICAgIC50aGVuKCgpID0+IGZldGNoKGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9YCwgb3B0aW9ucykpXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKG1ha2VJbmZvKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXIoaW5mbywgbmFtZSkge1xuICAgIGNvbnN0IHJlcG8gPSBpbmZvLmRhdGEucmVwb3MuZmluZChyZXBvID0+IHJlcG8uc2x1Zy5zcGxpdCgnLycpLnBvcCgpID09PSBuYW1lKTtcbiAgICByZXR1cm4gbWFrZUJ1aWxkZXIocmVwbyk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZChidWlsZGVyLCBudW1iZXIpIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKGJ1aWxkZXIuYnVpbGRzX3VybCk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4oZGF0YSA9PiBtYWtlQnVpbGQoYnVpbGRlci5kYXRhLCBkYXRhLmJ1aWxkc1swXSkpO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcnMoaW5mbykge1xuICAgIGNvbnN0IHJlcG9zID0gaW5mby5kYXRhLnJlcG9zLmZpbHRlcihyZXBvID0+IGluZm8uYnVpbGRlcnMuaW5kZXhPZihyZXBvLnNsdWcuc3BsaXQoJy8nKS5wb3AoKSA+PSAwKSk7XG4gICAgcmV0dXJuIHJlcG9zLm1hcChtYWtlQnVpbGRlcik7XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlSW5mbyhkYXRhKSB7XG4gICAgY29uc3QgbmFtZSA9IGBUcmF2aXMgQ0kgLSAke2FjY291bnR9ICgke2VuZHBvaW50fSlgO1xuICAgIGNvbnN0IGJ1aWxkZXJzID0gZGF0YS5yZXBvc1xuICAgICAgLmZpbHRlcihyZXBvID0+IHJlcG8ubGFzdF9idWlsZF9udW1iZXIgIT09IG51bGwpXG4gICAgICAubWFwKHJlcG8gPT4gcmVwby5zbHVnLnNwbGl0KCcvJylbMV0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHthY2NvdW50fWAsXG4gICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9ey9uYW1lfXs/aWRzfWAsXG4gICAgICBidWlsZGVycyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkZXIocmVwbykge1xuICAgIGNvbnN0IHNsdWcgPSByZXBvLnNsdWc7XG4gICAgY29uc3QgbmFtZSA9IHNsdWcuc3BsaXQoJy8nKS5wb3AoKTtcbiAgICBjb25zdCBsYXN0ID0gcGFyc2VJbnQoIHJlcG8ubGFzdF9idWlsZF9udW1iZXIsIDEwICk7XG4gICAgY29uc3QgYnVpbGRzID0gWyAwLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMCBdXG4gICAgICAubWFwKHggPT4gbGFzdCAtIHgpXG4gICAgICAuZmlsdGVyKHggPT4geCA+PSAwKTtcbiAgICBjb25zdCBkYXRhID0gcmVwbztcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHtzbHVnfWAsXG4gICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7c2x1Z31gLFxuICAgICAgYnVpbGRzX3VybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z30vYnVpbGRzez9udW1iZXIsYWZ0ZXJfbnVtYmVyfWAsXG4gICAgICBidWlsZHMsXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VCdWlsZChyZXBvLCBidWlsZCkge1xuICAgIGNvbnN0IHNsdWcgPSByZXBvLnNsdWc7XG4gICAgY29uc3QgbmFtZSA9IHNsdWcuc3BsaXQoJy8nKS5wb3AoKTtcbiAgICBjb25zdCBudW1iZXIgPSBwYXJzZUludChidWlsZC5udW1iZXIsIDEwKTtcbiAgICBjb25zdCBidWlsZGluZyA9IFRSQVZJU19TVEFURV9NQVBbIGJ1aWxkLnN0YXRlIF0gPT09IFBFTkRJTkc7XG4gICAgY29uc3QgZGF0YSA9IGJ1aWxkO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBudW1iZXIsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke3NsdWd9L2J1aWxkcy8ke2J1aWxkLmlkfWAsXG4gICAgICBodG1sX3VybDogYCR7aHRtbF91cmx9LyR7c2x1Z30vYnVpbGRzLyR7YnVpbGQuaWR9YCxcbiAgICAgIHN0YXRlOiBUUkFWSVNfU1RBVEVfTUFQWyBidWlsZC5zdGF0ZSBdLFxuICAgICAgc3RhcnQ6IG5ldyBEYXRlKGJ1aWxkLnN0YXJ0ZWRfYXQpLFxuICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC5maW5pc2hlZF9hdCksXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxufVxuIl19