'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Travis;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TRAVIS_API_VERSION = 2;
var TRAVIS_MEDIA_TYPE = 'application/vnd.travis-ci.' + TRAVIS_API_VERSION + '+json';
var TRAVIS_USER_AGENT = 'Travis/' + TRAVIS_API_VERSION + ' ' + _constants.USER_AGENT;
var TRAVIS_HTML_URL = /^(https?:\/\/)(api\.(travis-ci\.(org|com))|([^\/]+)\/api)(\/.+)?$/;
var TRAVIS_STATE_MAP = {
  received: _constants.PENDING,
  created: _constants.PENDING,
  queued: _constants.PENDING,
  started: _constants.PENDING,
  passed: _constants.SUCCESS,
  failed: _constants.FAILURE,
  errored: _constants.ERRORED,
  canceled: _constants.ABORTED
};

function getHtmlUrl(url) {
  var match = TRAVIS_HTML_URL.exec(url);
  return match[1] + (match[3] || match[5]) + (match[6] || '');
}

function Travis(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;
  var github_token = _ref.github_token;
  var account = _ref.account;

  var headers = Object.assign({
    'Accept': TRAVIS_MEDIA_TYPE,
    'User-Agent': TRAVIS_USER_AGENT
  }, h);
  var options = {
    headers: headers
  };
  var html_url = getHtmlUrl(endpoint);
  var token = undefined;

  function getToken(github_token) {
    return token || (token = (0, _fetch2.default)(endpoint + '/auth/github', {
      method: 'post',
      headers: Object.assign({}, options.headers, {
        'Content-Type': 'application/json'
      }),
      body: JSON.stringify({ github_token: github_token })
    }).then(function (response) {
      if (response.status !== 200) {
        return response.text().then(function (text) {
          return Promise.reject(new Error(text));
        });
      }
      return response.json();
    }).then(function (_ref2) {
      var access_token = _ref2.access_token;

      options.headers['Authorization'] = 'token ' + access_token;
      return access_token;
    }));
  }

  function getInfo() {
    return (github_token ? getToken(github_token) : Promise.resolve(null)).then(function () {
      return (0, _fetch2.default)(endpoint + '/repos/' + account, options);
    }).then(handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var repo = info.data.repos.find(function (repo) {
        return repo.slug.split('/').pop() === name;
      });
      return makeBuilder(repo);
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var repos = info.data.repos.filter(function (repo) {
        return info.builders.indexOf(repo.slug.split('/').pop() >= 0);
      });
      return repos.map(makeBuilder);
    });
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(handleResponse).then(function (data) {
        return makeBuild(builder.data, data.builds[0]);
      });
    });
  }

  function getBuilds(builder) {
    return Promise.all(builder.builds.map(function (number) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(function (response) {
        return response.json();
      });
    })).then(function (data) {
      var builds = [].concat.apply([], data.map(function (data) {
        return data.builds;
      }));

      return builds.map(function (data) {
        return makeBuild(builder.data, data);
      });
    });
  }

  function handleResponse(response) {
    if (response.status === 200) return response.json();
    return response.text().then(function (text) {
      return Promise.reject(new Error(response.status + ' ' + response.statusText + ': ' + text));
    });
  }

  function makeInfo(data) {
    var name = 'Travis CI - ' + account + ' (' + endpoint + ')';
    var builders = data.repos.filter(function (repo) {
      return repo.last_build_number !== null;
    }).map(function (repo) {
      return repo.slug.split('/')[1];
    });

    return {
      name: name,
      url: endpoint + '/repos/' + account,
      html_url: html_url + '/' + account,
      builders_url: endpoint + '/repos/' + account + '{/name}{?ids}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(repo) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var last = parseInt(repo.last_build_number, 10);
    var builds = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(function (x) {
      return last - x;
    }).filter(function (x) {
      return x >= 0;
    });
    var data = repo;

    return {
      name: name,
      url: endpoint + '/repos/' + slug,
      html_url: html_url + '/' + slug,
      builds_url: endpoint + '/repos/' + slug + '/builds{?number,after_number}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(repo, build) {
    var slug = repo.slug;
    var name = slug.split('/').pop();
    var number = parseInt(build.number, 10);
    var building = TRAVIS_STATE_MAP[build.state] === _constants.PENDING;
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/repos/' + slug + '/builds/' + build.id,
      html_url: html_url + '/' + slug + '/builds/' + build.id,
      state: TRAVIS_STATE_MAP[build.state],
      start: new Date(build.started_at),
      end: building ? null : new Date(build.finished_at),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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UUFBUSxHQUFHLGdCQUFnQixDQUFFLEtBQUssQ0FBQyxLQUFLLENBQUUsZ0JBbkozQyxPQUFPLEFBbUpnRCxDQUFDO0FBQzdELFFBQU0sSUFBSSxHQUFHLEtBQUssQ0FBQzs7QUFFbkIsV0FBTztBQUNMLFVBQUksRUFBSixJQUFJO0FBQ0osWUFBTSxFQUFOLE1BQU07QUFDTixTQUFHLEVBQUssUUFBUSxlQUFVLElBQUksZ0JBQVcsS0FBSyxDQUFDLEVBQUUsQUFBRTtBQUNuRCxjQUFRLEVBQUssUUFBUSxTQUFJLElBQUksZ0JBQVcsS0FBSyxDQUFDLEVBQUUsQUFBRTtBQUNsRCxXQUFLLEVBQUUsZ0JBQWdCLENBQUUsS0FBSyxDQUFDLEtBQUssQ0FBRTtBQUN0QyxXQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztBQUNqQyxTQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDO0FBQ2xELFVBQUksRUFBSixJQUFJO0tBQ0wsQ0FBQztHQUNIOztBQUVELFNBQU87QUFDTCxXQUFPLEVBQVAsT0FBTztBQUNQLGNBQVUsRUFBVixVQUFVO0FBQ1YsZUFBVyxFQUFYLFdBQVc7QUFDWCxZQUFRLEVBQVIsUUFBUTtBQUNSLGFBQVMsRUFBVCxTQUFTO0dBQ1YsQ0FBQztDQUNIIiwiZmlsZSI6InRyYXZpcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmZXRjaCBmcm9tICcuL2ZldGNoJztcbmltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgRkFJTFVSRSwgRVJST1JFRCwgQUJPUlRFRCwgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgVFJBVklTX0FQSV9WRVJTSU9OID0gMjtcbmNvbnN0IFRSQVZJU19NRURJQV9UWVBFID0gYGFwcGxpY2F0aW9uL3ZuZC50cmF2aXMtY2kuJHtUUkFWSVNfQVBJX1ZFUlNJT059K2pzb25gO1xuY29uc3QgVFJBVklTX1VTRVJfQUdFTlQgPSBgVHJhdmlzLyR7VFJBVklTX0FQSV9WRVJTSU9OfSAke1VTRVJfQUdFTlR9YDtcbmNvbnN0IFRSQVZJU19IVE1MX1VSTCA9IC9eKGh0dHBzPzpcXC9cXC8pKGFwaVxcLih0cmF2aXMtY2lcXC4ob3JnfGNvbSkpfChbXlxcL10rKVxcL2FwaSkoXFwvLispPyQvO1xuY29uc3QgVFJBVklTX1NUQVRFX01BUCA9IHtcbiAgcmVjZWl2ZWQ6IFBFTkRJTkcsXG4gIGNyZWF0ZWQ6IFBFTkRJTkcsXG4gIHF1ZXVlZDogUEVORElORyxcbiAgc3RhcnRlZDogUEVORElORyxcbiAgcGFzc2VkOiBTVUNDRVNTLFxuICBmYWlsZWQ6IEZBSUxVUkUsXG4gIGVycm9yZWQ6IEVSUk9SRUQsXG4gIGNhbmNlbGVkOiBBQk9SVEVEXG59O1xuXG5mdW5jdGlvbiBnZXRIdG1sVXJsKHVybCkge1xuICBjb25zdCBtYXRjaCA9IFRSQVZJU19IVE1MX1VSTC5leGVjKHVybCk7XG4gIHJldHVybiBtYXRjaFsxXSArIChtYXRjaFszXSB8fCBtYXRjaFs1XSkgKyAobWF0Y2hbNl0gfHwgJycpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBUcmF2aXMoZW5kcG9pbnQsIHsgaGVhZGVyczogaCwgZ2l0aHViX3Rva2VuLCBhY2NvdW50IH0gPSB7fSkge1xuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgJ0FjY2VwdCc6IFRSQVZJU19NRURJQV9UWVBFLFxuICAgICdVc2VyLUFnZW50JzogVFJBVklTX1VTRVJfQUdFTlRcbiAgfSwgaCk7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgaGVhZGVyc1xuICB9O1xuICBjb25zdCBodG1sX3VybCA9IGdldEh0bWxVcmwoZW5kcG9pbnQpO1xuICBsZXQgdG9rZW47XG5cbiAgZnVuY3Rpb24gZ2V0VG9rZW4oZ2l0aHViX3Rva2VuKSB7XG4gICAgcmV0dXJuIHRva2VuIHx8ICh0b2tlbiA9IGZldGNoKGAke2VuZHBvaW50fS9hdXRoL2dpdGh1YmAsIHtcbiAgICAgIG1ldGhvZDogJ3Bvc3QnLFxuICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucy5oZWFkZXJzLCB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgIH0pLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBnaXRodWJfdG9rZW4gfSlcbiAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS50ZXh0KCkudGhlbih0ZXh0ID0+IFByb21pc2UucmVqZWN0KG5ldyBFcnJvcih0ZXh0KSkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICB9KS50aGVuKGZ1bmN0aW9uICh7IGFjY2Vzc190b2tlbiB9KSB7XG4gICAgICBvcHRpb25zLmhlYWRlcnNbICdBdXRob3JpemF0aW9uJyBdID0gYHRva2VuICR7YWNjZXNzX3Rva2VufWA7XG4gICAgICByZXR1cm4gYWNjZXNzX3Rva2VuO1xuICAgIH0pKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIChnaXRodWJfdG9rZW4gPyBnZXRUb2tlbihnaXRodWJfdG9rZW4pIDogUHJvbWlzZS5yZXNvbHZlKG51bGwpKVxuICAgICAgLnRoZW4oKCkgPT4gZmV0Y2goYCR7ZW5kcG9pbnR9L3JlcG9zLyR7YWNjb3VudH1gLCBvcHRpb25zKSlcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihuYW1lKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgcmVwbyA9IGluZm8uZGF0YS5yZXBvcy5maW5kKHJlcG8gPT4gcmVwby5zbHVnLnNwbGl0KCcvJykucG9wKCkgPT09IG5hbWUpO1xuICAgICAgICByZXR1cm4gbWFrZUJ1aWxkZXIocmVwbyk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKCkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHJlcG9zID0gaW5mby5kYXRhLnJlcG9zLmZpbHRlcihyZXBvID0+IGluZm8uYnVpbGRlcnMuaW5kZXhPZihyZXBvLnNsdWcuc3BsaXQoJy8nKS5wb3AoKSA+PSAwKSk7XG4gICAgICAgIHJldHVybiByZXBvcy5tYXAobWFrZUJ1aWxkZXIpO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZChuYW1lLCBudW1iZXIpIHtcbiAgICByZXR1cm4gZ2V0QnVpbGRlcihuYW1lKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGJ1aWxkZXIpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggYnVpbGRlci5idWlsZHNfdXJsICk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG51bWJlciB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKVxuICAgICAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgICAgIC50aGVuKGRhdGEgPT4gbWFrZUJ1aWxkKGJ1aWxkZXIuZGF0YSwgZGF0YS5idWlsZHNbMF0pKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRzKGJ1aWxkZXIpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYnVpbGRlci5idWlsZHMubWFwKGZ1bmN0aW9uIChudW1iZXIpIHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoIGJ1aWxkZXIuYnVpbGRzX3VybCApO1xuICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSk7XG4gICAgfSkpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgIGNvbnN0IGJ1aWxkcyA9IFtdLmNvbmNhdC5hcHBseSggW10sIGRhdGEubWFwKGRhdGEgPT4gZGF0YS5idWlsZHMpICk7XG5cbiAgICAgIHJldHVybiBidWlsZHMubWFwKGRhdGEgPT4gbWFrZUJ1aWxkKGJ1aWxkZXIuZGF0YSwgZGF0YSkpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlUmVzcG9uc2UocmVzcG9uc2UpIHtcbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApXG4gICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgIHJldHVybiByZXNwb25zZS50ZXh0KClcbiAgICAgIC50aGVuKHRleHQgPT4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGAke3Jlc3BvbnNlLnN0YXR1c30gJHtyZXNwb25zZS5zdGF0dXNUZXh0fTogJHt0ZXh0fWApKSk7XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlSW5mbyhkYXRhKSB7XG4gICAgY29uc3QgbmFtZSA9IGBUcmF2aXMgQ0kgLSAke2FjY291bnR9ICgke2VuZHBvaW50fSlgO1xuICAgIGNvbnN0IGJ1aWxkZXJzID0gZGF0YS5yZXBvc1xuICAgICAgLmZpbHRlcihyZXBvID0+IHJlcG8ubGFzdF9idWlsZF9udW1iZXIgIT09IG51bGwpXG4gICAgICAubWFwKHJlcG8gPT4gcmVwby5zbHVnLnNwbGl0KCcvJylbMV0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtodG1sX3VybH0vJHthY2NvdW50fWAsXG4gICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke2FjY291bnR9ey9uYW1lfXs/aWRzfWAsXG4gICAgICBidWlsZGVycyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkZXIocmVwbykge1xuICAgIGNvbnN0IHNsdWcgPSByZXBvLnNsdWc7XG4gICAgY29uc3QgbmFtZSA9IHNsdWcuc3BsaXQoJy8nKS5wb3AoKTtcbiAgICBjb25zdCBsYXN0ID0gcGFyc2VJbnQoIHJlcG8ubGFzdF9idWlsZF9udW1iZXIsIDEwICk7XG4gICAgY29uc3QgYnVpbGRzID0gWyAwLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMCBdXG4gICAgICAubWFwKCB4ID0+IGxhc3QgLSB4IClcbiAgICAgIC5maWx0ZXIoIHggPT4geCA+PSAwICk7XG4gICAgY29uc3QgZGF0YSA9IHJlcG87XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L3JlcG9zLyR7c2x1Z31gLFxuICAgICAgaHRtbF91cmw6IGAke2h0bWxfdXJsfS8ke3NsdWd9YCxcbiAgICAgIGJ1aWxkc191cmw6IGAke2VuZHBvaW50fS9yZXBvcy8ke3NsdWd9L2J1aWxkc3s/bnVtYmVyLGFmdGVyX251bWJlcn1gLFxuICAgICAgYnVpbGRzLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlQnVpbGQocmVwbywgYnVpbGQpIHtcbiAgICBjb25zdCBzbHVnID0gcmVwby5zbHVnO1xuICAgIGNvbnN0IG5hbWUgPSBzbHVnLnNwbGl0KCcvJykucG9wKCk7XG4gICAgY29uc3QgbnVtYmVyID0gcGFyc2VJbnQoYnVpbGQubnVtYmVyLCAxMCk7XG4gICAgY29uc3QgYnVpbGRpbmcgPSBUUkFWSVNfU1RBVEVfTUFQWyBidWlsZC5zdGF0ZSBdID09PSBQRU5ESU5HO1xuICAgIGNvbnN0IGRhdGEgPSBidWlsZDtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgbnVtYmVyLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vcmVwb3MvJHtzbHVnfS9idWlsZHMvJHtidWlsZC5pZH1gLFxuICAgICAgaHRtbF91cmw6IGAke2h0bWxfdXJsfS8ke3NsdWd9L2J1aWxkcy8ke2J1aWxkLmlkfWAsXG4gICAgICBzdGF0ZTogVFJBVklTX1NUQVRFX01BUFsgYnVpbGQuc3RhdGUgXSxcbiAgICAgIHN0YXJ0OiBuZXcgRGF0ZShidWlsZC5zdGFydGVkX2F0KSxcbiAgICAgIGVuZDogYnVpbGRpbmcgPyBudWxsIDogbmV3IERhdGUoYnVpbGQuZmluaXNoZWRfYXQpLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGdldEluZm8sXG4gICAgZ2V0QnVpbGRlcixcbiAgICBnZXRCdWlsZGVycyxcbiAgICBnZXRCdWlsZCxcbiAgICBnZXRCdWlsZHNcbiAgfTtcbn1cbiJdfQ==