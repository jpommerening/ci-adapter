'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Buildbot;

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _util = require('util');

var _adapter = require('./adapter');

var _util2 = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BUILDBOT_MEDIA_TYPE = 'application/json';
var BUILDBOT_STATE_LIST = [_constants.SUCCESS, _constants.WARNING, _constants.FAILURE, _constants.UNKNOWN, _constants.ERRORED, _constants.ERRORED];

function uniqueBuilds(builds) {
  var numbers = {};

  return Object.keys(builds).map(function (key) {
    return builds[key];
  }).filter(function (_ref) {
    var number = _ref.number;

    if (numbers[number]) return false;
    return numbers[number] = true;
  });
}

(0, _util.inherits)(Buildbot, _adapter.Adapter);

function Buildbot(endpoint) {
  var _ref2 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref2.headers;

  if (!(this instanceof Buildbot)) {
    return new Buildbot(endpoint, { headers: h });
  }

  var headers = Object.assign({
    'Accept': BUILDBOT_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  _adapter.Adapter.call(this);

  this.getInfo = getInfo;
  this.getBuilder = getBuilder;
  this.getBuild = getBuild;
  this.getBuilders = getBuilders;
  this.getBuilds = getBuilds;

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/json', options).then(_util2.handleResponse).then(makeInfo);
  }

  function getBuilder(info, name) {
    var template = _urlTemplate2.default.parse(info.builders_url);
    var url = template.expand({ name: name });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(function (data) {
      return makeBuilder(name, data);
    });
  }

  function getBuild(builder, number) {
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ number: number });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(makeBuild);
  }

  function getBuilders(info) {
    var select = info.builders;
    var template = _urlTemplate2.default.parse(info.builders_url);
    var url = template.expand({ select: select });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(function (data) {
      return Object.keys(data).map(function (key) {
        return makeBuilder(key, data[key]);
      });
    });
  }

  function getBuilds(builder) {
    var select = builder.builds;
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ select: select });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(uniqueBuilds).then(function (builds) {
      return builds.map(makeBuild);
    });
  }

  function makeInfo(root) {
    var name = root.project.title;
    var builders = Object.keys(root.builders);
    var data = root;

    return {
      name: name,
      url: endpoint + '/json',
      html_url: endpoint,
      builders_url: endpoint + '/json/builders{/name}{?select*}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(name, builder) {
    var builds = [-1].concat(builder.cachedBuilds);
    var data = builder;

    return {
      name: name,
      url: endpoint + '/json/builders/' + name,
      html_url: endpoint + '/builders/' + name,
      builds_url: endpoint + '/json/builders/' + name + '/builds{/number}{?select*}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(build) {
    var name = build.builderName;
    var number = build.number;
    var building = build.times[0] && !build.times[1];
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/json/builders/' + name + '/builds/' + number,
      html_url: endpoint + '/builders/' + name + '/builds/' + number,
      state: building ? _constants.PENDING : BUILDBOT_STATE_LIST[build.results || 0] || _constants.UNKNOWN,
      start: new Date(build.times[0] * 1000),
      end: building ? null : new Date(build.times[1] * 1000),
      data: data
    };
  }
}
//# sourceMappingURL=data:application/json;base64,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QUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUUsQ0FBQyxDQUFFLENBQUM7QUFDdkQsUUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDOztBQUVuQixXQUFPO0FBQ0wsVUFBSSxFQUFKLElBQUk7QUFDSixZQUFNLEVBQU4sTUFBTTtBQUNOLFNBQUcsRUFBSyxRQUFRLHVCQUFrQixJQUFJLGdCQUFXLE1BQU0sQUFBRTtBQUN6RCxjQUFRLEVBQUssUUFBUSxrQkFBYSxJQUFJLGdCQUFXLE1BQU0sQUFBRTtBQUN6RCxXQUFLLEVBQUUsUUFBUSxjQXBJWixPQUFPLEdBb0ltQixtQkFBbUIsQ0FBRSxLQUFLLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBRSxlQXBJdEIsT0FBTyxBQW9JMEIsQUFBQztBQUNsRixXQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUM7QUFDeEMsU0FBRyxFQUFFLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUM7QUFDeEQsVUFBSSxFQUFKLElBQUk7S0FDTCxDQUFDO0dBQ0g7Q0FDRiIsImZpbGUiOiJidWlsZGJvdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IGZldGNoIGZyb20gJy4vZmV0Y2gnO1xuaW1wb3J0IHsgaW5oZXJpdHMgfSBmcm9tICd1dGlsJztcbmltcG9ydCB7IEFkYXB0ZXIgfSBmcm9tICcuL2FkYXB0ZXInO1xuaW1wb3J0IHsgaGFuZGxlUmVzcG9uc2UgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgV0FSTklORywgRkFJTFVSRSwgRVJST1JFRCwgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgQlVJTERCT1RfTUVESUFfVFlQRSA9ICdhcHBsaWNhdGlvbi9qc29uJztcbmNvbnN0IEJVSUxEQk9UX1NUQVRFX0xJU1QgPSBbXG4gIFNVQ0NFU1MsXG4gIFdBUk5JTkcsXG4gIEZBSUxVUkUsXG4gIFVOS05PV04sXG4gIEVSUk9SRUQsXG4gIEVSUk9SRURcbl07XG5cbmZ1bmN0aW9uIHVuaXF1ZUJ1aWxkcyhidWlsZHMpIHtcbiAgY29uc3QgbnVtYmVycyA9IHt9O1xuXG4gIHJldHVybiBPYmplY3Qua2V5cyhidWlsZHMpXG4gICAgLm1hcChrZXkgPT4gYnVpbGRzW2tleV0pXG4gICAgLmZpbHRlcihmdW5jdGlvbiAoeyBudW1iZXIgfSkge1xuICAgICAgaWYgKG51bWJlcnNbIG51bWJlciBdKSByZXR1cm4gZmFsc2U7XG4gICAgICByZXR1cm4gbnVtYmVyc1sgbnVtYmVyIF0gPSB0cnVlO1xuICAgIH0pO1xufVxuXG5pbmhlcml0cyhCdWlsZGJvdCwgQWRhcHRlcik7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEJ1aWxkYm90KGVuZHBvaW50LCB7IGhlYWRlcnM6IGggfSA9IHt9KSB7XG4gIGlmICghKHRoaXMgaW5zdGFuY2VvZiBCdWlsZGJvdCkpIHtcbiAgICByZXR1cm4gbmV3IEJ1aWxkYm90KGVuZHBvaW50LCB7IGhlYWRlcnM6IGggfSk7XG4gIH1cblxuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgJ0FjY2VwdCc6IEJVSUxEQk9UX01FRElBX1RZUEUsXG4gICAgJ1VzZXItQWdlbnQnOiBVU0VSX0FHRU5UXG4gIH0sIGgpO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcblxuICBBZGFwdGVyLmNhbGwodGhpcyk7XG5cbiAgdGhpcy5nZXRJbmZvID0gZ2V0SW5mbztcbiAgdGhpcy5nZXRCdWlsZGVyID0gZ2V0QnVpbGRlcjtcbiAgdGhpcy5nZXRCdWlsZCA9IGdldEJ1aWxkO1xuICB0aGlzLmdldEJ1aWxkZXJzID0gZ2V0QnVpbGRlcnM7XG4gIHRoaXMuZ2V0QnVpbGRzID0gZ2V0QnVpbGRzO1xuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIGZldGNoKGAke2VuZHBvaW50fS9qc29uYCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihpbmZvLCBuYW1lKSB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShpbmZvLmJ1aWxkZXJzX3VybCk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbmFtZSB9KTtcblxuICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKChkYXRhKSA9PiBtYWtlQnVpbGRlcihuYW1lLCBkYXRhKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZChidWlsZGVyLCBudW1iZXIpIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKGJ1aWxkZXIuYnVpbGRzX3VybCk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUJ1aWxkKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKGluZm8pIHtcbiAgICBjb25zdCBzZWxlY3QgPSBpbmZvLmJ1aWxkZXJzO1xuICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoaW5mby5idWlsZGVyc191cmwpO1xuICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IHNlbGVjdCB9KTtcblxuICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKGRhdGEgPT4gT2JqZWN0LmtleXMoZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChrZXkgPT4gbWFrZUJ1aWxkZXIoa2V5LCBkYXRhW2tleV0pKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZHMoYnVpbGRlcikge1xuICAgIGNvbnN0IHNlbGVjdCA9IGJ1aWxkZXIuYnVpbGRzO1xuICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoIGJ1aWxkZXIuYnVpbGRzX3VybCApO1xuICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IHNlbGVjdCB9KTtcblxuICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKHVuaXF1ZUJ1aWxkcylcbiAgICAgIC50aGVuKGJ1aWxkcyA9PiBidWlsZHMubWFwKG1ha2VCdWlsZCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUluZm8ocm9vdCkge1xuICAgIGNvbnN0IG5hbWUgPSByb290LnByb2plY3QudGl0bGU7XG4gICAgY29uc3QgYnVpbGRlcnMgPSBPYmplY3Qua2V5cyhyb290LmJ1aWxkZXJzKTtcbiAgICBjb25zdCBkYXRhID0gcm9vdDtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vanNvbmAsXG4gICAgICBodG1sX3VybDogZW5kcG9pbnQsXG4gICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9qc29uL2J1aWxkZXJzey9uYW1lfXs/c2VsZWN0Kn1gLFxuICAgICAgYnVpbGRlcnMsXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VCdWlsZGVyKG5hbWUsIGJ1aWxkZXIpIHtcbiAgICBjb25zdCBidWlsZHMgPSBbIC0xIF0uY29uY2F0KGJ1aWxkZXIuY2FjaGVkQnVpbGRzKTtcbiAgICBjb25zdCBkYXRhID0gYnVpbGRlcjtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vanNvbi9idWlsZGVycy8ke25hbWV9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtlbmRwb2ludH0vYnVpbGRlcnMvJHtuYW1lfWAsXG4gICAgICBidWlsZHNfdXJsOiBgJHtlbmRwb2ludH0vanNvbi9idWlsZGVycy8ke25hbWV9L2J1aWxkc3svbnVtYmVyfXs/c2VsZWN0Kn1gLFxuICAgICAgYnVpbGRzLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlQnVpbGQoYnVpbGQpIHtcbiAgICBjb25zdCBuYW1lID0gYnVpbGQuYnVpbGRlck5hbWU7XG4gICAgY29uc3QgbnVtYmVyID0gYnVpbGQubnVtYmVyO1xuICAgIGNvbnN0IGJ1aWxkaW5nID0gYnVpbGQudGltZXNbIDAgXSAmJiAhYnVpbGQudGltZXNbIDEgXTtcbiAgICBjb25zdCBkYXRhID0gYnVpbGQ7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIG51bWJlcixcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfS9idWlsZHMvJHtudW1iZXJ9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtlbmRwb2ludH0vYnVpbGRlcnMvJHtuYW1lfS9idWlsZHMvJHtudW1iZXJ9YCxcbiAgICAgIHN0YXRlOiBidWlsZGluZyA/IFBFTkRJTkcgOiAoQlVJTERCT1RfU1RBVEVfTElTVFsgYnVpbGQucmVzdWx0cyB8fCAwIF0gfHwgVU5LTk9XTiksXG4gICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQudGltZXNbIDAgXSAqIDEwMDApLFxuICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC50aW1lc1sgMSBdICogMTAwMCksXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxufVxuXG4iXX0=