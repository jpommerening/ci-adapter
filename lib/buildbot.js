'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Buildbot;

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _util = require('util');

var _adapter = require('./adapter');

var _util2 = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _instanceof(left, right) { if (right != null && right[Symbol.hasInstance]) { return right[Symbol.hasInstance](left); } else { return left instanceof right; } }

var BUILDBOT_MEDIA_TYPE = 'application/json';
var BUILDBOT_STATE_LIST = [_constants.SUCCESS, _constants.WARNING, _constants.FAILURE, _constants.UNKNOWN, _constants.ERRORED, _constants.ERRORED];

function uniqueBuilds(builds) {
  var numbers = {};

  return Object.keys(builds).map(function (key) {
    return builds[key];
  }).filter(function (_ref) {
    var number = _ref.number;

    if (numbers[number]) return false;
    return numbers[number] = true;
  });
}

(0, _util.inherits)(Buildbot, _adapter.Adapter);

function Buildbot(endpoint) {
  var _ref2 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref2.headers;
  var tag = _ref2.tag;

  if (!_instanceof(this, Buildbot)) {
    return new Buildbot(endpoint, { headers: h, tag: tag });
  }

  var headers = Object.assign({
    'Accept': BUILDBOT_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  _adapter.Adapter.call(this);

  this.getInfo = getInfo;
  this.getBuilder = getBuilder;
  this.getBuild = getBuild;
  this.getBuilders = getBuilders;
  this.getBuilds = getBuilds;

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/json', options).then(_util2.handleResponse).then(makeInfo);
  }

  function getBuilder(info, name) {
    var template = _urlTemplate2.default.parse(info.builders_url);
    var url = template.expand({ name: name });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(function (data) {
      return makeBuilder(name, data);
    });
  }

  function getBuild(builder, number) {
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ number: number });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(makeBuild);
  }

  function getBuilders(info) {
    var select = info.builders.map(function (name) {
      return name.replace(/\//g, '%2F');
    });

    if (select.length === 0) {
      return Promise.resolve([]);
    }

    var template = _urlTemplate2.default.parse(info.builders_url);
    var url = template.expand({ select: select });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(function (data) {
      return Object.keys(data).map(function (key) {
        return makeBuilder(key, data[key]);
      });
    });
  }

  function getBuilds(builder) {
    var select = builder.builds;

    if (select.length === 0) {
      return Promise.resolve([]);
    }

    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ select: select });

    return (0, _fetch2.default)(url, options).then(_util2.handleResponse).then(uniqueBuilds).then(function (builds) {
      return builds.map(makeBuild);
    });
  }

  function makeInfo(root) {
    var name = root.project.title;
    var builders = Object.keys(root.builders).filter(function (name) {
      return !tag || root.builders[name].tags.indexOf(tag) >= 0;
    });
    var data = root;

    return {
      name: name,
      url: endpoint + '/json',
      html_url: endpoint,
      builders_url: endpoint + '/json/builders{/name}{?select*}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(name, builder) {
    var path = encodeURIComponent(name);
    var builds = builder.cachedBuilds.length ? [-1].concat(builder.cachedBuilds.slice(-10)) : [];
    var data = builder;

    return {
      name: name,
      url: endpoint + '/json/builders/' + path,
      html_url: endpoint + '/builders/' + path,
      builds_url: endpoint + '/json/builders/' + path + '/builds{/number}{?select*}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(build) {
    var name = build.builderName;
    var path = encodeURIComponent(name);
    var number = build.number;
    var building = build.times[0] && !build.times[1];
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/json/builders/' + path + '/builds/' + number,
      html_url: endpoint + '/builders/' + path + '/builds/' + number,
      state: building ? _constants.PENDING : BUILDBOT_STATE_LIST[build.results || 0] || _constants.UNKNOWN,
      start: new Date(build.times[0] * 1000),
      end: building ? null : new Date(build.times[1] * 1000),
      data: data
    };
  }
}
//# sourceMappingURL=data:application/json;base64,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LEtBQUssQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFFLGVBakp0QixPQUFPLEFBaUowQixBQUFDO0FBQ2xGLFdBQUssRUFBRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFFLENBQUMsQ0FBRSxHQUFHLElBQUksQ0FBQztBQUN4QyxTQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFFLENBQUMsQ0FBRSxHQUFHLElBQUksQ0FBQztBQUN4RCxVQUFJLEVBQUosSUFBSTtLQUNMLENBQUM7R0FDSDtDQUNGIiwiZmlsZSI6ImJ1aWxkYm90LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHVybHRlbXBsYXRlIGZyb20gJ3VybC10ZW1wbGF0ZSc7XG5pbXBvcnQgZmV0Y2ggZnJvbSAnLi9mZXRjaCc7XG5pbXBvcnQgeyBpbmhlcml0cyB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IHsgQWRhcHRlciB9IGZyb20gJy4vYWRhcHRlcic7XG5pbXBvcnQgeyBoYW5kbGVSZXNwb25zZSB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBQRU5ESU5HLCBTVUNDRVNTLCBXQVJOSU5HLCBGQUlMVVJFLCBFUlJPUkVELCBVTktOT1dOLCBVU0VSX0FHRU5UIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5jb25zdCBCVUlMREJPVF9NRURJQV9UWVBFID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuY29uc3QgQlVJTERCT1RfU1RBVEVfTElTVCA9IFtcbiAgU1VDQ0VTUyxcbiAgV0FSTklORyxcbiAgRkFJTFVSRSxcbiAgVU5LTk9XTixcbiAgRVJST1JFRCxcbiAgRVJST1JFRFxuXTtcblxuZnVuY3Rpb24gdW5pcXVlQnVpbGRzKGJ1aWxkcykge1xuICBjb25zdCBudW1iZXJzID0ge307XG5cbiAgcmV0dXJuIE9iamVjdC5rZXlzKGJ1aWxkcylcbiAgICAubWFwKGtleSA9PiBidWlsZHNba2V5XSlcbiAgICAuZmlsdGVyKGZ1bmN0aW9uICh7IG51bWJlciB9KSB7XG4gICAgICBpZiAobnVtYmVyc1sgbnVtYmVyIF0pIHJldHVybiBmYWxzZTtcbiAgICAgIHJldHVybiBudW1iZXJzWyBudW1iZXIgXSA9IHRydWU7XG4gICAgfSk7XG59XG5cbmluaGVyaXRzKEJ1aWxkYm90LCBBZGFwdGVyKTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gQnVpbGRib3QoZW5kcG9pbnQsIHsgaGVhZGVyczogaCwgdGFnIH0gPSB7fSkge1xuICBpZiAoISh0aGlzIGluc3RhbmNlb2YgQnVpbGRib3QpKSB7XG4gICAgcmV0dXJuIG5ldyBCdWlsZGJvdChlbmRwb2ludCwgeyBoZWFkZXJzOiBoLCB0YWcgfSk7XG4gIH1cblxuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgJ0FjY2VwdCc6IEJVSUxEQk9UX01FRElBX1RZUEUsXG4gICAgJ1VzZXItQWdlbnQnOiBVU0VSX0FHRU5UXG4gIH0sIGgpO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcblxuICBBZGFwdGVyLmNhbGwodGhpcyk7XG5cbiAgdGhpcy5nZXRJbmZvID0gZ2V0SW5mbztcbiAgdGhpcy5nZXRCdWlsZGVyID0gZ2V0QnVpbGRlcjtcbiAgdGhpcy5nZXRCdWlsZCA9IGdldEJ1aWxkO1xuICB0aGlzLmdldEJ1aWxkZXJzID0gZ2V0QnVpbGRlcnM7XG4gIHRoaXMuZ2V0QnVpbGRzID0gZ2V0QnVpbGRzO1xuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIGZldGNoKGAke2VuZHBvaW50fS9qc29uYCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihpbmZvLCBuYW1lKSB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShpbmZvLmJ1aWxkZXJzX3VybCk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbmFtZSB9KTtcblxuICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKChkYXRhKSA9PiBtYWtlQnVpbGRlcihuYW1lLCBkYXRhKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZChidWlsZGVyLCBudW1iZXIpIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKGJ1aWxkZXIuYnVpbGRzX3VybCk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgbnVtYmVyIH0pO1xuXG4gICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUJ1aWxkKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKGluZm8pIHtcbiAgICBjb25zdCBzZWxlY3QgPSBpbmZvLmJ1aWxkZXJzLm1hcChuYW1lID0+IG5hbWUucmVwbGFjZSgvXFwvL2csICclMkYnKSk7XG5cbiAgICBpZiAoc2VsZWN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XG4gICAgfVxuXG4gICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShpbmZvLmJ1aWxkZXJzX3VybCk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgc2VsZWN0IH0pO1xuXG4gICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4oZGF0YSA9PiBPYmplY3Qua2V5cyhkYXRhKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKGtleSA9PiBtYWtlQnVpbGRlcihrZXksIGRhdGFba2V5XSkpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkcyhidWlsZGVyKSB7XG4gICAgY29uc3Qgc2VsZWN0ID0gYnVpbGRlci5idWlsZHM7XG5cbiAgICBpZiAoc2VsZWN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XG4gICAgfVxuXG4gICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggYnVpbGRlci5idWlsZHNfdXJsICk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgc2VsZWN0IH0pO1xuXG4gICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4odW5pcXVlQnVpbGRzKVxuICAgICAgLnRoZW4oYnVpbGRzID0+IGJ1aWxkcy5tYXAobWFrZUJ1aWxkKSk7XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlSW5mbyhyb290KSB7XG4gICAgY29uc3QgbmFtZSA9IHJvb3QucHJvamVjdC50aXRsZTtcbiAgICBjb25zdCBidWlsZGVycyA9IE9iamVjdC5rZXlzKHJvb3QuYnVpbGRlcnMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKG5hbWUgPT4gIXRhZyB8fCByb290LmJ1aWxkZXJzW25hbWVdLnRhZ3MuaW5kZXhPZih0YWcpID49IDApO1xuICAgIGNvbnN0IGRhdGEgPSByb290O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9qc29uYCxcbiAgICAgIGh0bWxfdXJsOiBlbmRwb2ludCxcbiAgICAgIGJ1aWxkZXJzX3VybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnN7L25hbWV9ez9zZWxlY3QqfWAsXG4gICAgICBidWlsZGVycyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkZXIobmFtZSwgYnVpbGRlcikge1xuICAgIGNvbnN0IHBhdGggPSBlbmNvZGVVUklDb21wb25lbnQobmFtZSk7XG4gICAgY29uc3QgYnVpbGRzID0gYnVpbGRlci5jYWNoZWRCdWlsZHMubGVuZ3RoID8gWyAtMSBdLmNvbmNhdChidWlsZGVyLmNhY2hlZEJ1aWxkcy5zbGljZSgtMTApKSA6IFtdO1xuICAgIGNvbnN0IGRhdGEgPSBidWlsZGVyO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9qc29uL2J1aWxkZXJzLyR7cGF0aH1gLFxuICAgICAgaHRtbF91cmw6IGAke2VuZHBvaW50fS9idWlsZGVycy8ke3BhdGh9YCxcbiAgICAgIGJ1aWxkc191cmw6IGAke2VuZHBvaW50fS9qc29uL2J1aWxkZXJzLyR7cGF0aH0vYnVpbGRzey9udW1iZXJ9ez9zZWxlY3QqfWAsXG4gICAgICBidWlsZHMsXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VCdWlsZChidWlsZCkge1xuICAgIGNvbnN0IG5hbWUgPSBidWlsZC5idWlsZGVyTmFtZTtcbiAgICBjb25zdCBwYXRoID0gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpO1xuICAgIGNvbnN0IG51bWJlciA9IGJ1aWxkLm51bWJlcjtcbiAgICBjb25zdCBidWlsZGluZyA9IGJ1aWxkLnRpbWVzWyAwIF0gJiYgIWJ1aWxkLnRpbWVzWyAxIF07XG4gICAgY29uc3QgZGF0YSA9IGJ1aWxkO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBudW1iZXIsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9qc29uL2J1aWxkZXJzLyR7cGF0aH0vYnVpbGRzLyR7bnVtYmVyfWAsXG4gICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2J1aWxkZXJzLyR7cGF0aH0vYnVpbGRzLyR7bnVtYmVyfWAsXG4gICAgICBzdGF0ZTogYnVpbGRpbmcgPyBQRU5ESU5HIDogKEJVSUxEQk9UX1NUQVRFX0xJU1RbIGJ1aWxkLnJlc3VsdHMgfHwgMCBdIHx8IFVOS05PV04pLFxuICAgICAgc3RhcnQ6IG5ldyBEYXRlKGJ1aWxkLnRpbWVzWyAwIF0gKiAxMDAwKSxcbiAgICAgIGVuZDogYnVpbGRpbmcgPyBudWxsIDogbmV3IERhdGUoYnVpbGQudGltZXNbIDEgXSAqIDEwMDApLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cbn1cblxuIl19