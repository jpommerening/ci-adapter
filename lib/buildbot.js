'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Buildbot;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _util = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BUILDBOT_MEDIA_TYPE = 'application/json';
var BUILDBOT_STATE_LIST = [_constants.SUCCESS, _constants.WARNING, _constants.FAILURE, _constants.UNKNOWN, _constants.ERRORED, _constants.ERRORED];

function Buildbot(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;

  var headers = Object.assign({
    'Accept': BUILDBOT_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/json', options).then(_util.handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({ name: name });

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(function (data) {
      return makeBuilder(name, data);
    });
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(makeBuild);
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var select = info.builders;
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({ select: select });

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(function (data) {
      return Object.keys(data).map(function (key) {
        return makeBuilder(key, data[key]);
      });
    });
  }

  function getBuilds(name) {
    return getBuilder(name).then(function (builder) {
      var select = builder.builds;
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ select: select });

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(uniqueBuilds).then(function (builds) {
      return builds.map(makeBuild);
    });
  }

  function uniqueBuilds(builds) {
    var numbers = {};

    return Object.keys(builds).map(function (key) {
      return builds[key];
    }).filter(function (_ref2) {
      var number = _ref2.number;

      if (numbers[number]) return false;
      return numbers[number] = true;
    });
  }

  function makeInfo(root) {
    var name = root.project.title;
    var builders = Object.keys(root.builders);
    var data = root;

    return {
      name: name,
      url: endpoint + '/json',
      html_url: endpoint,
      builders_url: endpoint + '/json/builders{/name}{?select*}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(name, builder) {
    var builds = [-1].concat(builder.cachedBuilds);
    var data = builder;

    return {
      name: name,
      url: endpoint + '/json/builders/' + name,
      html_url: endpoint + '/builders/' + name,
      builds_url: endpoint + '/json/builders/' + name + '/builds{/number}{?select*}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(build) {
    var name = build.builderName;
    var number = build.number;
    var building = build.times[0] && !build.times[1];
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/json/builders/' + name + '/builds/' + number,
      html_url: endpoint + '/builders/' + name + '/builds/' + number,
      state: building ? _constants.PENDING : BUILDBOT_STATE_LIST[build.results || 0] || _constants.UNKNOWN,
      start: new Date(build.times[0] * 1000),
      end: building ? null : new Date(build.times[1] * 1000),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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TixNQUFNO0FBQ04sU0FBRyxFQUFLLFFBQVEsdUJBQWtCLElBQUksZ0JBQVcsTUFBTSxBQUFFO0FBQ3pELGNBQVEsRUFBSyxRQUFRLGtCQUFhLElBQUksZ0JBQVcsTUFBTSxBQUFFO0FBQ3pELFdBQUssRUFBRSxRQUFRLGNBbElaLE9BQU8sR0FrSW1CLG1CQUFtQixDQUFFLEtBQUssQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFFLGVBbEl0QixPQUFPLEFBa0kwQixBQUFDO0FBQ2xGLFdBQUssRUFBRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFFLENBQUMsQ0FBRSxHQUFHLElBQUksQ0FBQztBQUN4QyxTQUFHLEVBQUUsUUFBUSxHQUFHLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFFLENBQUMsQ0FBRSxHQUFHLElBQUksQ0FBQztBQUN4RCxVQUFJLEVBQUosSUFBSTtLQUNMLENBQUM7R0FDSDs7QUFFRCxTQUFPO0FBQ0wsV0FBTyxFQUFQLE9BQU87QUFDUCxjQUFVLEVBQVYsVUFBVTtBQUNWLGVBQVcsRUFBWCxXQUFXO0FBQ1gsWUFBUSxFQUFSLFFBQVE7QUFDUixhQUFTLEVBQVQsU0FBUztHQUNWLENBQUM7Q0FDSCIsImZpbGUiOiJidWlsZGJvdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmZXRjaCBmcm9tICcuL2ZldGNoJztcbmltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IHsgaGFuZGxlUmVzcG9uc2UgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgV0FSTklORywgRkFJTFVSRSwgRVJST1JFRCwgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgQlVJTERCT1RfTUVESUFfVFlQRSA9ICdhcHBsaWNhdGlvbi9qc29uJztcbmNvbnN0IEJVSUxEQk9UX1NUQVRFX0xJU1QgPSBbXG4gIFNVQ0NFU1MsXG4gIFdBUk5JTkcsXG4gIEZBSUxVUkUsXG4gIFVOS05PV04sXG4gIEVSUk9SRUQsXG4gIEVSUk9SRURcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEJ1aWxkYm90KGVuZHBvaW50LCB7IGhlYWRlcnM6IGggfSA9IHt9KSB7XG4gIGNvbnN0IGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAnQWNjZXB0JzogQlVJTERCT1RfTUVESUFfVFlQRSxcbiAgICAnVXNlci1BZ2VudCc6IFVTRVJfQUdFTlRcbiAgfSwgaCk7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgaGVhZGVyc1xuICB9O1xuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIGZldGNoKGAke2VuZHBvaW50fS9qc29uYCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4obWFrZUluZm8pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcihuYW1lKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShpbmZvLmJ1aWxkZXJzX3VybCk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG5hbWUgfSk7XG5cbiAgICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIH0pXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKChkYXRhKSA9PiBtYWtlQnVpbGRlcihuYW1lLCBkYXRhKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZChuYW1lLCBudW1iZXIpIHtcbiAgICByZXR1cm4gZ2V0QnVpbGRlcihuYW1lKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGJ1aWxkZXIpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShidWlsZGVyLmJ1aWxkc191cmwpO1xuICAgICAgICBjb25zdCB1cmwgPSB0ZW1wbGF0ZS5leHBhbmQoeyBudW1iZXIgfSk7XG5cbiAgICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucyk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAudGhlbihtYWtlQnVpbGQpO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcnMoKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ID0gaW5mby5idWlsZGVycztcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShpbmZvLmJ1aWxkZXJzX3VybCk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IHNlbGVjdCB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKGRhdGEgPT4gT2JqZWN0LmtleXMoZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChrZXkgPT4gbWFrZUJ1aWxkZXIoa2V5LCBkYXRhW2tleV0pKSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZHMobmFtZSkge1xuICAgIHJldHVybiBnZXRCdWlsZGVyKG5hbWUpXG4gICAgICAudGhlbihmdW5jdGlvbiAoYnVpbGRlcikge1xuICAgICAgICBjb25zdCBzZWxlY3QgPSBidWlsZGVyLmJ1aWxkcztcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggYnVpbGRlci5idWlsZHNfdXJsICk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IHNlbGVjdCB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKVxuICAgICAgfSlcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4odW5pcXVlQnVpbGRzKVxuICAgICAgLnRoZW4oYnVpbGRzID0+IGJ1aWxkcy5tYXAobWFrZUJ1aWxkKSk7XG4gIH1cblxuICBmdW5jdGlvbiB1bmlxdWVCdWlsZHMoYnVpbGRzKSB7XG4gICAgY29uc3QgbnVtYmVycyA9IHt9O1xuXG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGJ1aWxkcylcbiAgICAgIC5tYXAoa2V5ID0+IGJ1aWxkc1trZXldKVxuICAgICAgLmZpbHRlcihmdW5jdGlvbiAoeyBudW1iZXIgfSkge1xuICAgICAgICBpZiAobnVtYmVyc1sgbnVtYmVyIF0pIHJldHVybiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIG51bWJlcnNbIG51bWJlciBdID0gdHJ1ZTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUluZm8ocm9vdCkge1xuICAgIGNvbnN0IG5hbWUgPSByb290LnByb2plY3QudGl0bGU7XG4gICAgY29uc3QgYnVpbGRlcnMgPSBPYmplY3Qua2V5cyhyb290LmJ1aWxkZXJzKTtcbiAgICBjb25zdCBkYXRhID0gcm9vdDtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vanNvbmAsXG4gICAgICBodG1sX3VybDogZW5kcG9pbnQsXG4gICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9qc29uL2J1aWxkZXJzey9uYW1lfXs/c2VsZWN0Kn1gLFxuICAgICAgYnVpbGRlcnMsXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1ha2VCdWlsZGVyKG5hbWUsIGJ1aWxkZXIpIHtcbiAgICBjb25zdCBidWlsZHMgPSBbIC0xIF0uY29uY2F0KGJ1aWxkZXIuY2FjaGVkQnVpbGRzKTtcbiAgICBjb25zdCBkYXRhID0gYnVpbGRlcjtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vanNvbi9idWlsZGVycy8ke25hbWV9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtlbmRwb2ludH0vYnVpbGRlcnMvJHtuYW1lfWAsXG4gICAgICBidWlsZHNfdXJsOiBgJHtlbmRwb2ludH0vanNvbi9idWlsZGVycy8ke25hbWV9L2J1aWxkc3svbnVtYmVyfXs/c2VsZWN0Kn1gLFxuICAgICAgYnVpbGRzLFxuICAgICAgZGF0YVxuICAgIH07XG4gIH1cblxuICBmdW5jdGlvbiBtYWtlQnVpbGQoYnVpbGQpIHtcbiAgICBjb25zdCBuYW1lID0gYnVpbGQuYnVpbGRlck5hbWU7XG4gICAgY29uc3QgbnVtYmVyID0gYnVpbGQubnVtYmVyO1xuICAgIGNvbnN0IGJ1aWxkaW5nID0gYnVpbGQudGltZXNbIDAgXSAmJiAhYnVpbGQudGltZXNbIDEgXTtcbiAgICBjb25zdCBkYXRhID0gYnVpbGQ7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIG51bWJlcixcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfS9idWlsZHMvJHtudW1iZXJ9YCxcbiAgICAgIGh0bWxfdXJsOiBgJHtlbmRwb2ludH0vYnVpbGRlcnMvJHtuYW1lfS9idWlsZHMvJHtudW1iZXJ9YCxcbiAgICAgIHN0YXRlOiBidWlsZGluZyA/IFBFTkRJTkcgOiAoQlVJTERCT1RfU1RBVEVfTElTVFsgYnVpbGQucmVzdWx0cyB8fCAwIF0gfHwgVU5LTk9XTiksXG4gICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQudGltZXNbIDAgXSAqIDEwMDApLFxuICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC50aW1lc1sgMSBdICogMTAwMCksXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2V0SW5mbyxcbiAgICBnZXRCdWlsZGVyLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkLFxuICAgIGdldEJ1aWxkc1xuICB9O1xufVxuIl19