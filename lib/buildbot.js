'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Buildbot;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BUILDBOT_MEDIA_TYPE = 'application/json';
var BUILDBOT_STATE_LIST = [_constants.SUCCESS, _constants.WARNING, _constants.FAILURE, _constants.UNKNOWN, _constants.ERRORED, _constants.ERRORED];

function Buildbot(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;

  var headers = Object.assign({
    'Accept': BUILDBOT_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/json', options).then(function (response) {
      return response.json();
    }).then(function (root) {
      return {
        name: root.project.title,
        url: endpoint + '/json',
        html_url: endpoint,
        builders_url: endpoint + '/json/builders{/name}',
        builders: Object.keys(root.builders),
        data: root
      };
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({});

      return (0, _fetch2.default)(url, options);
    }).then(function (response) {
      return response.json();
    }).then(function (builders) {
      return Object.keys(builders).map(function (key) {
        var name = key;
        var builder = builders[key];
        var builds = [-1].concat(builder.cachedBuilds);

        return {
          name: name,
          url: endpoint + '/json/builders/' + name,
          html_url: endpoint + '/builders/' + name,
          builds_url: endpoint + '/json/builders/' + name + '/builds{/number}{?select*}',
          builds: builds,
          data: builder
        };
      });
    });
  }

  function getBuilds(builder) {
    var select = builder.builds;
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ select: select });

    return (0, _fetch2.default)(url, options).then(function (response) {
      return response.json();
    }).then(function (builds) {
      var numbers = {};

      return Object.keys(builds).map(function (key) {
        return builds[key];
      }).filter(function (_ref2) {
        var number = _ref2.number;

        if (numbers[number]) return false;
        return numbers[number] = true;
      }).map(function (build) {
        var building = build.times[0] && !build.times[1];

        return {
          name: builder.name,
          number: build.number,
          url: endpoint + '/json/builders/' + builder.name + '/builds/' + build.number,
          html_url: endpoint + '/builders/' + builder.name + '/builds/' + build.number,
          state: building ? _constants.PENDING : BUILDBOT_STATE_LIST[build.results || 0] || _constants.UNKNOWN,
          start: new Date(build.times[0] * 1000),
          end: building ? null : new Date(build.times[1] * 1000),
          data: build
        };
      });
    });
  }

  return {
    getInfo: getInfo,
    getBuilders: getBuilders,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9idWlsZGJvdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztrQkFjd0IsUUFBUTs7Ozs7Ozs7Ozs7Ozs7QUFWaEMsSUFBTSxtQkFBbUIsR0FBRyxrQkFBa0IsQ0FBQztBQUMvQyxJQUFNLG1CQUFtQixHQUFHLFlBSFYsT0FBTyxhQUFFLE9BQU8sYUFBRSxPQUFPLGFBQVcsT0FBTyxhQUFoQixPQUFPLGFBQVAsT0FBTyxDQVVuRCxDQUFDOztBQUVhLFNBQVMsUUFBUSxDQUFDLFFBQVEsRUFBdUI7bUVBQUosRUFBRTs7TUFBUixDQUFDLFFBQVYsT0FBTzs7QUFDbEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQztBQUM1QixZQUFRLEVBQUUsbUJBQW1CO0FBQzdCLGdCQUFZLGFBZitDLFVBQVUsQUFlN0M7R0FDekIsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNOLE1BQU0sT0FBTyxHQUFHO0FBQ2QsV0FBTyxFQUFQLE9BQU87R0FDUixDQUFDOztBQUVGLFdBQVMsT0FBTyxHQUFHO0FBQ2pCLFdBQU8scUJBQVMsUUFBUSxZQUFTLE9BQU8sQ0FBQyxDQUN0QyxJQUFJLENBQUMsVUFBVSxRQUFRLEVBQUU7QUFDeEIsYUFBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDeEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRTtBQUN0QixhQUFPO0FBQ0wsWUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSztBQUN4QixXQUFHLEVBQUssUUFBUSxVQUFPO0FBQ3ZCLGdCQUFRLEVBQUUsUUFBUTtBQUNsQixvQkFBWSxFQUFLLFFBQVEsMEJBQXVCO0FBQ2hELGdCQUFRLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQ3BDLFlBQUksRUFBRSxJQUFJO09BQ1gsQ0FBQztLQUNILENBQUMsQ0FBQztHQUNOOztBQUVELFdBQVMsV0FBVyxHQUFHO0FBQ3JCLFdBQU8sT0FBTyxFQUFFLENBQ2IsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFO0FBQ3BCLFVBQU0sUUFBUSxHQUFHLHNCQUFZLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEQsVUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQzs7QUFFaEMsYUFBTyxxQkFBTSxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLFFBQVEsRUFBRTtBQUMxQixhQUFPLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztLQUN4QixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsUUFBUSxFQUFFO0FBQzFCLGFBQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEVBQUU7QUFDOUMsWUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDO0FBQ2pCLFlBQU0sT0FBTyxHQUFHLFFBQVEsQ0FBRSxHQUFHLENBQUUsQ0FBQztBQUNoQyxZQUFNLE1BQU0sR0FBRyxDQUFFLENBQUMsQ0FBQyxDQUFFLENBQUMsTUFBTSxDQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUUsQ0FBQzs7QUFFckQsZUFBTztBQUNMLGNBQUksRUFBRSxJQUFJO0FBQ1YsYUFBRyxFQUFLLFFBQVEsdUJBQWtCLElBQUksQUFBRTtBQUN4QyxrQkFBUSxFQUFLLFFBQVEsa0JBQWEsSUFBSSxBQUFFO0FBQ3hDLG9CQUFVLEVBQUssUUFBUSx1QkFBa0IsSUFBSSwrQkFBNEI7QUFDekUsZ0JBQU0sRUFBRSxNQUFNO0FBQ2QsY0FBSSxFQUFFLE9BQU87U0FDZCxDQUFDO09BQ0gsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ047O0FBRUQsV0FBUyxTQUFTLENBQUMsT0FBTyxFQUFFO0FBQzFCLFFBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDOUIsUUFBTSxRQUFRLEdBQUcsc0JBQVksS0FBSyxDQUFFLE9BQU8sQ0FBQyxVQUFVLENBQUUsQ0FBQztBQUN6RCxRQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFOLE1BQU0sRUFBRSxDQUFDLENBQUM7O0FBRXhDLFdBQU8scUJBQU0sR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUN2QixJQUFJLENBQUMsVUFBVSxRQUFRLEVBQUU7QUFDeEIsYUFBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDeEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLE1BQU0sRUFBRTtBQUN4QixVQUFNLE9BQU8sR0FBRyxFQUFFLENBQUM7O0FBRW5CLGFBQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEVBQUU7QUFDNUMsZUFBTyxNQUFNLENBQUUsR0FBRyxDQUFFLENBQUM7T0FDdEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxpQkFBc0I7WUFBVixNQUFNLFNBQU4sTUFBTTs7QUFDMUIsWUFBSSxPQUFPLENBQUUsTUFBTSxDQUFFLEVBQUUsT0FBTyxLQUFLLENBQUM7QUFDcEMsZUFBTyxPQUFPLENBQUUsTUFBTSxDQUFFLEdBQUcsSUFBSSxDQUFDO09BQ2pDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxLQUFLLEVBQUU7QUFDdEIsWUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUUsQ0FBQyxDQUFFLENBQUM7O0FBRXZELGVBQU87QUFDTCxjQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7QUFDbEIsZ0JBQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtBQUNwQixhQUFHLEVBQUssUUFBUSx1QkFBa0IsT0FBTyxDQUFDLElBQUksZ0JBQVcsS0FBSyxDQUFDLE1BQU0sQUFBRTtBQUN2RSxrQkFBUSxFQUFLLFFBQVEsa0JBQWEsT0FBTyxDQUFDLElBQUksZ0JBQVcsS0FBSyxDQUFDLE1BQU0sQUFBRTtBQUN2RSxlQUFLLEVBQUUsUUFBUSxjQXhGbEIsT0FBTyxHQXdGMEIsbUJBQW1CLENBQUUsS0FBSyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUUsZUF4RjdCLE9BQU8sQUF3RmlDLEFBQUU7QUFDcEYsZUFBSyxFQUFFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUUsQ0FBQyxDQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ3hDLGFBQUcsRUFBRSxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUUsQ0FBQyxDQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ3hELGNBQUksRUFBRSxLQUFLO1NBQ1osQ0FBQztPQUNILENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQztHQUNOOztBQUVELFNBQU87QUFDTCxXQUFPLEVBQVAsT0FBTztBQUNQLGVBQVcsRUFBWCxXQUFXO0FBQ1gsYUFBUyxFQUFULFNBQVM7R0FDVixDQUFDO0NBQ0giLCJmaWxlIjoiYnVpbGRib3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnLi9mZXRjaCc7XG5pbXBvcnQgdXJsdGVtcGxhdGUgZnJvbSAndXJsLXRlbXBsYXRlJztcbmltcG9ydCB7IFBFTkRJTkcsIFNVQ0NFU1MsIFdBUk5JTkcsIEZBSUxVUkUsIEVSUk9SRUQsIFVOS05PV04sIFVTRVJfQUdFTlQgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbmNvbnN0IEJVSUxEQk9UX01FRElBX1RZUEUgPSAnYXBwbGljYXRpb24vanNvbic7XG5jb25zdCBCVUlMREJPVF9TVEFURV9MSVNUID0gW1xuICBTVUNDRVNTLFxuICBXQVJOSU5HLFxuICBGQUlMVVJFLFxuICBVTktOT1dOLFxuICBFUlJPUkVELFxuICBFUlJPUkVEXG5dO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBCdWlsZGJvdChlbmRwb2ludCwgeyBoZWFkZXJzOiBoIH0gPSB7fSkge1xuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgJ0FjY2VwdCc6IEJVSUxEQk9UX01FRElBX1RZUEUsXG4gICAgJ1VzZXItQWdlbnQnOiBVU0VSX0FHRU5UXG4gIH0sIGgpO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcblxuICBmdW5jdGlvbiBnZXRJbmZvKCkge1xuICAgIHJldHVybiBmZXRjaChgJHtlbmRwb2ludH0vanNvbmAsIG9wdGlvbnMpXG4gICAgICAudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJvb3QpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiByb290LnByb2plY3QudGl0bGUsXG4gICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vanNvbmAsXG4gICAgICAgICAgaHRtbF91cmw6IGVuZHBvaW50LFxuICAgICAgICAgIGJ1aWxkZXJzX3VybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnN7L25hbWV9YCxcbiAgICAgICAgICBidWlsZGVyczogT2JqZWN0LmtleXMocm9vdC5idWlsZGVycyksXG4gICAgICAgICAgZGF0YTogcm9vdFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZGVycygpIHtcbiAgICByZXR1cm4gZ2V0SW5mbygpXG4gICAgICAudGhlbihmdW5jdGlvbiAoaW5mbykge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKGluZm8uYnVpbGRlcnNfdXJsKTtcbiAgICAgICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHt9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICB9KS50aGVuKGZ1bmN0aW9uIChidWlsZGVycykge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoYnVpbGRlcnMpLm1hcChmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgICAgY29uc3QgbmFtZSA9IGtleTtcbiAgICAgICAgICBjb25zdCBidWlsZGVyID0gYnVpbGRlcnNbIGtleSBdO1xuICAgICAgICAgIGNvbnN0IGJ1aWxkcyA9IFsgLTEgXS5jb25jYXQoIGJ1aWxkZXIuY2FjaGVkQnVpbGRzICk7XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfWAsXG4gICAgICAgICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2J1aWxkZXJzLyR7bmFtZX1gLFxuICAgICAgICAgICAgYnVpbGRzX3VybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfS9idWlsZHN7L251bWJlcn17P3NlbGVjdCp9YCxcbiAgICAgICAgICAgIGJ1aWxkczogYnVpbGRzLFxuICAgICAgICAgICAgZGF0YTogYnVpbGRlclxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCdWlsZHMoYnVpbGRlcikge1xuICAgIGNvbnN0IHNlbGVjdCA9IGJ1aWxkZXIuYnVpbGRzO1xuICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoIGJ1aWxkZXIuYnVpbGRzX3VybCApO1xuICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IHNlbGVjdCB9KTtcblxuICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGJ1aWxkcykge1xuICAgICAgICBjb25zdCBudW1iZXJzID0ge307XG5cbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGJ1aWxkcykubWFwKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICByZXR1cm4gYnVpbGRzWyBrZXkgXTtcbiAgICAgICAgfSkuZmlsdGVyKGZ1bmN0aW9uICh7IG51bWJlciB9KSB7XG4gICAgICAgICAgaWYgKG51bWJlcnNbIG51bWJlciBdKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuIG51bWJlcnNbIG51bWJlciBdID0gdHJ1ZTtcbiAgICAgICAgfSkubWFwKGZ1bmN0aW9uIChidWlsZCkge1xuICAgICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYnVpbGQudGltZXNbIDAgXSAmJiAhYnVpbGQudGltZXNbIDEgXTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiBidWlsZGVyLm5hbWUsXG4gICAgICAgICAgICBudW1iZXI6IGJ1aWxkLm51bWJlcixcbiAgICAgICAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtidWlsZGVyLm5hbWV9L2J1aWxkcy8ke2J1aWxkLm51bWJlcn1gLFxuICAgICAgICAgICAgaHRtbF91cmw6IGAke2VuZHBvaW50fS9idWlsZGVycy8ke2J1aWxkZXIubmFtZX0vYnVpbGRzLyR7YnVpbGQubnVtYmVyfWAsXG4gICAgICAgICAgICBzdGF0ZTogYnVpbGRpbmcgPyBQRU5ESU5HIDogKCBCVUlMREJPVF9TVEFURV9MSVNUWyBidWlsZC5yZXN1bHRzIHx8IDAgXSB8fCBVTktOT1dOICksXG4gICAgICAgICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQudGltZXNbIDAgXSAqIDEwMDApLFxuICAgICAgICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC50aW1lc1sgMSBdICogMTAwMCksXG4gICAgICAgICAgICBkYXRhOiBidWlsZFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGdldEluZm8sXG4gICAgZ2V0QnVpbGRlcnMsXG4gICAgZ2V0QnVpbGRzXG4gIH07XG59XG4iXX0=