'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Buildbot;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _util = require('./util');

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BUILDBOT_MEDIA_TYPE = 'application/json';
var BUILDBOT_STATE_LIST = [_constants.SUCCESS, _constants.WARNING, _constants.FAILURE, _constants.UNKNOWN, _constants.ERRORED, _constants.ERRORED];

function Buildbot(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;

  var headers = Object.assign({
    'Accept': BUILDBOT_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/json', options).then(_util.handleResponse).then(makeInfo);
  }

  function getBuilder(name) {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({ name: name });

      return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(function (data) {
        return makeBuilder(name, data);
      });
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({});

      return (0, _fetch2.default)(url, options);
    }).then(_util.handleResponse).then(function (builders) {
      return Object.keys(builders).map(function (name) {
        return makeBuilder(name, builders[name]);
      });
    });
  }

  function getBuild(name, number) {
    return getBuilder(name).then(function (builder) {
      var template = _urlTemplate2.default.parse(builder.builds_url);
      var url = template.expand({ number: number });

      return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(makeBuild);
    });
  }

  function getBuilds(builder) {
    var select = builder.builds;
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ select: select });

    return (0, _fetch2.default)(url, options).then(_util.handleResponse).then(uniqueBuilds).then(function (builds) {
      return builds.map(makeBuild);
    });
  }

  function uniqueBuilds(builds) {
    var numbers = {};

    return Object.keys(builds).map(function (key) {
      return builds[key];
    }).filter(function (_ref2) {
      var number = _ref2.number;

      if (numbers[number]) return false;
      return numbers[number] = true;
    });
  }

  function makeInfo(root) {
    var name = root.project.title;
    var builders = Object.keys(root.builders);
    var data = root;

    return {
      name: name,
      url: endpoint + '/json',
      html_url: endpoint,
      builders_url: endpoint + '/json/builders{/name}',
      builders: builders,
      data: data
    };
  }

  function makeBuilder(name, builder) {
    var builds = [-1].concat(builder.cachedBuilds);
    var data = builder;

    return {
      name: name,
      url: endpoint + '/json/builders/' + name,
      html_url: endpoint + '/builders/' + name,
      builds_url: endpoint + '/json/builders/' + name + '/builds{/number}{?select*}',
      builds: builds,
      data: data
    };
  }

  function makeBuild(build) {
    var name = build.builderName;
    var number = build.number;
    var building = build.times[0] && !build.times[1];
    var data = build;

    return {
      name: name,
      number: number,
      url: endpoint + '/json/builders/' + name + '/builds/' + number,
      html_url: endpoint + '/builders/' + name + '/builds/' + number,
      state: building ? _constants.PENDING : BUILDBOT_STATE_LIST[build.results || 0] || _constants.UNKNOWN,
      start: new Date(build.times[0] * 1000),
      end: building ? null : new Date(build.times[1] * 1000),
      data: data
    };
  }

  return {
    getInfo: getInfo,
    getBuilder: getBuilder,
    getBuilders: getBuilders,
    getBuild: getBuild,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9idWlsZGJvdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztrQkFld0IsUUFBUTs7Ozs7Ozs7Ozs7Ozs7OztBQVZoQyxJQUFNLG1CQUFtQixHQUFHLGtCQUFrQixDQUFDO0FBQy9DLElBQU0sbUJBQW1CLEdBQUcsWUFIVixPQUFPLGFBQUUsT0FBTyxhQUFFLE9BQU8sYUFBVyxPQUFPLGFBQWhCLE9BQU8sYUFBUCxPQUFPLENBVW5ELENBQUM7O0FBRWEsU0FBUyxRQUFRLENBQUMsUUFBUSxFQUF1QjttRUFBSixFQUFFOztNQUFSLENBQUMsUUFBVixPQUFPOztBQUNsRCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO0FBQzVCLFlBQVEsRUFBRSxtQkFBbUI7QUFDN0IsZ0JBQVksYUFmK0MsVUFBVSxBQWU3QztHQUN6QixFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ04sTUFBTSxPQUFPLEdBQUc7QUFDZCxXQUFPLEVBQVAsT0FBTztHQUNSLENBQUM7O0FBRUYsV0FBUyxPQUFPLEdBQUc7QUFDakIsV0FBTyxxQkFBUyxRQUFRLFlBQVMsT0FBTyxDQUFDLENBQ3RDLElBQUksT0F4QkYsY0FBYyxDQXdCSSxDQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7R0FDbkI7O0FBRUQsV0FBUyxVQUFVLENBQUMsSUFBSSxFQUFFO0FBQ3hCLFdBQU8sT0FBTyxFQUFFLENBQ2IsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFO0FBQ3BCLFVBQU0sUUFBUSxHQUFHLHNCQUFZLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEQsVUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBSixJQUFJLEVBQUUsQ0FBQyxDQUFDOztBQUV0QyxhQUFPLHFCQUFNLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FDdkIsSUFBSSxPQW5DTixjQUFjLENBbUNRLENBQ3BCLElBQUksQ0FBQyxVQUFDLElBQUk7ZUFBSyxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztPQUFBLENBQUMsQ0FBQztLQUM1QyxDQUFDLENBQUM7R0FDTjs7QUFFRCxXQUFTLFdBQVcsR0FBRztBQUNyQixXQUFPLE9BQU8sRUFBRSxDQUNiLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRTtBQUNwQixVQUFNLFFBQVEsR0FBRyxzQkFBWSxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3RELFVBQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7O0FBRWhDLGFBQU8scUJBQU0sR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQzVCLENBQUMsQ0FDRCxJQUFJLE9BaERGLGNBQWMsQ0FnREksQ0FDcEIsSUFBSSxDQUFDLFVBQVUsUUFBUSxFQUFFO0FBQ3hCLGFBQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQyxJQUFJO2VBQUssV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7T0FBQSxDQUFDLENBQUM7S0FDL0UsQ0FBQyxDQUFDO0dBQ047O0FBRUQsV0FBUyxRQUFRLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRTtBQUM5QixXQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FDcEIsSUFBSSxDQUFDLFVBQVUsT0FBTyxFQUFFO0FBQ3ZCLFVBQU0sUUFBUSxHQUFHLHNCQUFZLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDdkQsVUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBTixNQUFNLEVBQUUsQ0FBQyxDQUFDOztBQUV4QyxhQUFPLHFCQUFNLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FDdkIsSUFBSSxPQTdETixjQUFjLENBNkRRLENBQ3BCLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUNwQixDQUFDLENBQUM7R0FDTjs7QUFFRCxXQUFTLFNBQVMsQ0FBQyxPQUFPLEVBQUU7QUFDMUIsUUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUM5QixRQUFNLFFBQVEsR0FBRyxzQkFBWSxLQUFLLENBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBRSxDQUFDO0FBQ3pELFFBQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQU4sTUFBTSxFQUFFLENBQUMsQ0FBQzs7QUFFeEMsV0FBTyxxQkFBTSxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQ3ZCLElBQUksT0F4RUYsY0FBYyxDQXdFSSxDQUNwQixJQUFJLENBQUMsWUFBWSxDQUFDLENBQ2xCLElBQUksQ0FBQyxVQUFBLE1BQU07YUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQztLQUFBLENBQUMsQ0FBQztHQUMxQzs7QUFFRCxXQUFTLFlBQVksQ0FBQyxNQUFNLEVBQUU7QUFDNUIsUUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDOztBQUVuQixXQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxFQUFFO0FBQzVDLGFBQU8sTUFBTSxDQUFFLEdBQUcsQ0FBRSxDQUFDO0tBQ3RCLENBQUMsQ0FBQyxNQUFNLENBQUMsaUJBQXNCO1VBQVYsTUFBTSxTQUFOLE1BQU07O0FBQzFCLFVBQUksT0FBTyxDQUFFLE1BQU0sQ0FBRSxFQUFFLE9BQU8sS0FBSyxDQUFDO0FBQ3BDLGFBQU8sT0FBTyxDQUFFLE1BQU0sQ0FBRSxHQUFHLElBQUksQ0FBQztLQUNqQyxDQUFDLENBQUM7R0FDSjs7QUFFRCxXQUFTLFFBQVEsQ0FBQyxJQUFJLEVBQUU7QUFDdEIsUUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7QUFDaEMsUUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDNUMsUUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDOztBQUVsQixXQUFPO0FBQ0wsVUFBSSxFQUFKLElBQUk7QUFDSixTQUFHLEVBQUssUUFBUSxVQUFPO0FBQ3ZCLGNBQVEsRUFBRSxRQUFRO0FBQ2xCLGtCQUFZLEVBQUssUUFBUSwwQkFBdUI7QUFDaEQsY0FBUSxFQUFSLFFBQVE7QUFDUixVQUFJLEVBQUosSUFBSTtLQUNMLENBQUM7R0FDSDs7QUFFRCxXQUFTLFdBQVcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO0FBQ2xDLFFBQU0sTUFBTSxHQUFHLENBQUUsQ0FBQyxDQUFDLENBQUUsQ0FBQyxNQUFNLENBQUUsT0FBTyxDQUFDLFlBQVksQ0FBRSxDQUFDO0FBQ3JELFFBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQzs7QUFFckIsV0FBTztBQUNMLFVBQUksRUFBSixJQUFJO0FBQ0osU0FBRyxFQUFLLFFBQVEsdUJBQWtCLElBQUksQUFBRTtBQUN4QyxjQUFRLEVBQUssUUFBUSxrQkFBYSxJQUFJLEFBQUU7QUFDeEMsZ0JBQVUsRUFBSyxRQUFRLHVCQUFrQixJQUFJLCtCQUE0QjtBQUN6RSxZQUFNLEVBQU4sTUFBTTtBQUNOLFVBQUksRUFBSixJQUFJO0tBQ0wsQ0FBQztHQUNIOztBQUVELFdBQVMsU0FBUyxDQUFDLEtBQUssRUFBRTtBQUN4QixRQUFNLElBQUksR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO0FBQy9CLFFBQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7QUFDNUIsUUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUUsQ0FBQyxDQUFFLENBQUM7QUFDdkQsUUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDOztBQUVuQixXQUFPO0FBQ0wsVUFBSSxFQUFKLElBQUk7QUFDSixZQUFNLEVBQU4sTUFBTTtBQUNOLFNBQUcsRUFBSyxRQUFRLHVCQUFrQixJQUFJLGdCQUFXLE1BQU0sQUFBRTtBQUN6RCxjQUFRLEVBQUssUUFBUSxrQkFBYSxJQUFJLGdCQUFXLE1BQU0sQUFBRTtBQUN6RCxXQUFLLEVBQUUsUUFBUSxjQS9IWixPQUFPLEdBK0hvQixtQkFBbUIsQ0FBRSxLQUFLLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBRSxlQS9IdkIsT0FBTyxBQStIMkIsQUFBRTtBQUNwRixXQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUM7QUFDeEMsU0FBRyxFQUFFLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUM7QUFDeEQsVUFBSSxFQUFKLElBQUk7S0FDTCxDQUFDO0dBQ0g7O0FBRUQsU0FBTztBQUNMLFdBQU8sRUFBUCxPQUFPO0FBQ1AsY0FBVSxFQUFWLFVBQVU7QUFDVixlQUFXLEVBQVgsV0FBVztBQUNYLFlBQVEsRUFBUixRQUFRO0FBQ1IsYUFBUyxFQUFULFNBQVM7R0FDVixDQUFDO0NBQ0giLCJmaWxlIjoiYnVpbGRib3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmV0Y2ggZnJvbSAnLi9mZXRjaCc7XG5pbXBvcnQgdXJsdGVtcGxhdGUgZnJvbSAndXJsLXRlbXBsYXRlJztcbmltcG9ydCB7IGhhbmRsZVJlc3BvbnNlIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IFBFTkRJTkcsIFNVQ0NFU1MsIFdBUk5JTkcsIEZBSUxVUkUsIEVSUk9SRUQsIFVOS05PV04sIFVTRVJfQUdFTlQgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbmNvbnN0IEJVSUxEQk9UX01FRElBX1RZUEUgPSAnYXBwbGljYXRpb24vanNvbic7XG5jb25zdCBCVUlMREJPVF9TVEFURV9MSVNUID0gW1xuICBTVUNDRVNTLFxuICBXQVJOSU5HLFxuICBGQUlMVVJFLFxuICBVTktOT1dOLFxuICBFUlJPUkVELFxuICBFUlJPUkVEXG5dO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBCdWlsZGJvdChlbmRwb2ludCwgeyBoZWFkZXJzOiBoIH0gPSB7fSkge1xuICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7XG4gICAgJ0FjY2VwdCc6IEJVSUxEQk9UX01FRElBX1RZUEUsXG4gICAgJ1VzZXItQWdlbnQnOiBVU0VSX0FHRU5UXG4gIH0sIGgpO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIGhlYWRlcnNcbiAgfTtcblxuICBmdW5jdGlvbiBnZXRJbmZvKCkge1xuICAgIHJldHVybiBmZXRjaChgJHtlbmRwb2ludH0vanNvbmAsIG9wdGlvbnMpXG4gICAgICAudGhlbihoYW5kbGVSZXNwb25zZSlcbiAgICAgIC50aGVuKG1ha2VJbmZvKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXIobmFtZSkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoaW5mby5idWlsZGVyc191cmwpO1xuICAgICAgICBjb25zdCB1cmwgPSB0ZW1wbGF0ZS5leHBhbmQoeyBuYW1lIH0pO1xuXG4gICAgICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpXG4gICAgICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAgICAgLnRoZW4oKGRhdGEpID0+IG1ha2VCdWlsZGVyKG5hbWUsIGRhdGEpKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRlcnMoKSB7XG4gICAgcmV0dXJuIGdldEluZm8oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZShpbmZvLmJ1aWxkZXJzX3VybCk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7fSk7XG5cbiAgICAgICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucyk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oaGFuZGxlUmVzcG9uc2UpXG4gICAgICAudGhlbihmdW5jdGlvbiAoYnVpbGRlcnMpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGJ1aWxkZXJzKS5tYXAoKG5hbWUpID0+IG1ha2VCdWlsZGVyKG5hbWUsIGJ1aWxkZXJzW25hbWVdKSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkKG5hbWUsIG51bWJlcikge1xuICAgIHJldHVybiBnZXRCdWlsZGVyKG5hbWUpXG4gICAgICAudGhlbihmdW5jdGlvbiAoYnVpbGRlcikge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHVybHRlbXBsYXRlLnBhcnNlKGJ1aWxkZXIuYnVpbGRzX3VybCk7XG4gICAgICAgIGNvbnN0IHVybCA9IHRlbXBsYXRlLmV4cGFuZCh7IG51bWJlciB9KTtcblxuICAgICAgICByZXR1cm4gZmV0Y2godXJsLCBvcHRpb25zKVxuICAgICAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgICAgIC50aGVuKG1ha2VCdWlsZCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkcyhidWlsZGVyKSB7XG4gICAgY29uc3Qgc2VsZWN0ID0gYnVpbGRlci5idWlsZHM7XG4gICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggYnVpbGRlci5idWlsZHNfdXJsICk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgc2VsZWN0IH0pO1xuXG4gICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGhhbmRsZVJlc3BvbnNlKVxuICAgICAgLnRoZW4odW5pcXVlQnVpbGRzKVxuICAgICAgLnRoZW4oYnVpbGRzID0+IGJ1aWxkcy5tYXAobWFrZUJ1aWxkKSk7XG4gIH1cblxuICBmdW5jdGlvbiB1bmlxdWVCdWlsZHMoYnVpbGRzKSB7XG4gICAgY29uc3QgbnVtYmVycyA9IHt9O1xuXG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGJ1aWxkcykubWFwKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgIHJldHVybiBidWlsZHNbIGtleSBdO1xuICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoeyBudW1iZXIgfSkge1xuICAgICAgaWYgKG51bWJlcnNbIG51bWJlciBdKSByZXR1cm4gZmFsc2U7XG4gICAgICByZXR1cm4gbnVtYmVyc1sgbnVtYmVyIF0gPSB0cnVlO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUluZm8ocm9vdCkge1xuICAgIGNvbnN0IG5hbWUgPSByb290LnByb2plY3QudGl0bGU7XG4gICAgY29uc3QgYnVpbGRlcnMgPSBPYmplY3Qua2V5cyhyb290LmJ1aWxkZXJzKTtcbiAgICBjb25zdCBkYXRhID0gcm9vdDtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgdXJsOiBgJHtlbmRwb2ludH0vanNvbmAsXG4gICAgICBodG1sX3VybDogZW5kcG9pbnQsXG4gICAgICBidWlsZGVyc191cmw6IGAke2VuZHBvaW50fS9qc29uL2J1aWxkZXJzey9uYW1lfWAsXG4gICAgICBidWlsZGVycyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkZXIobmFtZSwgYnVpbGRlcikge1xuICAgIGNvbnN0IGJ1aWxkcyA9IFsgLTEgXS5jb25jYXQoIGJ1aWxkZXIuY2FjaGVkQnVpbGRzICk7XG4gICAgY29uc3QgZGF0YSA9IGJ1aWxkZXI7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfWAsXG4gICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2J1aWxkZXJzLyR7bmFtZX1gLFxuICAgICAgYnVpbGRzX3VybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfS9idWlsZHN7L251bWJlcn17P3NlbGVjdCp9YCxcbiAgICAgIGJ1aWxkcyxcbiAgICAgIGRhdGFcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gbWFrZUJ1aWxkKGJ1aWxkKSB7XG4gICAgY29uc3QgbmFtZSA9IGJ1aWxkLmJ1aWxkZXJOYW1lO1xuICAgIGNvbnN0IG51bWJlciA9IGJ1aWxkLm51bWJlcjtcbiAgICBjb25zdCBidWlsZGluZyA9IGJ1aWxkLnRpbWVzWyAwIF0gJiYgIWJ1aWxkLnRpbWVzWyAxIF07XG4gICAgY29uc3QgZGF0YSA9IGJ1aWxkO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBudW1iZXIsXG4gICAgICB1cmw6IGAke2VuZHBvaW50fS9qc29uL2J1aWxkZXJzLyR7bmFtZX0vYnVpbGRzLyR7bnVtYmVyfWAsXG4gICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2J1aWxkZXJzLyR7bmFtZX0vYnVpbGRzLyR7bnVtYmVyfWAsXG4gICAgICBzdGF0ZTogYnVpbGRpbmcgPyBQRU5ESU5HIDogKCBCVUlMREJPVF9TVEFURV9MSVNUWyBidWlsZC5yZXN1bHRzIHx8IDAgXSB8fCBVTktOT1dOICksXG4gICAgICBzdGFydDogbmV3IERhdGUoYnVpbGQudGltZXNbIDAgXSAqIDEwMDApLFxuICAgICAgZW5kOiBidWlsZGluZyA/IG51bGwgOiBuZXcgRGF0ZShidWlsZC50aW1lc1sgMSBdICogMTAwMCksXG4gICAgICBkYXRhXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2V0SW5mbyxcbiAgICBnZXRCdWlsZGVyLFxuICAgIGdldEJ1aWxkZXJzLFxuICAgIGdldEJ1aWxkLFxuICAgIGdldEJ1aWxkc1xuICB9O1xufVxuIl19