'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Buildbot;

var _fetch = require('./fetch');

var _fetch2 = _interopRequireDefault(_fetch);

var _urlTemplate = require('url-template');

var _urlTemplate2 = _interopRequireDefault(_urlTemplate);

var _constants = require('./constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BUILDBOT_MEDIA_TYPE = 'application/json';
var BUILDBOT_STATE_LIST = [_constants.SUCCESS, _constants.WARNING, _constants.FAILURE, _constants.UNKNOWN, _constants.ERRORED, _constants.ERRORED];

function Buildbot(endpoint) {
  var _ref = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  var h = _ref.headers;

  var headers = Object.assign({
    'Accept': BUILDBOT_MEDIA_TYPE,
    'User-Agent': _constants.USER_AGENT
  }, h);
  var options = {
    headers: headers
  };

  function getInfo() {
    return (0, _fetch2.default)(endpoint + '/json', options).then(function (response) {
      return response.json();
    }).then(function (root) {
      return {
        name: root.project.title,
        url: endpoint + '/json',
        html_url: endpoint,
        builders_url: endpoint + '/json/builders{/name}',
        builders: Object.keys(root.builders),
        data: root
      };
    });
  }

  function getBuilders() {
    return getInfo().then(function (info) {
      var template = _urlTemplate2.default.parse(info.builders_url);
      var url = template.expand({});

      return (0, _fetch2.default)(url, options);
    }).then(function (response) {
      return response.json();
    }).then(function (builders) {
      return Object.keys(builders).map(function (key) {
        var name = key;
        var builder = builders[key];

        return {
          name: name,
          url: endpoint + '/json/builders/' + name,
          html_url: endpoint + '/builders/' + name,
          builds_url: endpoint + '/json/builders/' + name + '/builds{/number}{?select*}',
          data: builder
        };
      });
    });
  }

  function getBuilds(builder) {
    var select = [-1].concat(builder.data.cachedBuilds);
    var template = _urlTemplate2.default.parse(builder.builds_url);
    var url = template.expand({ select: select });

    return (0, _fetch2.default)(url, options).then(function (response) {
      return response.json();
    }).then(function (builds) {
      var numbers = {};

      return Object.keys(builds).map(function (key) {
        return builds[key];
      }).filter(function (_ref2) {
        var number = _ref2.number;

        if (numbers[number]) return false;
        return numbers[number] = true;
      }).map(function (build) {
        var building = build.times[0] && !build.times[1];

        return {
          name: builder.name,
          number: build.number,
          url: endpoint + '/json/builders/' + builder.name + '/builds/' + build.number,
          html_url: endpoint + '/builders/' + builder.name + '/builds/' + build.number,
          state: building ? _constants.PENDING : BUILDBOT_STATE_LIST[build.results || 0] || _constants.UNKNOWN,
          start: new Date(build.times[0] * 1000),
          end: building ? null : new Date(build.times[1] * 1000),
          data: build
        };
      });
    });
  }

  return {
    getInfo: getInfo,
    getBuilders: getBuilders,
    getBuilds: getBuilds
  };
}
//# sourceMappingURL=data:application/json;base64,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Q0FBRSxlQXRGN0IsT0FBTyxBQXNGaUMsQUFBRTtBQUNwRixlQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUM7QUFDeEMsYUFBRyxFQUFFLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUM7QUFDeEQsY0FBSSxFQUFFLEtBQUs7U0FDWixDQUFDO09BQ0gsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDO0dBQ047O0FBRUQsU0FBTztBQUNMLFdBQU8sRUFBUCxPQUFPO0FBQ1AsZUFBVyxFQUFYLFdBQVc7QUFDWCxhQUFTLEVBQVQsU0FBUztHQUNWLENBQUM7Q0FDSCIsImZpbGUiOiJidWlsZGJvdC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmZXRjaCBmcm9tICcuL2ZldGNoJztcbmltcG9ydCB1cmx0ZW1wbGF0ZSBmcm9tICd1cmwtdGVtcGxhdGUnO1xuaW1wb3J0IHsgUEVORElORywgU1VDQ0VTUywgV0FSTklORywgRkFJTFVSRSwgRVJST1JFRCwgVU5LTk9XTiwgVVNFUl9BR0VOVCB9IGZyb20gJy4vY29uc3RhbnRzJztcblxuY29uc3QgQlVJTERCT1RfTUVESUFfVFlQRSA9ICdhcHBsaWNhdGlvbi9qc29uJztcbmNvbnN0IEJVSUxEQk9UX1NUQVRFX0xJU1QgPSBbXG4gIFNVQ0NFU1MsXG4gIFdBUk5JTkcsXG4gIEZBSUxVUkUsXG4gIFVOS05PV04sXG4gIEVSUk9SRUQsXG4gIEVSUk9SRURcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEJ1aWxkYm90KGVuZHBvaW50LCB7IGhlYWRlcnM6IGggfSA9IHt9KSB7XG4gIGNvbnN0IGhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAnQWNjZXB0JzogQlVJTERCT1RfTUVESUFfVFlQRSxcbiAgICAnVXNlci1BZ2VudCc6IFVTRVJfQUdFTlRcbiAgfSwgaCk7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgaGVhZGVyc1xuICB9O1xuXG4gIGZ1bmN0aW9uIGdldEluZm8oKSB7XG4gICAgcmV0dXJuIGZldGNoKGAke2VuZHBvaW50fS9qc29uYCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAocm9vdCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IHJvb3QucHJvamVjdC50aXRsZSxcbiAgICAgICAgICB1cmw6IGAke2VuZHBvaW50fS9qc29uYCxcbiAgICAgICAgICBodG1sX3VybDogZW5kcG9pbnQsXG4gICAgICAgICAgYnVpbGRlcnNfdXJsOiBgJHtlbmRwb2ludH0vanNvbi9idWlsZGVyc3svbmFtZX1gLFxuICAgICAgICAgIGJ1aWxkZXJzOiBPYmplY3Qua2V5cyhyb290LmJ1aWxkZXJzKSxcbiAgICAgICAgICBkYXRhOiByb290XG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ1aWxkZXJzKCkge1xuICAgIHJldHVybiBnZXRJbmZvKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdXJsdGVtcGxhdGUucGFyc2UoaW5mby5idWlsZGVyc191cmwpO1xuICAgICAgICBjb25zdCB1cmwgPSB0ZW1wbGF0ZS5leHBhbmQoe30pO1xuXG4gICAgICAgIHJldHVybiBmZXRjaCh1cmwsIG9wdGlvbnMpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGJ1aWxkZXJzKSB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhidWlsZGVycykubWFwKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICBjb25zdCBuYW1lID0ga2V5O1xuICAgICAgICAgIGNvbnN0IGJ1aWxkZXIgPSBidWlsZGVyc1sga2V5IF07XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIHVybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfWAsXG4gICAgICAgICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2J1aWxkZXJzLyR7bmFtZX1gLFxuICAgICAgICAgICAgYnVpbGRzX3VybDogYCR7ZW5kcG9pbnR9L2pzb24vYnVpbGRlcnMvJHtuYW1lfS9idWlsZHN7L251bWJlcn17P3NlbGVjdCp9YCxcbiAgICAgICAgICAgIGRhdGE6IGJ1aWxkZXJcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0QnVpbGRzKGJ1aWxkZXIpIHtcbiAgICBjb25zdCBzZWxlY3QgPSBbIC0xIF0uY29uY2F0KCBidWlsZGVyLmRhdGEuY2FjaGVkQnVpbGRzICk7XG4gICAgY29uc3QgdGVtcGxhdGUgPSB1cmx0ZW1wbGF0ZS5wYXJzZSggYnVpbGRlci5idWlsZHNfdXJsICk7XG4gICAgY29uc3QgdXJsID0gdGVtcGxhdGUuZXhwYW5kKHsgc2VsZWN0IH0pO1xuXG4gICAgcmV0dXJuIGZldGNoKHVybCwgb3B0aW9ucylcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAoYnVpbGRzKSB7XG4gICAgICAgIGNvbnN0IG51bWJlcnMgPSB7fTtcblxuICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoYnVpbGRzKS5tYXAoZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAgIHJldHVybiBidWlsZHNbIGtleSBdO1xuICAgICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKHsgbnVtYmVyIH0pIHtcbiAgICAgICAgICBpZiAobnVtYmVyc1sgbnVtYmVyIF0pIHJldHVybiBmYWxzZTtcbiAgICAgICAgICByZXR1cm4gbnVtYmVyc1sgbnVtYmVyIF0gPSB0cnVlO1xuICAgICAgICB9KS5tYXAoZnVuY3Rpb24gKGJ1aWxkKSB7XG4gICAgICAgICAgY29uc3QgYnVpbGRpbmcgPSBidWlsZC50aW1lc1sgMCBdICYmICFidWlsZC50aW1lc1sgMSBdO1xuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG5hbWU6IGJ1aWxkZXIubmFtZSxcbiAgICAgICAgICAgIG51bWJlcjogYnVpbGQubnVtYmVyLFxuICAgICAgICAgICAgdXJsOiBgJHtlbmRwb2ludH0vanNvbi9idWlsZGVycy8ke2J1aWxkZXIubmFtZX0vYnVpbGRzLyR7YnVpbGQubnVtYmVyfWAsXG4gICAgICAgICAgICBodG1sX3VybDogYCR7ZW5kcG9pbnR9L2J1aWxkZXJzLyR7YnVpbGRlci5uYW1lfS9idWlsZHMvJHtidWlsZC5udW1iZXJ9YCxcbiAgICAgICAgICAgIHN0YXRlOiBidWlsZGluZyA/IFBFTkRJTkcgOiAoIEJVSUxEQk9UX1NUQVRFX0xJU1RbIGJ1aWxkLnJlc3VsdHMgfHwgMCBdIHx8IFVOS05PV04gKSxcbiAgICAgICAgICAgIHN0YXJ0OiBuZXcgRGF0ZShidWlsZC50aW1lc1sgMCBdICogMTAwMCksXG4gICAgICAgICAgICBlbmQ6IGJ1aWxkaW5nID8gbnVsbCA6IG5ldyBEYXRlKGJ1aWxkLnRpbWVzWyAxIF0gKiAxMDAwKSxcbiAgICAgICAgICAgIGRhdGE6IGJ1aWxkXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2V0SW5mbyxcbiAgICBnZXRCdWlsZGVycyxcbiAgICBnZXRCdWlsZHNcbiAgfTtcbn1cbiJdfQ==